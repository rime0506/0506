# 联机亲属卡功能说明

## 功能简介
联机亲属卡功能允许联机好友之间互相赠送亲属卡，并使用亲属卡进行消费。当使用亲属卡时，付款方会收到流水通知。

## 功能实现

### 1. 赠送亲属卡
当AI角色发送 `((FAMILY_CARD: 额度))` 指令时：
- **本地角色**：在本地数据库保存亲属卡信息
- **联机好友**：通过服务器发送亲属卡，对方会收到实时通知

示例：
```
这是给你的零花钱|||((FAMILY_CARD: 500))
```
- 前面的文字会作为消息发送
- 亲属卡额度为500元/月（0表示不限额度）

### 2. 使用亲属卡支付
当需要付费时（如发送短信），系统会弹出支付方式选择：
- **余额支付**：使用自己的零钱余额
- **亲属卡支付**：使用收到的亲属卡额度

支付方式选择窗口会显示：
- 零钱余额
- 所有可用的亲属卡（包括本地和联机）
- 每张卡的剩余额度

### 3. 流水记录
- **付款方**：收到通知，显示使用者昵称、金额、本月已用额度
- **使用方**：支付成功提示

### 4. 服务器端实现
服务器维护3张表：
- `family_cards`: 亲属卡基本信息（赠送人、接收人、额度等）
- `family_card_records`: 消费记录
- 自动月度重置使用额度

## 使用流程

### 场景示例：A 赠送亲属卡给 B

1. **A 赠送亲属卡**
   - A 的角色发送：`宝贝，这是给你的零花钱|||((FAMILY_CARD: 1000))`
   - B 收到亲属卡通知和聊天消息

2. **B 使用亲属卡**
   - B 发送短信时，弹出支付选择窗口
   - B 选择使用 A 的亲属卡
   - 支付成功

3. **A 收到通知**
   - A 看到流水：`[好友昵称] 使用了您的亲属卡 ¥0.10`
   - 显示本月已用额度

## 技术要点

### 客户端（script.JS）
1. 检测亲属卡指令，判断是本地角色还是联机好友
2. 联机好友通过 WebSocket 发送 `send_family_card` 消息
3. 支付时调用 `showPaymentMethodSelection()` 显示支付方式选择
4. 使用亲属卡时发送 `use_family_card` 消息到服务器

### 服务器端（server.js）
1. `handleSendFamilyCard()`: 创建亲属卡记录
2. `handleUseFamilyCard()`: 扣除额度，添加消费记录
3. `handleGetFamilyCards()`: 获取我赠送/收到的亲属卡列表
4. 自动月度重置使用额度

### 数据库表结构
```sql
-- 亲属卡表
family_cards (
  id, from_wx_account, to_wx_account, 
  monthly_limit, used_this_month, 
  created_at, last_reset_month, status
)

-- 消费记录表
family_card_records (
  id, card_id, from_wx_account, to_wx_account,
  amount, description, created_at
)
```

## 测试步骤

1. **启动服务器**
   ```bash
   cd server
   node server.js
   ```

2. **创建两个用户账号**
   - 用户A：注册并上线一个角色
   - 用户B：注册并上线一个角色

3. **添加为好友**
   - 用户A 搜索用户B的微信号
   - 发送好友申请
   - 用户B 接受申请

4. **赠送亲属卡**
   - 用户A 让角色发送：`((FAMILY_CARD: 100))`
   - 用户B 查看聊天，应该看到亲属卡消息

5. **使用亲属卡**
   - 用户B 尝试发送短信（需要扣费）
   - 在支付选择中选择亲属卡
   - 用户A 应该收到使用通知

## 注意事项

1. 亲属卡只能在联机状态下使用
2. 每月额度会自动重置
3. 本地亲属卡（非联机）的数据只保存在本地
4. 联机亲属卡的数据同步通过服务器维护

