<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Ins风桌面</title>
    
    <!-- PWA 配置 (Manifest 生成逻辑在 script.JS 中) -->
    <link rel="manifest" id="manifest-link">
    
    <!-- iOS 全屏支持 -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ins桌面">
    
    <!-- iOS 图标 -->
    <link rel="apple-touch-icon" href="https://img.heliar.top/file/1769158422909_无标题281_20251207015501_20260123165317.png">
    
    <!-- 引入外部样式表 -->
    <link rel="stylesheet" href="style.css">
    
    <!-- Font Awesome 图标库 -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    
    <!-- 注意：内嵌的 style 标签已删除，样式已移至 style.css -->
    <!-- 如需保留内嵌样式作为备用，可以取消下面的注释 -->
 
    <script src="https://cdn.jsdelivr.net/npm/dexie@3.2.4/dist/dexie.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- 纯前端模式：不需要 Socket.IO，已移除 -->
    <!-- SortableJS 用于拖拽排序 -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
</head>
<body id="desktop-body">
    <div class="phone" id="home-page">
        <!-- 顶部磨砂小组件 -->
        <div class="top-widget" onclick="showNotificationCenter()">
            <div class="icon" id="widget-icon"></div>
            <div class="text" id="widget-text">
                <div class="title" id="widget-title">{`{ lovely Day ¸.*・~ ★`}</div>
                <div class="subtext" id="widget-subtext">世界破破烂烂小猫缝缝补补 🐾</div>
            </div>
            <!-- 通知红点 -->
            <div class="notification-badge" id="notif-badge"></div>
        </div>

        <!-- 应用网格 -->
        <div class="app-container">
            <div class="grid" id="app-grid">
                <!-- 拍立得组件 -->
                <div class="photo-widget" id="widget-photo">
                    <div class="photo-item right" onclick="document.getElementById('upload-right').click()">
                        <div class="tape"></div>
                        <div class="img-box" id="img-right"></div>
                        <input type="file" id="upload-right" class="photo-input" accept="image/*" onchange="setPhoto('right', this)">
                    </div>
                    <div class="photo-item left" onclick="document.getElementById('upload-left').click()">
                        <div class="img-box" id="img-left"></div>
                        <input type="file" id="upload-left" class="photo-input" accept="image/*" onchange="setPhoto('left', this)">
                    </div>
                </div>

                <!-- 应用图标 -->
                <div class="app-icon" id="icon-appstore" onclick="showAppStorePage()">
                    <div class="icon"></div>
                    <div class="name">App Store</div>
                </div>
                <div class="app-icon" id="icon-notes" onclick="showWechatPage()">
                    <div class="icon"></div>
                    <div class="name">wechat</div>
                </div>
                <div class="app-icon" id="icon-remind" onclick="showCharacterPage()">
                    <div class="icon"></div>
                    <div class="name">角色档案</div>
                </div>
                <div class="app-icon" id="icon-facetime" onclick="showLorebookPage()">
                    <div class="icon"></div>
                    <div class="name">世界书</div>
                </div>
                <div class="app-icon" id="icon-calendar" style="display:none;">
                    <div class="icon"></div>
                    <div class="name">日历</div>
                </div>
                <!-- 情侣组件 (头像 + 倒数日) -->
                <div class="couple-widget" id="widget-couple">
                    <div class="avatars-row">
                        <div class="circle-photo" id="app-avatar-1" onclick="document.getElementById('avatar1-input').click()">
                            <div class="bubble" id="avatar-bubble1">> .. <</div>
                            <div class="img" id="avatar-img-1"></div>
                            <div class="name" id="avatar-name1">> .. <</div>
                            <input type="file" id="avatar1-input" class="custom-input" accept="image/*" onchange="setAvatar('1', this)">
                        </div>
                        <div class="circle-photo" id="app-avatar-2" onclick="document.getElementById('avatar2-input').click()">
                            <div class="bubble" id="avatar-bubble2">gw..♡</div>
                            <div class="img" id="avatar-img-2"></div>
                            <div class="name" id="avatar-name2">gw..♡</div>
                            <input type="file" id="avatar2-input" class="custom-input" accept="image/*" onchange="setAvatar('2', this)">
                        </div>
                    </div>
                    <!-- 倒数日胶囊 -->
                    <div class="days-capsule" id="widget-days">
                        <div class="capsule" onclick="document.getElementById('days-input').click()">
                            <svg class="svg-icon" style="width:14px;height:14px;vertical-align:-2px;margin-right:2px;fill:var(--ins-pink);stroke:none;" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg>
                            <span id="days-text">446 days</span>
                        </div>
                    </div>
                </div>

                <div class="app-icon" id="icon-photo" onclick="showMusicAppPage()" style="display:none;">
                    <div class="icon"></div>
                    <div class="name">网易云</div>
                </div>
                <div class="app-icon" id="icon-camera" onclick="showCoupleSpacePage()">
                    <div class="icon"></div>
                    <div class="name">情侣空间</div>
                </div>
                <div class="app-icon" id="icon-cabin" onclick="showCabinPage()">
                    <div class="icon"></div>
                    <div class="name">小屋</div>
                </div>
            </div>
        </div>

        <!-- 底部Dock栏 -->
        <div class="dock">
            <div class="dock-icon" id="dock-setting" onclick="showSettingPage()">
                <div class="icon"></div>
                <div class="name">设置</div>
            </div>
            <div class="dock-icon" id="dock-custom" onclick="showCustomPage()">
                <div class="icon"></div>
                <div class="name">个性化</div>
            </div>
            <div class="dock-icon" id="dock-message" onclick="showMessagePage()">
                <div class="icon"></div>
                <div class="name">信息</div>
            </div>
            <div class="dock-icon" id="dock-phone" onclick="showPhonePage()">
                <div class="icon"></div>
                <div class="name">电话</div>
            </div>
        </div>
    </div>

    <!-- 表情包管理页面 -->
    <div class="custom-page" id="sticker-page" style="display:none;">
        <!-- 分类列表视图 -->
        <div id="sticker-list-view">
            <div class="custom-page-header">
                <div class="back-btn" onclick="hideStickerPage()">
                    <svg class="svg-icon" style="width:20px;height:20px;" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </div>
                <div class="custom-page-title">我的表情包</div>
                <div class="save-btn" onclick="showCreateCategoryModal()" style="opacity:1; font-size:14px;">新建</div>
            </div>
            <!-- 分类列表内容 -->
            <div id="sticker-category-list" class="sticker-content" style="padding:16px;">
                <!-- 动态生成 -->
            </div>
        </div>

        <!-- 分类详情视图 -->
        <div id="sticker-detail-view" style="display:none;">
            <div class="custom-page-header">
                <div class="back-btn" onclick="backToStickerList()">
                    <svg class="svg-icon" style="width:20px;height:20px;" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
                </div>
                <div class="custom-page-title" id="sticker-detail-title">表情包详情</div>
                <div class="save-btn" style="opacity:0">保存</div>
            </div>
            <!-- 详情内容区域 -->
            <div id="sticker-detail-content" class="sticker-content">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 个性化设置页面 - 纯折叠展开式 -->
    <div class="custom-page" id="custom-main-page">
        <div class="custom-page-header">
            <div class="back-btn" onclick="backHomePage()">←</div>
            <div class="custom-page-title">个性化设置</div>
            <div class="save-btn" onclick="saveAllSetting()">保存设置</div>
        </div>

        <!-- 折叠项1：更换桌面壁纸 -->
        <div class="custom-item" onclick="toggleExpand('expand1')">
            <div class="custom-item-text">更换桌面壁纸</div>
            <div class="custom-item-arrow" id="arrow1">→</div>
        </div>
        <div class="custom-expand" id="expand1">
            <div class="custom-item" onclick="document.getElementById('wallpaper-input').click()">
                <div class="custom-item-text">选择壁纸图片</div>
                <div class="custom-item-arrow">→</div>
            </div>
            <div class="wallpaper-preview" id="wallpaper-preview">壁纸预览</div>
        </div>

        <!-- 折叠项2：自定义应用/Dock图标 -->
        <div class="custom-item" onclick="toggleExpand('expand2')">
            <div class="custom-item-text">自定义应用/Dock图标</div>
            <div class="custom-item-arrow" id="arrow2">→</div>
        </div>
        <div class="custom-expand" id="expand2">
            <div class="custom-edit-tip">点击图标选择图片替换</div>
            <div class="icon-select-list">
                <div class="icon-select-item" onclick="selectIcon('setting')">
                    <div class="icon"></div>
                    <div class="name">设置</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('notes')">
                    <div class="icon"></div>
                    <div class="name">备忘录</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('remind')">
                    <div class="icon"></div>
                    <div class="name">提醒事项</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('facetime')">
                    <div class="icon"></div>
                    <div class="name">FaceTime</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('calendar')" style="display:none;">
                    <div class="icon"></div>
                    <div class="name">日历</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('photo')">
                    <div class="icon"></div>
                    <div class="name">网易云</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('camera')">
                    <div class="icon"></div>
                    <div class="name">情侣空间</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('phone')">
                    <div class="icon"></div>
                    <div class="name">电话</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('message')">
                    <div class="icon"></div>
                    <div class="name">信息</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('browser')">
                    <div class="icon"></div>
                    <div class="name">浏览器</div>
                </div>
                <div class="icon-select-item" onclick="selectIcon('phone')">
                    <div class="icon"></div>
                    <div class="name">电话</div>
                </div>
            </div>
        </div>

        <!-- 折叠项3：修改顶部小组件 -->
        <div class="custom-item" onclick="toggleExpand('expand3')">
            <div class="custom-item-text">修改顶部小组件</div>
            <div class="custom-item-arrow" id="arrow3">→</div>
        </div>
        <div class="custom-expand" id="expand3">
            <div class="custom-item" onclick="document.getElementById('widget-icon-input').click()">
                <div class="custom-item-text">更换小组件图标</div>
                <div class="custom-item-arrow">→</div>
            </div>
            <div class="custom-preview-box">
                <div class="custom-preview-widget" id="widget-icon-preview"></div>
                <div>小组件图标预览</div>
            </div>
            <div class="custom-edit-tip">修改小组件文字</div>
            <input type="text" class="custom-edit-input" id="widget-title-input" placeholder="输入主标题（如：Lovely Day）">
            <input type="text" class="custom-edit-input" id="widget-subtext-input" placeholder="输入副标题（如：平安喜乐）">
        </div>

        <!-- 折叠项4：修改拍立得图片 -->
        <div class="custom-item" onclick="toggleExpand('expand4')">
            <div class="custom-item-text">修改拍立得图片</div>
            <div class="custom-item-arrow" id="arrow4">→</div>
        </div>
        <div class="custom-expand" id="expand4">
            <div class="custom-item" onclick="document.getElementById('photo-left-input').click()">
                <div class="custom-item-text">更换左侧拍立得</div>
                <div class="custom-item-arrow">→</div>
            </div>
            <div class="custom-item" onclick="document.getElementById('photo-right-input').click()">
                <div class="custom-item-text">更换右侧拍立得</div>
                <div class="custom-item-arrow">→</div>
            </div>
            <div class="custom-preview-box">
                <div class="custom-preview-photo" id="photo-left-preview"></div>
                <div class="custom-preview-photo" id="photo-right-preview"></div>
                <div>拍立得预览</div>
            </div>
        </div>

        <!-- 折叠项5：修改头像/昵称/气泡 -->
        <div class="custom-item" onclick="toggleExpand('expand5')">
            <div class="custom-item-text">修改头像/昵称/气泡</div>
            <div class="custom-item-arrow" id="arrow5">→</div>
        </div>
        <div class="custom-expand" id="expand5">
            <div class="custom-item" onclick="document.getElementById('avatar1-input').click()">
                <div class="custom-item-text">更换头像1</div>
                <div class="custom-item-arrow">→</div>
            </div>
            <div class="custom-item" onclick="document.getElementById('avatar2-input').click()">
                <div class="custom-item-text">更换头像2</div>
                <div class="custom-item-arrow">→</div>
            </div>
            <div class="custom-preview-box">
                <div class="custom-preview-avatar" id="avatar1-preview"></div>
                <div class="custom-preview-avatar" id="avatar2-preview"></div>
                <div>头像预览</div>
            </div>
            <div class="custom-edit-tip">头像1 气泡/昵称</div>
            <input type="text" class="custom-edit-input" id="avatar1-bubble-input" placeholder="气泡文字（如：> .. <）">
            <input type="text" class="custom-edit-input" id="avatar1-name-input" placeholder="昵称文字">
            <div class="custom-edit-tip">头像2 气泡/昵称</div>
            <input type="text" class="custom-edit-input" id="avatar2-bubble-input" placeholder="气泡文字（如：gw..♡）">
            <input type="text" class="custom-edit-input" id="avatar2-name-input" placeholder="昵称文字">
        </div>

        <!-- 折叠项6：修改倒数日文字 -->
        <div class="custom-item" onclick="toggleExpand('expand6')">
            <div class="custom-item-text">修改倒数日文字</div>
            <div class="custom-item-arrow" id="arrow6">→</div>
        </div>
        <div class="custom-expand" id="expand6">
            <div class="custom-edit-tip">输入想要显示的倒数日内容</div>
            <input type="text" class="custom-edit-input" id="days-input" placeholder="如：在一起 520 天、倒计时 100 天">
        </div>

        <!-- 折叠项7：修改椭圆形颜色 -->
        <div class="custom-item" onclick="toggleExpand('expand7')">
            <div class="custom-item-text">修改椭圆形颜色</div>
            <div class="custom-item-arrow" id="arrow7">→</div>
        </div>
        <div class="custom-expand" id="expand7">
            <div class="custom-edit-tip">倒数日胶囊背景色</div>
            <input type="color" class="custom-edit-input" id="capsule-color-input" value="#FFF7FA" style="height: 50px; cursor: pointer;">
            <div class="custom-edit-tip" style="margin-top: 16px;">头像气泡背景色</div>
            <input type="color" class="custom-edit-input" id="bubble-color-input" value="#FFF7FA" style="height: 50px; cursor: pointer;">
        </div>

        <!-- 折叠项8：全局字体设置 -->
        <div class="custom-item" onclick="toggleExpand('expand8')">
            <div class="custom-item-text">全局字体设置</div>
            <div class="custom-item-arrow" id="arrow8">→</div>
        </div>
        <div class="custom-expand" id="expand8">
            <div class="custom-edit-tip">粘贴在线字体链接（如 Google Fonts）</div>
            <input type="text" class="custom-edit-input" id="custom-font-input" placeholder="如：https://fonts.googleapis.com/css2?family=...">
            <div class="custom-edit-tip" style="margin-top: 12px;">输入字体名称（family name）</div>
            <input type="text" class="custom-edit-input" id="custom-font-name-input" placeholder="如：Noto Sans SC、Ma Shan Zheng">
            <div class="custom-item" onclick="previewCustomFont()" style="margin-top: 12px; background: #FFF7FA;">
                <div class="custom-item-text">预览字体效果</div>
                <div class="custom-item-arrow">👁</div>
            </div>
            <div class="font-preview-box" id="font-preview-box">
                <div class="font-preview-text" id="font-preview-text">这是字体预览效果 ABC 123</div>
            </div>
            <div class="custom-item" onclick="clearCustomFont()" style="margin-top: 8px; background: #fff0f0;">
                <div class="custom-item-text" style="color: #e57373;">恢复默认字体</div>
                <div class="custom-item-arrow" style="color: #e57373;">↺</div>
            </div>
        </div>
    </div>

    <!-- 系统设置页面 -->
    <div class="setting-page" id="setting-page">
        <div class="setting-header">
            <div class="back-btn" onclick="hideSettingPage()" style="margin:0; background:none; width:50px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="setting-title">设置</div>
            <div style="width:50px;"></div>
        </div>
        
        <div class="setting-content">
            <div class="setting-group-title">系统通知</div>
            <div class="setting-group">
                <div class="setting-item" onclick="document.getElementById('notif-switch').click()">
                    <div class="setting-item-text">开启通知</div>
                    <label class="ios-switch" onclick="event.stopPropagation()">
                        <input type="checkbox" id="notif-switch" onchange="toggleNotification(this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item" onclick="testNotification()">
                    <div class="setting-item-text">测试通知</div>
                    <div style="color: #999; font-size: 12px;">点击发送测试通知</div>
                </div>
                <div class="setting-item" onclick="manualSubscribePush()">
                    <div class="setting-item-text">手动开启推送</div>
                    <div style="color: #999; font-size: 12px;">点击触发推送订阅</div>
                    <div class="setting-arrow">›</div>
                </div>
                <div class="setting-item" onclick="document.getElementById('debug-switch').click()">
                    <div class="setting-item-text">调试模式</div>
                    <div style="color: #999; font-size: 12px;">显示通知调试信息</div>
                    <label class="ios-switch" onclick="event.stopPropagation()">
                        <input type="checkbox" id="debug-switch" onchange="toggleDebugMode(this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item" onclick="document.getElementById('keepalive-switch').click()">
                    <div class="setting-item-text">强力保活</div>
                    <div style="color: #999; font-size: 12px;">后台播放静音音频保持活跃</div>
                    <label class="ios-switch" onclick="event.stopPropagation()">
                        <input type="checkbox" id="keepalive-switch" onchange="toggleKeepAlive(this)">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="setting-item" onclick="showDiagnosticPanel()">
                    <div class="setting-item-text">🔍 诊断面板</div>
                    <div style="color: #999; font-size: 12px;">查看 user_id 和订阅状态</div>
                    <div class="setting-arrow">›</div>
                </div>
            </div>

            <!-- API 设置 折叠卡片 -->
            <div class="api-setting-card">
                <div class="api-header" onclick="toggleApiSetting()">
                    <div class="api-title">🔌 API 设置</div>
                    <div class="api-arrow" id="api-setting-arrow">▼</div>
                </div>
                <div class="api-body" id="api-setting-body">
                    
                    <!-- API 预设选择 -->
                    <div class="api-label">API 预设</div>
                    <div style="display:flex; gap:8px; margin-bottom:16px;">
                        <select class="api-input" id="api-preset-select" onchange="loadApiPreset(this.value)" style="flex:1;">
                            <option value="">-- 选择预设 --</option>
                        </select>
                        <button onclick="saveApiPreset()" style="padding:8px 12px; background:var(--ins-pink); color:#fff; border:none; border-radius:8px; font-size:12px; white-space:nowrap; cursor:pointer;">保存预设</button>
                        <button onclick="deleteApiPreset()" style="padding:8px 12px; background:#f0f0f0; color:#666; border:none; border-radius:8px; font-size:12px; white-space:nowrap; cursor:pointer;">删除</button>
                    </div>
                    
                    <div class="api-label">反代地址</div>
                    <div class="api-input-group">
                        <input type="text" class="api-input" id="ai-url-input" placeholder="https://api.openai.com (无需 /v1)" onchange="autoSaveApi()">
                    </div>

                    <div class="api-label">API 密钥</div>
                    <div class="api-input-group">
                        <input type="password" class="api-input" id="ai-key-input" placeholder="sk-..." onchange="autoSaveApi()">
                        <div class="eye-icon" onclick="toggleKeyVis()">显示</div>
                    </div>

                    <div class="api-label">模型选择</div>
                    <div class="model-row">
                        <div class="model-select-wrapper">
                            <select class="model-select" id="ai-model-select" onchange="autoSaveApi()">
                                <option value="" disabled selected>请拉取</option>
                            </select>
                        </div>
                        <button class="fetch-btn" onclick="fetchModels()">
                            <div class="loading-spinner" id="fetch-spinner"></div>
                            <span id="fetch-text">拉取模型</span>
                        </button>
                    </div>

                    <div class="temp-header">
                        <div class="api-label" style="margin:0;">API 温度 (Temperature)</div>
                        <div class="temp-val" id="temp-val-display">0.7</div>
                    </div>
                    <div class="slider-container">
                        <input type="range" min="0" max="2" step="0.1" value="0.7" class="temp-slider" id="ai-temp-slider" oninput="updateTempDisplay(this.value)" onchange="autoSaveApi()">
                        <div class="temp-labels">
                            <span>0 (保守)</span>
                            <span>0.8</span>
                            <span>2 (创意)</span>
                        </div>
                    </div>

                    <button class="test-btn" onclick="testConnection()">
                        <span id="test-btn-text">测试连接</span>
                    </button>
                </div>
            </div>

            <!-- NovelAI 图片生成设置 折叠卡片 -->
            <div class="api-setting-card">
                <div class="api-header" onclick="toggleNovelAISettings()">
                    <div class="api-title">🎨 NovelAI 图片生成</div>
                    <div class="api-arrow" id="novelai-setting-arrow">▼</div>
                </div>
                <div class="api-body" id="novelai-setting-body" style="display: none;">
                    
                    <!-- NovelAI API设置 -->
                    <div class="api-label">NovelAI API Key</div>
                    <div class="api-input-group">
                        <input type="password" class="api-input" id="novelai-api-key" placeholder="输入 NovelAI API Key" onchange="autoSaveNovelAI()">
                        <div class="eye-icon" onclick="toggleNovelAIKeyVis()">显示</div>
                    </div>
                    <div style="font-size: 11px; color: #999; margin-top: 4px; padding: 0 4px;">
                        提示：从 NovelAI 官网获取 API Key
                    </div>

                    <div class="api-label">代理 URL（可选）</div>
                    <div class="api-input-group">
                        <input type="text" class="api-input" id="novelai-proxy-url" placeholder="https://image.novelai.net/ai/generate-image" value="https://image.novelai.net/ai/generate-image" onchange="autoSaveNovelAI()">
                    </div>
                    <div style="font-size: 11px; color: #999; margin-top: 4px; padding: 0 4px;">
                        提示：用于解决 CORS 问题，留空则使用默认地址
                    </div>

                    <button class="test-btn" onclick="testNovelAIConnection()" style="margin-top: 10px;">
                        <span id="test-novelai-btn-text">测试 NovelAI 连接</span>
                    </button>
                    <div id="novelai-test-result" style="margin-top: 12px; font-size: 12px; min-height: 20px; line-height: 1.5; color: #999;"></div>

                    <!-- 生成参数设置 -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <div class="api-label">模型版本</div>
                        <div class="api-input-group">
                            <select class="api-input" id="novelai-model" onchange="autoSaveNovelAI()" style="padding: 12px;">
                                <option value="nai-diffusion-4-5-full" selected>nai-diffusion-4-5-full（V4.5 推荐）</option>
                                <option value="nai-diffusion-4-full">nai-diffusion-4-full（V4）</option>
                                <option value="nai-diffusion-3-inpainting">nai-diffusion-3-inpainting（V3）</option>
                                <option value="nai-diffusion-3">nai-diffusion-3（V3）</option>
                            </select>
                        </div>

                        <div class="api-label">采样步数 (Steps)</div>
                        <div class="api-input-group">
                            <input type="number" class="api-input" id="novelai-steps" min="1" max="50" value="28" oninput="updateNovelAIStepsDisplay(this.value)" onchange="autoSaveNovelAI()">
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #999; margin-top: 5px; padding: 0 4px;">
                            <span>1</span>
                            <span id="novelai-steps-value" style="color: var(--deep-pink); font-weight: 500;">28</span>
                            <span>50</span>
                        </div>

                        <div class="api-label">引导强度 (Scale)</div>
                        <div class="api-input-group">
                            <input type="number" class="api-input" id="novelai-scale" min="1" max="30" step="0.5" value="11" oninput="updateNovelAIScaleDisplay(this.value)" onchange="autoSaveNovelAI()">
                        </div>
                        <div style="display: flex; justify-content: space-between; font-size: 12px; color: #999; margin-top: 5px; padding: 0 4px;">
                            <span>1</span>
                            <span id="novelai-scale-value" style="color: var(--deep-pink); font-weight: 500;">11</span>
                            <span>30</span>
                        </div>

                        <div class="api-label">采样器 (Sampler)</div>
                        <div class="api-input-group">
                            <select class="api-input" id="novelai-sampler" onchange="autoSaveNovelAI()" style="padding: 12px;">
                                <option value="k_euler_ancestral" selected>k_euler_ancestral（推荐）</option>
                                <option value="k_euler">k_euler</option>
                                <option value="k_lms">k_lms</option>
                                <option value="plms">plms</option>
                                <option value="ddim">ddim</option>
                            </select>
                        </div>

                        <div class="api-label">图像尺寸</div>
                        <div class="api-input-group">
                            <select class="api-input" id="novelai-size" onchange="autoSaveNovelAI()" style="padding: 12px;">
                                <option value="832x1216" selected>832x1216（竖版）</option>
                                <option value="1216x832">1216x832（横版）</option>
                                <option value="1024x1024">1024x1024（方形）</option>
                                <option value="832x832">832x832（小方形）</option>
                            </select>
                        </div>
                    </div>

                    <!-- Prompt 设置 -->
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <div class="api-label">系统基础 Prompt</div>
                        <div class="api-input-group">
                            <textarea class="api-input" id="novelai-system-prompt" placeholder="输入系统基础 Prompt（风格、质量、通用约束）" rows="3" onchange="autoSaveNovelAI()" style="resize: vertical; min-height: 80px;">masterpiece, best quality, highres, 1girl, solo, anime style, detailed, beautiful, cute</textarea>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-top: 4px; padding: 0 4px;">
                            提示：将自动添加到所有生成请求的开头
                        </div>

                        <div class="api-label">Negative Prompt</div>
                        <div class="api-input-group">
                            <textarea class="api-input" id="novelai-negative-prompt" placeholder="输入负面 Prompt" rows="2" onchange="autoSaveNovelAI()" style="resize: vertical; min-height: 60px;">lowres, bad anatomy, bad hands, text, error, missing fingers, extra digit, fewer digits, cropped, worst quality, low quality, normal quality, jpeg artifacts, signature, watermark, username, blurry</textarea>
                        </div>
                        <div style="font-size: 11px; color: #999; margin-top: 4px; padding: 0 4px;">
                            提示：用于排除不希望出现的元素
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 联机设置 折叠卡片 -->
            <div class="api-setting-card">
                <div class="api-header" onclick="toggleOnlineSettings()">
                    <div class="api-title">🌐 联机设置</div>
                    <div class="api-arrow" id="online-setting-arrow">▼</div>
                </div>
                <div class="api-body" id="online-setting-body" style="display: none;">
                    
                    <!-- 服务器地址 -->
                    <div class="api-label">服务器地址</div>
                    <div class="api-input-group">
                        <input type="text" class="api-input" id="online-server-url" placeholder="wss://your-server.com 或 ws://localhost:3000" onchange="saveOnlineSettings()">
                    </div>
                    <div style="font-size: 11px; color: #999; margin-top: 4px; padding: 0 4px;">
                        填写自部署的后端服务器WebSocket地址
                    </div>
                    
                    <div style="display:flex; gap:8px; margin-top:12px;">
                        <button class="test-btn" onclick="testOnlineConnection()" style="flex:1;">
                            <span id="test-online-btn-text">测试连接</span>
                        </button>
                    </div>
                    <div id="online-connection-status" style="margin-top:8px; font-size:12px; color:#999; text-align:center;"></div>
                    
                    <!-- 分割线 -->
                    <div style="height:1px; background:#e0e0e0; margin:20px 0;"></div>
                    
                    <!-- 账号状态 -->
                    <div class="api-label">账号状态</div>
                    <div id="online-account-status" style="padding:12px; background:#f5f5f5; border-radius:8px; margin-bottom:12px;">
                        <div style="display:flex; align-items:center; gap:8px;">
                            <div id="online-status-dot" style="width:8px; height:8px; border-radius:50%; background:#ccc;"></div>
                            <span id="online-status-text" style="font-size:14px; color:#666;">未连接</span>
                        </div>
                        <div id="online-user-info" style="display:none; margin-top:8px; font-size:13px; color:#333;">
                            用户名：<span id="online-username-display">-</span>
                        </div>
                    </div>
                    
                    <!-- 登录/注册按钮 -->
                    <div id="online-auth-buttons" style="display:flex; gap:10px;">
                        <button onclick="showOnlineLoginModal()" style="flex:1; padding:12px; background:var(--ins-pink); color:#fff; border:none; border-radius:8px; font-size:14px; cursor:pointer;">登录</button>
                        <button onclick="showOnlineRegisterModal()" style="flex:1; padding:12px; background:#f0f0f0; color:#333; border:none; border-radius:8px; font-size:14px; cursor:pointer;">注册</button>
                    </div>
                    
                    <!-- 已登录时显示 -->
                    <div id="online-logged-in-actions" style="display:none;">
                        <button onclick="onlineLogout()" style="width:100%; padding:12px; background:#f0f0f0; color:#ff3b30; border:none; border-radius:8px; font-size:14px; cursor:pointer;">退出登录</button>
                    </div>
                    
                    <!-- 分割线 -->
                    <div style="height:1px; background:#e0e0e0; margin:20px 0;"></div>
                    
                    <!-- 使用说明 -->
                    <div style="padding:12px; background:#fff5f7; border-radius:8px; font-size:12px; color:#666; line-height:1.6;">
                        <div style="font-weight:600; color:#333; margin-bottom:6px;">📖 使用说明</div>
                        <div>1. 自己或朋友部署后端服务器</div>
                        <div>2. 填入服务器地址并测试连接</div>
                        <div>3. 注册/登录主账号</div>
                        <div>4. 在「微信-我」页面上线你的User角色</div>
                        <div>5. 通过虚拟微信号搜索添加联机好友</div>
                    </div>
                </div>
            </div>
            
            <!-- 数据管理 -->
            <div class="setting-group-title">数据管理</div>
            <div class="setting-group">
                <div class="setting-item" onclick="exportAllData()">
                    <div class="setting-item-text">导出数据</div>
                    <div style="color: #999; font-size: 12px;">导出所有数据为JSON文件</div>
                    <div class="setting-arrow">›</div>
                </div>
                <div class="setting-item" onclick="document.getElementById('import-data-input').click()">
                    <div class="setting-item-text">导入数据</div>
                    <div style="color: #999; font-size: 12px;">从JSON文件恢复数据</div>
                    <div class="setting-arrow">›</div>
                </div>
                <div class="setting-item" onclick="clearAllDataConfirm()">
                    <div class="setting-item-text" style="color: #ff3b30;">清空所有数据</div>
                    <div style="color: #999; font-size: 12px;">谨慎操作，不可恢复</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 隐藏的数据导入文件选择器 -->
    <input type="file" id="import-data-input" style="display:none;" accept=".json" onchange="importAllData(this)">

    <!-- 联机登录弹窗 -->
    <div class="modal-overlay" id="online-login-modal" style="display:none;">
        <div class="modal-box" style="max-width:340px;">
            <div class="modal-title">🔐 联机登录</div>
            <div style="margin-bottom:16px;">
                <label style="font-size:13px; color:#666; display:block; margin-bottom:6px;">用户名或邮箱</label>
                <input type="text" class="modal-input" id="online-login-username" placeholder="输入用户名或邮箱">
            </div>
            <div style="margin-bottom:20px;">
                <label style="font-size:13px; color:#666; display:block; margin-bottom:6px;">密码</label>
                <input type="password" class="modal-input" id="online-login-password" placeholder="输入密码">
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal('online-login-modal')">取消</button>
                <button class="modal-btn btn-confirm" onclick="doOnlineLogin()">登录</button>
            </div>
            <div style="text-align:center; margin-top:12px;">
                <span style="font-size:12px; color:#999;">还没有账号？</span>
                <span style="font-size:12px; color:var(--ins-pink); cursor:pointer;" onclick="closeModal('online-login-modal');showOnlineRegisterModal();">立即注册</span>
            </div>
        </div>
    </div>

    <!-- 联机注册弹窗 -->
    <div class="modal-overlay" id="online-register-modal" style="display:none;">
        <div class="modal-box" style="max-width:340px;">
            <div class="modal-title">📝 联机注册</div>
            <div style="margin-bottom:12px;">
                <label style="font-size:13px; color:#666; display:block; margin-bottom:6px;">用户名</label>
                <input type="text" class="modal-input" id="online-register-username" placeholder="3-20位字母数字下划线">
            </div>
            <div style="margin-bottom:12px;">
                <label style="font-size:13px; color:#666; display:block; margin-bottom:6px;">邮箱</label>
                <input type="email" class="modal-input" id="online-register-email" placeholder="用于找回密码（可选）">
            </div>
            <div style="margin-bottom:12px;">
                <label style="font-size:13px; color:#666; display:block; margin-bottom:6px;">密码</label>
                <input type="password" class="modal-input" id="online-register-password" placeholder="至少6位">
            </div>
            <div style="margin-bottom:20px;">
                <label style="font-size:13px; color:#666; display:block; margin-bottom:6px;">确认密码</label>
                <input type="password" class="modal-input" id="online-register-password2" placeholder="再次输入密码">
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal('online-register-modal')">取消</button>
                <button class="modal-btn btn-confirm" onclick="doOnlineRegister()">注册</button>
            </div>
            <div style="text-align:center; margin-top:12px;">
                <span style="font-size:12px; color:#999;">已有账号？</span>
                <span style="font-size:12px; color:var(--ins-pink); cursor:pointer;" onclick="closeModal('online-register-modal');showOnlineLoginModal();">去登录</span>
            </div>
        </div>
    </div>

    <!-- 联机搜索好友弹窗 -->
    <div class="modal-overlay" id="online-search-modal" style="display:none;">
        <div class="modal-box" style="max-width:360px; max-height:80vh; display:flex; flex-direction:column;">
            <div class="modal-title">🌐 联机搜索</div>
            <div style="margin-bottom:16px;">
                <label style="font-size:13px; color:#666; display:block; margin-bottom:6px;">搜索虚拟微信号</label>
                <div style="display:flex; gap:8px;">
                    <input type="text" class="modal-input" id="online-search-input" placeholder="输入对方的虚拟微信号" style="flex:1;">
                    <button onclick="doOnlineSearch()" style="padding:10px 16px; background:var(--ins-pink); color:#fff; border:none; border-radius:8px; font-size:14px; cursor:pointer; white-space:nowrap;">搜索</button>
                </div>
            </div>
            
            <!-- 搜索结果 -->
            <div id="online-search-result" style="display:none; padding:16px; background:#f9f9f9; border-radius:12px; margin-bottom:16px;">
                <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
                    <div id="online-search-avatar" style="width:50px; height:50px; border-radius:8px; background-size:cover; background-position:center; background-color:#e0e0e0;"></div>
                    <div style="flex:1;">
                        <div id="online-search-nickname" style="font-size:16px; font-weight:600; color:#333;"></div>
                        <div id="online-search-wxid" style="font-size:12px; color:#999; margin-top:2px;"></div>
                    </div>
                    <div id="online-search-online-status" style="font-size:11px; padding:3px 8px; border-radius:10px; background:#e8f5e9; color:#4caf50;">在线</div>
                </div>
                <div id="online-search-bio" style="font-size:13px; color:#666; margin-bottom:12px; padding:8px; background:#fff; border-radius:6px;"></div>
                
                <!-- 选择用哪个身份添加 -->
                <div style="margin-bottom:12px;">
                    <label style="font-size:13px; color:#666; display:block; margin-bottom:6px;">选择你的身份</label>
                    <select id="online-search-my-persona" class="modal-input" style="width:100%;">
                        <!-- 动态填充已上线的User角色 -->
                    </select>
                </div>
                
                <div style="margin-bottom:12px;">
                    <label style="font-size:13px; color:#666; display:block; margin-bottom:6px;">申请备注</label>
                    <input type="text" class="modal-input" id="online-search-message" placeholder="我是xxx">
                </div>
                
                <button onclick="sendOnlineFriendRequest()" style="width:100%; padding:12px; background:var(--ins-pink); color:#fff; border:none; border-radius:8px; font-size:14px; cursor:pointer;">发送好友申请</button>
            </div>
            
            <!-- 无结果 -->
            <div id="online-search-empty" style="display:none; text-align:center; padding:30px; color:#999;">
                <div style="font-size:14px;">未找到该用户</div>
                <div style="font-size:12px; margin-top:4px;">请检查微信号是否正确</div>
            </div>
            
            <button class="modal-btn btn-cancel" onclick="closeModal('online-search-modal')" style="margin-top:auto;">关闭</button>
        </div>
    </div>

    <!-- 通知中心弹窗 -->
    <div class="notification-center" id="notification-center">
        <div class="notification-box">
            <div class="notif-header">
                <div class="notif-title">通知中心</div>
                <div class="close-notif" onclick="hideNotificationCenter()">×</div>
            </div>
            <div class="notif-list" id="notif-list">
                <!-- 动态插入通知项 -->
            </div>
        </div>
    </div>

    <!-- 保存提示 -->
    <div class="save-tip" id="save-tip">保存成功！</div>

    <!-- 微信应用页面 -->
    <div class="wechat-page" id="wechat-page">
        <div class="wechat-header">
            <div class="back-btn" onclick="hideWechatPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title" id="wechat-main-title">微信</div>
        <div class="wechat-add" onclick="toggleWechatMenu()" style="width:40px; display:flex; justify-content:flex-end; align-items:center;">
            <svg class="svg-icon" style="width:24px; height:24px;" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            <!-- 下拉菜单 -->
            <div class="wechat-menu" id="wechat-menu">
                <div class="wechat-menu-item" onclick="showAddFriendModal()">
                    <div class="wechat-menu-icon">
                        <svg class="svg-icon" style="width:20px; height:20px; stroke:#fff;" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    </div>
                    <div>添加朋友</div>
                </div>
                <div class="wechat-menu-item" onclick="showDirectAddModal()">
                    <div class="wechat-menu-icon">
                        <svg class="svg-icon" style="width:20px; height:20px; stroke:#fff;" viewBox="0 0 24 24"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                    </div>
                    <div>从档案导入</div>
                </div>
                <div class="wechat-menu-item" onclick="showCreateGroupModal()">
                    <div class="wechat-menu-icon">
                        <svg class="svg-icon" style="width:20px; height:20px; stroke:#fff;" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </div>
                    <div>创建群聊</div>
                </div>
                <div class="wechat-menu-item" onclick="showOnlineSearchModal()" style="border-top:1px solid rgba(255,255,255,0.1);">
                    <div class="wechat-menu-icon" style="background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                        <svg class="svg-icon" style="width:20px; height:20px; stroke:#fff;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
                    </div>
                    <div>联机搜索</div>
                </div>
                <div class="wechat-menu-item" onclick="showCreateOnlineGroupModal()">
                    <div class="wechat-menu-icon" style="background:linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                        <svg class="svg-icon" style="width:20px; height:20px; stroke:#fff;" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    </div>
                    <div>创建联机群聊</div>
                </div>
            </div>
        </div>
        </div>
        
        <div class="wechat-content" id="wechat-content">
            <div class="wechat-empty-state">
                <svg class="svg-icon" style="width:48px; height:48px; stroke:#ccc;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="8" y1="15" x2="16" y2="15"></line><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                <div>暂无好友</div>
            </div>
        </div>

        <div class="wechat-tabbar">
            <div class="wechat-tab-item active" onclick="switchWechatTab(0)">
                <div class="tab-icon">
                    <svg class="svg-icon" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
                </div>
                <div class="tab-name">微信</div>
            </div>
            <div class="wechat-tab-item" onclick="switchWechatTab(1)">
                <div class="tab-icon">
                    <svg class="svg-icon" viewBox="0 0 24 24"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>
                </div>
                <div class="tab-name">通讯录</div>
            </div>
            <div class="wechat-tab-item" onclick="switchWechatTab(2)">
                <div class="tab-icon">
                    <svg class="svg-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><polygon points="16.24 7.76 14.12 14.12 7.76 16.24 9.88 9.88 16.24 7.76"></polygon></svg>
                </div>
                <div class="tab-name">发现</div>
            </div>
            <div class="wechat-tab-item" onclick="switchWechatTab(3)">
                <div class="tab-icon">
                    <svg class="svg-icon" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                </div>
                <div class="tab-name">我</div>
            </div>
        </div>
        
    </div>
    
    <!-- 微信注册页面 - INS风格 -->
    <!-- 微信注册页面 - 粉色INS风格 -->
    <div class="wechat-page" id="wechat-register-page" style="display:none; background:linear-gradient(135deg, #FFF5F7 0%, #FFE8ED 100%); z-index:300;">
        <div class="wechat-header" style="background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-bottom:1px solid rgba(255,182,193,0.3);">
            <div class="back-btn" onclick="cancelWechatRegister()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:#FF6B9D;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title" style="color:#FF6B9D; font-weight:700;">微信注册</div>
            <div style="width:40px;"></div>
        </div>
        
        <div class="wechat-content" style="padding:24px 20px; overflow-y:auto;">
            <!-- Logo -->
            <div style="display:flex; justify-content:center; margin-bottom:32px; margin-top:20px;">
                <div style="width:80px; height:80px; border-radius:20px; background:linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%); display:flex; align-items:center; justify-content:center; box-shadow:0 8px 24px rgba(255,182,193,0.5);">
                    <svg viewBox="0 0 24 24" style="width:48px; height:48px; fill:#fff;">
                        <path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path>
                    </svg>
                </div>
            </div>
            
            <!-- 标题 -->
            <div style="text-align:center; font-size:24px; font-weight:700; color:#FF6B9D; margin-bottom:12px;">
                欢迎注册微信
            </div>
            <div style="text-align:center; font-size:14px; color:#999; margin-bottom:40px;">
                请选择您的身份并完成注册
            </div>
            
            <!-- 选择User档案 -->
            <div style="margin-bottom:20px;">
                <label style="display:block; font-size:15px; color:#888; margin-bottom:8px; font-weight:600;">
                    选择您的身份
                </label>
                <select id="register-user-select" onchange="onRegisterUserChange()" style="width:100%; padding:14px 16px; border:2px solid rgba(255,182,193,0.3); border-radius:12px; font-size:16px; background:#fff; color:#333; transition:all 0.3s; box-sizing:border-box;">
                    <option value="">-- 请选择User档案 --</option>
                </select>
            </div>
            
            <!-- 手机号输入 -->
            <div style="margin-bottom:20px;">
                <label style="display:block; font-size:15px; color:#888; margin-bottom:8px; font-weight:600;">
                    手机号
                </label>
                <input type="tel" id="register-phone-input" placeholder="请输入您的7位手机号" maxlength="7" style="width:100%; padding:14px 16px; border:2px solid rgba(255,182,193,0.3); border-radius:12px; font-size:16px; box-sizing:border-box; transition:all 0.3s; background:#fff;" onfocus="this.style.borderColor='#FFB6C1'" onblur="this.style.borderColor='rgba(255,182,193,0.3)'">
                <div id="register-phone-hint" style="font-size:13px; color:#FFB6C1; margin-top:6px; display:none;">
                    ✓ 这是您创建档案时分配的手机号
                </div>
            </div>
            
            <!-- 验证码 -->
            <div style="margin-bottom:20px;">
                <label style="display:block; font-size:15px; color:#888; margin-bottom:8px; font-weight:600;">
                    验证码
                </label>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="register-code-input" placeholder="请输入验证码" maxlength="6" style="flex:1; padding:14px 16px; border:2px solid rgba(255,182,193,0.3); border-radius:12px; font-size:16px; transition:all 0.3s; background:#fff; box-sizing:border-box;" onfocus="this.style.borderColor='#FFB6C1'" onblur="this.style.borderColor='rgba(255,182,193,0.3)'">
                    <button id="register-code-btn" onclick="sendRegisterCode()" style="padding:14px 24px; background:linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%); color:#fff; border:none; border-radius:12px; font-size:15px; font-weight:600; cursor:pointer; white-space:nowrap; transition:all 0.3s; box-shadow:0 4px 12px rgba(255,182,193,0.4);">
                        获取验证码
                    </button>
                </div>
                <div id="register-code-message" style="font-size:13px; color:#999; margin-top:6px;"></div>
            </div>
            
            <!-- 设置密码 -->
            <div style="margin-bottom:20px;">
                <label style="display:block; font-size:15px; color:#888; margin-bottom:8px; font-weight:600;">
                    设置密码
                </label>
                <input type="password" id="register-password-input" placeholder="8-20位字符，建议包含数字和字母" maxlength="20" style="width:100%; padding:14px 16px; border:2px solid rgba(255,182,193,0.3); border-radius:12px; font-size:16px; box-sizing:border-box; transition:all 0.3s; background:#fff;" onfocus="this.style.borderColor='#FFB6C1'" onblur="this.style.borderColor='rgba(255,182,193,0.3)'">
            </div>
            
            <!-- 微信号 -->
            <div style="margin-bottom:32px;">
                <label style="display:block; font-size:15px; color:#888; margin-bottom:8px; font-weight:600;">
                    微信号（ID）
                </label>
                <input type="text" id="register-account-input" placeholder="字母、数字、下划线，6-20位" maxlength="20" style="width:100%; padding:14px 16px; border:2px solid rgba(255,182,193,0.3); border-radius:12px; font-size:16px; box-sizing:border-box; transition:all 0.3s; background:#fff;" onfocus="this.style.borderColor='#FFB6C1'" onblur="this.style.borderColor='rgba(255,182,193,0.3)'">
                <div style="font-size:13px; color:#999; margin-top:6px;">
                    微信号设置后不可修改
                </div>
            </div>
            
            <!-- 注册按钮 -->
            <button onclick="submitWechatRegister()" style="width:100%; padding:16px; background:linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%); color:#fff; border:none; border-radius:12px; font-size:17px; font-weight:700; cursor:pointer; box-shadow:0 6px 20px rgba(255,182,193,0.5); transition:all 0.3s; margin-bottom:20px;">
                完成注册
            </button>
            
            <!-- 服务协议 -->
            <div style="text-align:center; font-size:12px; color:#999; line-height:1.6;">
                点击"完成注册"即表示您同意<br>
                <span style="color:#FFB6C1;">《微信软件许可及服务协议》</span>和<span style="color:#FFB6C1;">《隐私保护指引》</span>
            </div>
        </div>
    </div>

    <!-- 收藏页面 -->
    <div class="wechat-page" id="favorites-page" style="display:none; background:#f2f2f7;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideFavoritesPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">收藏</div>
            <div style="width:40px;"></div>
        </div>
        
        <div style="flex:1; overflow-y:auto; padding:16px;">
            <!-- 分类标签 -->
            <div style="display:flex; gap:10px; margin-bottom:16px; overflow-x:auto; padding-bottom:8px;">
                <div class="fav-tab active" data-type="all" onclick="switchFavTab('all')" style="padding:8px 16px; background:var(--ins-pink); color:#fff; border-radius:20px; font-size:14px; white-space:nowrap; cursor:pointer;">全部</div>
                <div class="fav-tab" data-type="summaries" onclick="switchFavTab('summaries')" style="padding:8px 16px; background:#fff; color:#666; border-radius:20px; font-size:14px; white-space:nowrap; cursor:pointer; border:1px solid #e0e0e0;">聊天总结</div>
            </div>
            
            <!-- 收藏列表 -->
            <div id="favorites-list" style="display:grid; grid-template-columns: repeat(1, 1fr); gap:12px;">
                <!-- 动态生成 -->
            </div>
            
            <!-- 空状态 -->
            <div id="favorites-empty" style="display:none; text-align:center; padding:60px 20px; color:#999;">
                <svg class="svg-icon" style="width:64px; height:64px; stroke:#ccc; margin-bottom:16px;" viewBox="0 0 24 24">
                    <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                </svg>
                <div style="font-size:16px; margin-bottom:8px;">暂无收藏</div>
                <div style="font-size:14px;">聊天总结会自动保存到这里</div>
            </div>
        </div>
    </div>

    <!-- 总结详情页面 -->
    <div class="wechat-page" id="summary-detail-page" style="display:none; background:#fff;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideSummaryDetailPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title" id="summary-detail-title">聊天总结</div>
            <div class="wechat-add" onclick="deleteSummary()" style="width:40px; text-align:right; color:#ff3b30; font-size:14px;">删除</div>
        </div>
        
        <div style="flex:1; overflow-y:auto; padding:16px;">
            <!-- 总结头部信息 -->
            <div style="display:flex; align-items:center; margin-bottom:20px; padding:16px; background:#f9f9f9; border-radius:12px;">
                <div id="summary-detail-avatar" style="width:50px; height:50px; border-radius:10px; background-size:cover; background-position:center; background-color:#e0e0e0; margin-right:12px;"></div>
                <div style="flex:1;">
                    <div id="summary-detail-name" style="font-size:17px; font-weight:600; color:#333; margin-bottom:4px;">角色名称</div>
                    <div id="summary-detail-time" style="font-size:13px; color:#999;">2024-01-01 12:00</div>
                </div>
            </div>
            
            <!-- 总结统计 -->
            <div style="display:flex; gap:12px; margin-bottom:20px;">
                <div style="flex:1; padding:16px; background:#fff5f7; border-radius:12px; text-align:center;">
                    <div id="summary-msg-count" style="font-size:24px; font-weight:700; color:var(--ins-pink);">0</div>
                    <div style="font-size:12px; color:#999; margin-top:4px;">消息数</div>
                </div>
                <div style="flex:1; padding:16px; background:#f0f9ff; border-radius:12px; text-align:center;">
                    <div id="summary-time-range" style="font-size:14px; font-weight:600; color:#3b82f6;">-</div>
                    <div style="font-size:12px; color:#999; margin-top:4px;">时间跨度</div>
                </div>
            </div>
            
            <!-- 总结内容 -->
            <div style="margin-bottom:20px;">
                <div style="font-size:15px; font-weight:600; color:#333; margin-bottom:12px;">📝 聊天总结</div>
                <div id="summary-detail-content" style="padding:16px; background:#f9f9f9; border-radius:12px; font-size:15px; color:#333; line-height:1.8; white-space:pre-wrap;">
                    加载中...
                </div>
            </div>
            
            <!-- 关键词/标签 -->
            <div id="summary-keywords-section" style="margin-bottom:20px; display:none;">
                <div style="font-size:15px; font-weight:600; color:#333; margin-bottom:12px;">🏷️ 关键词</div>
                <div id="summary-detail-keywords" style="display:flex; flex-wrap:wrap; gap:8px;">
                    <!-- 动态生成标签 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天总结列表页面（从聊天详情跳转） -->
    <div class="wechat-page" id="chat-summaries-page" style="display:none; background:#f2f2f7;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideChatSummariesPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title" id="chat-summaries-title">聊天总结</div>
            <div style="width:40px;"></div>
        </div>
        
        <div style="flex:1; overflow-y:auto; padding:16px;">
            <div id="chat-summaries-list" style="display:flex; flex-direction:column; gap:12px;">
                <!-- 动态生成 -->
            </div>
            
            <!-- 空状态 -->
            <div id="chat-summaries-empty" style="display:none; text-align:center; padding:60px 20px; color:#999;">
                <svg class="svg-icon" style="width:64px; height:64px; stroke:#ccc; margin-bottom:16px;" viewBox="0 0 24 24">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                    <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
                <div style="font-size:16px; margin-bottom:8px;">暂无总结</div>
                <div style="font-size:14px;">开启自动总结或点击"立即生成"</div>
            </div>
        </div>
    </div>

    <!-- 联机状态页面 -->
    <div class="wechat-page" id="online-status-page" style="display:none; background:#f5f5f5; z-index:10000;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideOnlineStatusPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">联机状态</div>
            <div style="width:40px;"></div>
        </div>
        
        <div id="online-status-connection" style="padding:16px; text-align:center; font-size:14px;">
            <!-- 连接状态动态更新 -->
        </div>
        
        <div style="flex:1; overflow-y:auto;">
            <!-- 联机群聊入口 -->
            <div style="padding:12px 16px; font-size:13px; color:#888; display:flex; justify-content:space-between; align-items:center;">
                <span>联机群聊</span>
                <button onclick="showCreateOnlineGroupModal()" style="padding:6px 12px; background:var(--ins-pink); color:#fff; border:none; border-radius:6px; font-size:12px; cursor:pointer;">+ 创建群聊</button>
            </div>
            <div id="online-group-list" style="background:#fff;">
                <!-- 群聊列表动态更新 -->
            </div>
            
            <div style="padding:12px 16px; font-size:13px; color:#888; margin-top:10px;">
                我的User角色（可上线）
            </div>
            <div id="online-status-char-list">
                <!-- 角色列表动态更新 -->
            </div>
            
            <div style="padding:16px; font-size:12px; color:#999; line-height:1.6;">
                <div style="font-weight:600; color:#666; margin-bottom:6px;">💡 使用说明</div>
                <div>• 上线后，其他用户可以通过你的虚拟微信号搜索到你</div>
                <div>• 你可以同时上线多个角色</div>
                <div>• 上线的角色可以接收好友申请和消息</div>
                <div>• 关闭页面或刷新后需要重新上线</div>
                <div>• 联机群聊可以邀请好友一起聊天，每人可带一个AI角色</div>
            </div>
        </div>
    </div>

    <!-- 新的好友页面 -->
    <div class="wechat-page" id="new-friends-page" style="display:none;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideNewFriendsPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">新的好友</div>
            <div style="width:40px;"></div>
        </div>
        
        <div class="wechat-content" id="new-friends-content" style="display:block; padding:16px;">
            <!-- 动态生成好友申请列表 -->
        </div>
    </div>

    <!-- 搜索好友弹窗 -->
    <div class="modal-overlay" id="search-friend-modal">
        <div class="modal-box">
            <div class="modal-title">添加朋友</div>
            <input type="text" class="modal-input" id="search-account-input" placeholder="输入角色虚拟账号">
            <button class="modal-btn" style="background:var(--ins-pink); color:#fff;" onclick="searchAccount()">搜索</button>
            
            <!-- 搜索结果区 -->
            <div class="search-result-card" id="search-result-area">
                <div class="result-avatar" id="search-result-avatar"></div>
                <div style="flex:1;">
                    <div style="font-weight:600;" id="search-result-name">Name</div>
                    <div style="font-size:12px; color:#999;" id="search-result-id">Account</div>
                </div>
            </div>

            <!-- 申请理由区 (默认隐藏，搜到后显示) -->
            <div id="apply-area" style="display:none; width:100%;">
                <div style="margin-bottom:10px;">
                    <label style="font-size:12px; color:#666; display:block; margin-bottom:4px;">使用身份</label>
                    <select id="apply-user-select" class="modal-input" style="padding:8px;">
                        <!-- 动态生成 -->
                    </select>
                </div>
                <input type="text" class="modal-input" id="apply-reason" placeholder="申请理由 (如: 我是...)" style="margin-bottom:10px;">
                <div class="modal-btns">
                    <button class="modal-btn btn-cancel" onclick="closeModal('search-friend-modal')">取消</button>
                    <button class="modal-btn btn-confirm" onclick="sendFriendRequest()">发送申请</button>
                </div>
            </div>
            
            <!-- 初始取消按钮 -->
            <button class="modal-btn btn-cancel" id="search-cancel-btn" onclick="closeModal('search-friend-modal')">取消</button>
        </div>
    </div>

    <!-- 从档案导入弹窗 -->
    <div class="modal-overlay" id="direct-add-modal">
        <div class="modal-box" style="height:70%;">
            <div class="modal-title">选择角色导入</div>
            <div style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:8px;" id="direct-add-list">
                <!-- 动态生成 -->
            </div>
            <button class="modal-btn btn-cancel" onclick="closeModal('direct-add-modal')">关闭</button>
        </div>
    </div>

    <!-- 创建群聊弹窗 -->
    <div class="modal-overlay" id="create-group-modal">
        <div class="modal-box" style="height:80%; max-width:400px;">
            <div class="modal-title">创建群聊</div>
            <div style="padding:0 16px 16px;">
                <input type="text" id="group-name-input" placeholder="群聊名称（可选）" style="width:100%; padding:12px 16px; border:1px solid #e0e0e0; border-radius:8px; font-size:15px; box-sizing:border-box; margin-bottom:12px;">
            </div>
            <div style="padding:0 16px 8px; font-size:13px; color:#888;">选择群成员：</div>
            <div style="flex:1; overflow-y:auto; padding:0 16px;" id="group-friends-list">
                <!-- 动态生成好友列表 -->
            </div>
            <div style="padding:16px; display:flex; gap:12px;">
                <button class="modal-btn btn-cancel" style="flex:1;" onclick="closeModal('create-group-modal')">取消</button>
                <button class="modal-btn" style="flex:1; background:var(--ins-pink); color:#fff;" onclick="confirmCreateGroup()">创建</button>
            </div>
        </div>
    </div>

    <!-- 角色心声弹窗 -->
    <div class="modal-overlay" id="thoughts-modal" onclick="closeModal('thoughts-modal')">
        <div class="modal-box thoughts-modal-box" onclick="event.stopPropagation()">
            <!-- 顶部标题栏 -->
            <div class="thoughts-header">
                <div class="thoughts-close" onclick="closeModal('thoughts-modal')">×</div>
                <div class="thoughts-title" id="thoughts-modal-title">TA的心声</div>
                <div class="thoughts-actions">
                    <span class="thoughts-action-btn" onclick="editCurrentThought()">编辑</span>
                    <span class="thoughts-action-btn" onclick="regenerateThought()">重新生成</span>
                </div>
            </div>
            
            <!-- 当前心声区域 -->
            <div class="thoughts-current" id="thoughts-current">
                <div class="thoughts-current-text" id="thoughts-current-text">暂无心声</div>
                <div class="thoughts-current-time" id="thoughts-current-time"></div>
            </div>
            
            <!-- 查看历史按钮 -->
            <div class="thoughts-history-btn" id="thoughts-history-btn" onclick="toggleThoughtsHistory()">
                <span>查看历史心声</span>
                <svg class="thoughts-arrow" id="thoughts-arrow" viewBox="0 0 24 24"><polyline points="6 9 12 15 18 9"></polyline></svg>
            </div>
            
            <!-- 历史心声区域（默认隐藏） -->
            <div class="thoughts-history" id="thoughts-history" style="display:none;">
                <div id="thoughts-history-content">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 聊天窗口 -->
    <div class="chat-window" id="chat-window">
        <!-- 账号下线遮罩 - INS风格 -->
        <div id="account-offline-mask" style="display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:999; flex-direction:column; align-items:center; justify-content:center; backdrop-filter:blur(20px); -webkit-backdrop-filter:blur(20px);">
            <!-- 装饰性渐变背景 -->
            <div style="position:absolute; top:0; left:0; right:0; height:300px; background:linear-gradient(180deg, rgba(255,182,193,0.2) 0%, rgba(255,192,203,0.1) 50%, rgba(255,255,255,0) 100%); pointer-events:none;"></div>
            
            <div style="position:relative; display:flex; flex-direction:column; align-items:center; max-width:360px; padding:40px 30px; background:rgba(255,255,255,0.9); border-radius:24px; box-shadow:0 20px 60px rgba(255,182,193,0.25), 0 0 1px rgba(0,0,0,0.05);">
                <!-- 图标 -->
                <div style="width:100px; height:100px; border-radius:50%; background:linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%); display:flex; align-items:center; justify-content:center; margin-bottom:28px; box-shadow:0 12px 32px rgba(255,182,193,0.4); position:relative;">
                    <svg viewBox="0 0 24 24" style="width:50px; height:50px; stroke:#fff; fill:none; stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round;">
                        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                        <path d="M9 12l2 2 4-4"></path>
                    </svg>
                    <!-- 脉冲动画圆环 -->
                    <div style="position:absolute; width:100%; height:100%; border-radius:50%; border:2px solid rgba(255,182,193,0.6); animation:pulse 2s infinite;"></div>
                </div>
                
                <!-- 标题 -->
                <div style="font-size:24px; font-weight:700; margin-bottom:12px; color:#555; letter-spacing:0.5px; text-align:center;">
                    账号正在被查看
                </div>
                
                <!-- 描述文字 -->
                <div style="font-size:15px; color:#888; text-align:center; line-height:1.8; margin-bottom:24px; max-width:280px;">
                    <span id="offline-reason-text" style="color:#999;">正在读取你的账号信息</span>
                </div>
                
                <!-- 加载动画 -->
                <div style="display:flex; gap:10px; margin-bottom:28px;">
                    <div style="width:10px; height:10px; border-radius:50%; background:linear-gradient(135deg, #FFB6C1, #FFC0CB); animation:bounce 1.4s infinite ease-in-out both; animation-delay:-0.32s; box-shadow:0 2px 8px rgba(255,182,193,0.5);"></div>
                    <div style="width:10px; height:10px; border-radius:50%; background:linear-gradient(135deg, #FFC0CB, #FFB6C1); animation:bounce 1.4s infinite ease-in-out both; animation-delay:-0.16s; box-shadow:0 2px 8px rgba(255,192,203,0.5);"></div>
                    <div style="width:10px; height:10px; border-radius:50%; background:linear-gradient(135deg, #FFB6C1, #FFC0CB); animation:bounce 1.4s infinite ease-in-out both; box-shadow:0 2px 8px rgba(255,182,193,0.5);"></div>
                </div>
                
                <!-- 提示文字 -->
                <div style="font-size:13px; color:#bbb; text-align:center; margin-bottom:32px; letter-spacing:0.3px;">
                    查看完成后将自动恢复
                </div>
                
                <!-- 重新登录按钮 -->
                <button onclick="reconnectAccount()" style="padding:16px 56px; background:linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%); color:#fff; border:none; border-radius:28px; font-size:16px; cursor:pointer; font-weight:600; box-shadow:0 8px 24px rgba(255,182,193,0.45); transition:all 0.3s ease; letter-spacing:1px;">
                    立即重新登录
                </button>
            </div>
        </div>
        
        <!-- 验证码弹窗 - INS风格 -->
        <div id="verification-code-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
            <div style="background:#fff; border-radius:20px; padding:32px 28px 24px; max-width:340px; width:85%; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:modalSlideIn 0.3s ease;">
                <!-- 图标 -->
                <div style="display:flex; justify-content:center; margin-bottom:20px;">
                    <div style="width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); display:flex; align-items:center; justify-content:center; box-shadow:0 8px 20px rgba(76,175,80,0.4);">
                        <svg viewBox="0 0 24 24" style="width:32px; height:32px; stroke:#fff; fill:none; stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round;">
                            <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                            <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- 标题 -->
                <div style="font-size:20px; font-weight:700; color:#333; text-align:center; margin-bottom:16px; letter-spacing:0.5px;">
                    收到验证码
                </div>
                
                <!-- 内容 -->
                <div style="font-size:14px; color:#666; line-height:1.8; text-align:center; margin-bottom:24px; padding:0 8px;">
                    欢迎小助手已向您发送验证码：
                </div>
                
                <!-- 验证码显示 -->
                <div style="background:linear-gradient(135deg, #E8F5E9 0%, #C8E6C9 100%); border-radius:12px; padding:20px; margin-bottom:24px; text-align:center;">
                    <div id="verification-code-text" style="font-size:32px; font-weight:700; color:#4CAF50; letter-spacing:8px; font-family:'Courier New', monospace;">
                        123456
                    </div>
                </div>
                
                <!-- 提示 -->
                <div style="font-size:13px; color:#999; text-align:center; margin-bottom:20px; line-height:1.6;">
                    请在注册页面输入此验证码<br>
                    <span style="color:#FF6B6B; font-weight:600;">5分钟内有效</span>
                </div>
                
                <!-- 确定按钮 -->
                <button onclick="closeVerificationCodeModal()" style="width:100%; padding:14px; background:linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(76,175,80,0.4); transition:all 0.3s ease; letter-spacing:0.5px;">
                    知道了
                </button>
            </div>
        </div>
        
        <!-- 手机号分配弹窗 - INS风格 -->
        <div id="phone-assigned-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(5px);">
            <div style="background:#fff; border-radius:20px; padding:32px 28px 24px; max-width:340px; width:85%; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:modalSlideIn 0.3s ease;">
                <!-- 图标 -->
                <div style="display:flex; justify-content:center; margin-bottom:20px;">
                    <div style="width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); display:flex; align-items:center; justify-content:center; box-shadow:0 8px 20px rgba(76,175,80,0.4);">
                        <svg viewBox="0 0 24 24" style="width:32px; height:32px; stroke:#fff; fill:none; stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round;">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                    </div>
                </div>
                
                <!-- 标题 -->
                <div style="font-size:20px; font-weight:700; color:#333; text-align:center; margin-bottom:16px; letter-spacing:0.5px;">
                    手机号已分配
                </div>
                
                <!-- 内容 -->
                <div style="font-size:14px; color:#666; line-height:1.8; text-align:center; margin-bottom:24px; padding:0 8px;">
                    您的手机号是：
                </div>
                
                <!-- 手机号显示 -->
                <div style="background:linear-gradient(135deg, #E3F2FD 0%, #BBDEFB 100%); border-radius:12px; padding:16px; margin-bottom:28px; text-align:center;">
                    <div id="assigned-phone-number" style="font-size:28px; font-weight:700; color:#1976D2; letter-spacing:4px; font-family:'Courier New', monospace;">
                        1234567
                    </div>
                </div>
                
                <!-- 提示 -->
                <div style="font-size:13px; color:#999; text-align:center; margin-bottom:20px; line-height:1.6;">
                    首次使用微信时，请使用此手机号注册
                </div>
                
                <!-- 确定按钮 -->
                <button onclick="closePhoneAssignedModal()" style="width:100%; padding:14px; background:linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(76,175,80,0.4); transition:all 0.3s ease; letter-spacing:0.5px;">
                    我知道了
                </button>
            </div>
        </div>
        
        <!-- 密码错误警告弹窗 - INS风格 -->
        <div id="password-error-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; backdrop-filter:blur(5px); -webkit-backdrop-filter:blur(5px);">
            <div style="background:#fff; border-radius:20px; padding:32px 28px 24px; max-width:340px; width:85%; box-shadow:0 20px 60px rgba(0,0,0,0.3); animation:modalSlideIn 0.3s ease;">
                <!-- 图标 -->
                <div style="display:flex; justify-content:center; margin-bottom:20px;">
                    <div style="width:64px; height:64px; border-radius:50%; background:linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%); display:flex; align-items:center; justify-content:center; box-shadow:0 8px 20px rgba(255,182,193,0.4);">
                        <svg viewBox="0 0 24 24" style="width:32px; height:32px; stroke:#fff; fill:none; stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round;">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="12"></line>
                            <line x1="12" y1="16" x2="12.01" y2="16"></line>
                        </svg>
                    </div>
                </div>
                
                <!-- 标题 -->
                <div style="font-size:20px; font-weight:700; color:#333; text-align:center; margin-bottom:16px; letter-spacing:0.5px;">
                    登录异常提醒
                </div>
                
                <!-- 内容 -->
                <div style="font-size:14px; color:#666; line-height:1.8; text-align:center; margin-bottom:28px; padding:0 8px;">
                    检测到<span style="color:#FFB6C1; font-weight:600;">有人正在尝试登录</span>你的账号。<br>
                    如果这不是你本人操作，<span style="color:#FF6B9D; font-weight:600;">请尽快更改密码</span>。
                </div>
                
                <!-- 确定按钮 -->
                <button onclick="closePasswordErrorModal()" style="width:100%; padding:14px; background:linear-gradient(135deg, #FFB6C1 0%, #FFC0CB 100%); color:#fff; border:none; border-radius:12px; font-size:16px; font-weight:600; cursor:pointer; box-shadow:0 4px 12px rgba(255,182,193,0.4); transition:all 0.3s ease; letter-spacing:0.5px;">
                    我知道了
                </button>
            </div>
        </div>
        
        <div class="chat-header">
            <div class="chat-back" onclick="hideChatWindow()">
                <svg class="svg-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="chat-title" id="chat-title" style="margin-right:0; text-align:center;">User</div>
            <div class="chat-more" onclick="showOfflineMode()" style="margin-right:8px;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px;"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
            </div>
            <div class="chat-more" onclick="showChatOrGroupDetail()">
                <svg class="svg-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"></circle><circle cx="19" cy="12" r="1"></circle><circle cx="5" cy="12" r="1"></circle></svg>
            </div>
        </div>
        <div class="chat-body" id="chat-body">
            <!-- 消息列表 -->
        </div>
        <div class="chat-footer" id="chat-footer">
            <!-- 引用预览区域 -->
            <div class="quote-preview" id="quote-preview" style="display:none;">
                <div class="quote-preview-content">
                    <div class="quote-preview-line"></div>
                    <div class="quote-preview-text">
                        <span class="quote-preview-name" id="quote-preview-name"></span>
                        <span class="quote-preview-msg" id="quote-preview-msg"></span>
                    </div>
                </div>
                <div class="quote-preview-close" onclick="cancelQuote()">
                    <svg viewBox="0 0 24 24" style="width:16px; height:16px;"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </div>
            </div>
            <div class="chat-input-bar">
                <!-- 左侧：AI 魔法棒 -->
                <div class="chat-icon-btn" onclick="triggerAiReply()">
                    <svg class="svg-icon" viewBox="0 0 24 24"><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 5H1"/></svg>
                </div>
                
                <!-- 中间：输入框 -->
                <input type="text" class="chat-input" id="chat-input-box" onkeypress="handleChatInputKey(event)" oninput="handleChatInputChange(this)" onfocus="closeChatPanel()" placeholder="发送消息...">
                
                <!-- 右侧：表情 -->
                <div class="chat-icon-btn" onclick="toggleChatPanel('emoji')">
                    <svg class="svg-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><path d="M8 14s1.5 2 4 2 4-2 4-2"></path><line x1="9" y1="9" x2="9.01" y2="9"></line><line x1="15" y1="9" x2="15.01" y2="9"></line></svg>
                </div>
                
                <!-- 右侧：菜单 (+) -->
                <div class="chat-icon-btn" id="btn-more" onclick="toggleChatPanel('action')">
                    <svg class="svg-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                </div>
                
                <!-- 右侧：发送 (Send) - 默认隐藏 -->
                <div class="chat-send-btn" id="btn-send" onclick="sendMessage()">
                    <svg class="svg-icon" viewBox="0 0 24 24" style="width:18px; height:18px; stroke-width:3; transform: rotate(90deg) translateX(-2px);"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
                </div>
            </div>
            
            <!-- 面板容器 -->
            <div class="chat-panel-container" id="chat-panel-container">
                <!-- 增加表情包 Tab -->
                <div style="height: 40px; display: flex; border-bottom: 1px solid #eee; background: #fff;" id="emoji-tab-bar">
                    <div class="wechat-tab-item active" onclick="switchEmojiTab('emoji')" style="flex:1; font-size:14px;">Emoji</div>
                    <div class="wechat-tab-item" onclick="switchEmojiTab('sticker')" style="flex:1; font-size:14px;">表情包</div>
                </div>
                <div class="emoji-panel" id="emoji-panel" style="height: calc(100% - 40px);">
                    <!-- 动态生成表情 -->
                </div>
                <div class="emoji-panel" id="sticker-panel" style="height: calc(100% - 40px); display: none; grid-template-columns: repeat(4, 1fr);">
                    <!-- 动态生成自定义表情 -->
                    <div style="text-align:center; grid-column:span 4; color:#999; margin-top:20px;">暂无表情包<br>请在详情页添加</div>
                </div>

                <div class="action-panel" id="action-panel">
                    <div class="action-item" onclick="showVoiceInputModal()">
                        <div class="action-icon-box">
                            <svg class="svg-icon" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg>
                        </div>
                        <div class="action-name">语音输入</div>
                    </div>
                    <div class="action-item" onclick="showImageTypeModal()">
                        <div class="action-icon-box">
                            <svg class="svg-icon" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
                        </div>
                        <div class="action-name">相册</div>
                    </div>
                    <input type="file" id="chat-image-input" style="display:none;" accept="image/*" onchange="sendImageMessage(this)">
                    <div class="action-item" onclick="showTransferPage()">
                        <div class="action-icon-box transfer-icon">
                            <svg class="svg-icon" viewBox="0 0 24 24"><path d="M17 1l4 4-4 4"></path><path d="M3 11V9a4 4 0 0 1 4-4h14"></path><path d="M7 23l-4-4 4-4"></path><path d="M21 13v2a4 4 0 0 1-4 4H3"></path></svg>
                        </div>
                        <div class="action-name">转账</div>
                    </div>
                    <div class="action-item" onclick="showLocationModal()">
                        <div class="action-icon-box">
                            <svg class="svg-icon" viewBox="0 0 24 24"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                        </div>
                        <div class="action-name">位置</div>
                    </div>
                    <div class="action-item" onclick="showCalendarPage()">
                        <div class="action-icon-box">
                            <svg class="svg-icon" viewBox="0 0 24 24"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                        </div>
                        <div class="action-name">日历</div>
                    </div>
                    <div class="action-item" onclick="initiateVideoCall()">
                        <div class="action-icon-box">
                            <svg class="svg-icon" viewBox="0 0 24 24"><path d="M23 7l-7 5 7 5V7z"></path><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                        </div>
                        <div class="action-name">视频</div>
                    </div>
                    <div class="action-item" onclick="regenerateLastReply()">
                        <div class="action-icon-box">
                            <svg class="svg-icon" viewBox="0 0 24 24"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                        </div>
                        <div class="action-name">重回</div>
                    </div>
                    <div class="action-item" onclick="showFastForwardModal()">
                        <div class="action-icon-box">
                            <svg class="svg-icon" viewBox="0 0 24 24"><polygon points="13 19 22 12 13 5 13 19"></polygon><polygon points="2 19 11 12 2 5 2 19"></polygon></svg>
                        </div>
                        <div class="action-name">快进</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- App Store 页面 -->
    <div class="wechat-page" id="appstore-page" style="background:#f2f2f7;">
        <div class="wechat-header" style="background:rgba(255,255,255,0.95); backdrop-filter:blur(10px);">
            <div class="back-btn" onclick="hideAppStorePage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div style="flex:1; padding:0 10px;">
                <input type="text" id="appstore-search" placeholder="游戏、App 和更多" style="width:100%; padding:8px 12px; background:#f0f0f5; border:none; border-radius:10px; font-size:15px; outline:none;">
            </div>
            <div style="width:40px;"></div>
        </div>
        
        <div class="wechat-content" style="display:block; padding:0; overflow-y:auto;">
            <!-- 标签栏 -->
            <div style="display:flex; background:#fff; padding:10px 16px; gap:20px; border-bottom:1px solid #eee; position:sticky; top:0; z-index:5;">
                <div class="appstore-tab active" onclick="switchAppStoreTab('today')" data-tab="today">Today</div>
                <div class="appstore-tab" onclick="switchAppStoreTab('games')" data-tab="games">游戏</div>
                <div class="appstore-tab" onclick="switchAppStoreTab('apps')" data-tab="apps">App</div>
                <div class="appstore-tab" onclick="switchAppStoreTab('updates')" data-tab="updates">更新</div>
            </div>
            
            <!-- 内容区 -->
            <div id="appstore-content" style="padding:16px;">
                <!-- 动态生成 -->
            </div>
        </div>
    </div>

    <!-- 世界书 (Lorebook) 页面 -->
    <div class="wechat-page" id="lorebook-page" style="background:#fff;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideLorebookPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">世界书</div>
            <div class="wechat-add" onclick="document.getElementById('lorebook-import').click()" style="width:40px; text-align:right; font-size:16px; color:#666;">导入</div>
        </div>
        
        <div class="wechat-content" id="lorebook-content" style="display:block; padding:16px;">
            <!-- 工具栏 -->
            <div style="display:flex; gap:10px; margin-bottom:16px;">
                <div onclick="createNewLorebook()" style="flex:1; background:#f2f2f7; padding:12px; border-radius:10px; text-align:center; color:var(--ins-pink); font-weight:500;">+ 新建世界书</div>
            </div>
            
            <!-- 列表 -->
            <div id="lorebook-list" style="display:flex; flex-direction:column; gap:12px;">
                <!-- 动态生成 -->
            </div>
        </div>
        
        <!-- 隐藏的导入 Input -->
        <input type="file" id="lorebook-import" style="display:none;" accept=".json" onchange="importLorebookFile(this)">
    </div>

    <!-- 聊天详情页 -->
    <div class="chat-detail-page" id="chat-detail-page">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideChatDetail()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">聊天详情</div>
            <div style="width:40px;"></div>
        </div>
        
        <div style="flex:1; overflow-y:auto;">
            <!-- 头像与备注 -->
            <div class="detail-avatar-box">
                <div class="detail-avatar" id="detail-char-avatar" onclick="document.getElementById('detail-avatar-input').click()">
                    <div style="position:absolute; bottom:0; right:0; background:rgba(0,0,0,0.5); color:#fff; font-size:10px; padding:2px 4px; border-radius:4px;">更换</div>
                </div>
                <input type="text" class="detail-name-input" id="detail-char-remark" placeholder="备注名" onchange="saveChatDetail()">
                <div style="font-size:12px; color:#999; margin-top:4px;" id="detail-char-realname">原名: ???</div>
            </div>
            
            <!-- 档案关联 -->
            <div class="detail-group">
                <div class="detail-item" onclick="jumpToCharEditor()">
                    <div>角色档案</div>
                    <div style="display:flex; align-items:center; color:#999; font-size:14px;">
                        <span>查看/编辑</span>
                        <span class="detail-arrow">›</span>
                    </div>
                </div>
                <div class="detail-item" style="flex-direction:column; align-items:flex-start;">
                    <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                        <div>关联世界书</div>
                        <div id="detail-lorebook-count" style="font-size:12px; color:#999;">0个</div>
                    </div>
                    <div id="detail-lorebook-list" style="width:100%; margin-top:8px; max-height:200px; overflow-y:auto; display:none;">
                        <!-- 世界书checkbox列表将在这里动态生成 -->
                    </div>
                    <div style="width:100%; margin-top:4px; text-align:right;">
                        <span id="detail-lorebook-toggle" style="font-size:12px; color:var(--ins-pink); cursor:pointer;" onclick="toggleLorebookList()">展开</span>
                    </div>
                </div>
            </div>

            <!-- 主动聊天设置 -->
            <div class="detail-group">
                <div class="detail-item">
                    <div>主动发消息</div>
                    <label class="ios-switch">
                        <input type="checkbox" id="detail-auto-chat-switch" onchange="saveChatDetail()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="detail-item">
                    <div>触发间隔 (分钟)</div>
                    <input type="number" id="detail-auto-chat-interval" placeholder="30" style="border:none; background:transparent; width:60px; text-align:right; font-size:16px; color:#8e8e93; outline:none;" onchange="saveChatDetail()">
                </div>
            </div>

            <!-- AI查岗功能 -->
            <div class="detail-group">
                <div class="detail-item">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <div>允许AI查岗</div>
                        <div style="font-size:12px; color:#999; line-height:1.4;">AI可根据剧情尝试登录你的账号</div>
                    </div>
                    <label class="ios-switch">
                        <input type="checkbox" id="detail-allow-check-switch" onchange="saveChatDetail()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div style="padding:12px 16px; font-size:12px; color:#999; line-height:1.6; background:#f8f8f8; border-radius:8px; margin:0 16px 12px 16px;">
                    <div style="font-weight:600; color:#666; margin-bottom:6px;">功能说明：</div>
                    <div>• 无密码时：AI可直接"登录"你的账号，你会暂时掉线</div>
                    <div>• 有密码时：AI需猜对密码才能登录，猜错会收到提示</div>
                    <div>• AI会根据聊天剧情决定是否查岗（如长时间不回等）</div>
                </div>
            </div>

            <!-- AI上下文设置 -->
            <div class="detail-group">
                <div class="detail-item">
                    <div>上下文条数</div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <input type="number" id="detail-context-count" value="20" style="border:none; background:transparent; width:60px; text-align:right; font-size:16px; color:#8e8e93; outline:none;" onchange="saveChatDetail()">
                        <span style="font-size:12px; color:#999;">条</span>
                    </div>
                </div>
                <div style="padding:12px 16px; font-size:12px; color:#999; line-height:1.5;">
                    发送给AI的历史消息条数，影响AI对对话上下文的理解。
                </div>
            </div>

            <!-- 挂载表情包库 -->
            <div class="detail-group">
                <div class="detail-item" onclick="showMountStickerModal()" style="cursor:pointer;">
                    <div>挂载表情包库</div>
                    <div style="font-size:12px; color:#999;" id="mounted-sticker-count">未挂载</div>
                    <div class="detail-arrow">›</div>
                </div>
            </div>

            <!-- 聊天背景图 -->
            <div class="detail-group">
                <div class="detail-item" style="flex-direction:column; align-items:flex-start;">
                    <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:12px;">
                        <div>聊天背景图</div>
                        <div style="display:flex; gap:8px; align-items:center;">
                            <button onclick="document.getElementById('detail-chat-bg-input').click()" style="padding:6px 12px; background:#f0f0f0; border:none; border-radius:6px; font-size:12px; color:#666; cursor:pointer;">上传</button>
                            <button onclick="clearChatBackground()" style="padding:6px 12px; background:#f0f0f0; border:none; border-radius:6px; font-size:12px; color:#666; cursor:pointer;">清除</button>
                        </div>
                    </div>
                    <div id="detail-chat-bg-preview" style="width:100%; height:120px; border-radius:8px; background:#f5f5f5; background-size:cover; background-position:center; border:1px solid #e8e8e8; display:flex; align-items:center; justify-content:center; color:#999; font-size:12px;">
                        暂无背景图
                    </div>
                </div>
            </div>

            <!-- 视频通话记录 -->
            <div class="detail-group">
                <div class="detail-item" onclick="showVideoCallRecords()" style="cursor:pointer;">
                    <div>视频通话记录</div>
                    <div style="font-size:12px; color:#999;" id="video-call-record-count">0条记录</div>
                    <div class="detail-arrow">›</div>
                </div>
            </div>

            <!-- 自动总结设置 -->
            <div class="detail-group">
                <div class="detail-item">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <div>自动总结</div>
                        <div style="font-size:12px; color:#999; line-height:1.4;">AI自动总结聊天内容到收藏</div>
                    </div>
                    <label class="ios-switch">
                        <input type="checkbox" id="detail-auto-summary-switch" onchange="saveChatDetail()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="detail-item">
                    <div>每多少条总结</div>
                    <input type="number" id="detail-summary-interval" placeholder="50" style="border:none; background:transparent; width:60px; text-align:right; font-size:16px; color:#8e8e93; outline:none;" onchange="saveChatDetail()">
                </div>
                <div class="detail-item" onclick="showChatSummaries('private')" style="cursor:pointer;">
                    <div>查看总结记录</div>
                    <div style="font-size:12px; color:#999;" id="detail-summary-count">0条总结</div>
                    <div class="detail-arrow">›</div>
                </div>
                <div class="detail-item" onclick="triggerManualSummary('private')" style="cursor:pointer;">
                    <div style="color:var(--ins-pink);">立即生成总结</div>
                </div>
                <div style="padding:12px 16px; font-size:12px; color:#999; line-height:1.6; background:#f8f8f8; border-radius:8px; margin:0 16px 12px 16px;">
                    <div style="font-weight:600; color:#666; margin-bottom:6px;">功能说明：</div>
                    <div>• 开启后，每达到设定条数会自动调用API生成总结</div>
                    <div>• 总结内容会保存到个人中心的"收藏"中</div>
                    <div>• 也可以点击"立即生成总结"手动触发</div>
                </div>
            </div>

            <!-- 聊天样式设置（合并气泡预设和自定义样式） -->
            <div class="detail-group">
                <div class="detail-item" style="flex-direction:column; align-items:flex-start; cursor:pointer;" onclick="toggleCustomStyleSection()">
                    <div style="width:100%; display:flex; justify-content:space-between; align-items:center;">
                        <div>聊天样式</div>
                        <span id="custom-style-toggle-icon" class="detail-arrow" style="transition: transform 0.3s;">›</span>
                    </div>
                </div>
                <div id="custom-style-section" style="display:none; padding:16px; background:#f9f9f9; border-radius:8px; margin:0 16px 16px;">
                    <!-- 预设气泡样式 -->
                    <div style="margin-bottom:20px;">
                        <div style="font-size:14px; font-weight:500; margin-bottom:12px; color:#333;">预设样式</div>
                        <div style="display:flex; gap:12px;">
                            <!-- 默认样式 -->
                            <div class="bubble-style-option" data-style="default" onclick="selectBubbleStyle('default')" style="flex:1; padding:12px; border:2px solid #e0e0e0; border-radius:12px; cursor:pointer; transition:all 0.2s; background:#fff;">
                                <div style="font-size:12px; font-weight:500; text-align:center; margin-bottom:8px; color:#333;">默认圆角</div>
                                <div style="display:flex; flex-direction:column; gap:5px; padding:6px; background:#f5f5f5; border-radius:6px;">
                                    <div style="align-self:flex-start; background:#f2f2f7; color:#333; padding:3px 8px; border-radius:12px 12px 12px 4px; font-size:10px;">你好</div>
                                    <div style="align-self:flex-end; background:#ffe4e8; color:#333; padding:3px 8px; border-radius:12px 12px 4px 12px; font-size:10px;">嗨~</div>
                                </div>
                            </div>
                            <!-- 仿微信样式 -->
                            <div class="bubble-style-option" data-style="wechat" onclick="selectBubbleStyle('wechat')" style="flex:1; padding:12px; border:2px solid #e0e0e0; border-radius:12px; cursor:pointer; transition:all 0.2s; background:#fff;">
                                <div style="font-size:12px; font-weight:500; text-align:center; margin-bottom:8px; color:#333;">仿微信</div>
                                <div style="display:flex; flex-direction:column; gap:5px; padding:6px; background:#f5f5f5; border-radius:6px;">
                                    <div style="align-self:flex-start; position:relative; margin-left:4px;">
                                        <div style="position:absolute; left:-3px; top:4px; width:5px; height:5px; background:#fff; border-left:1px solid #e0e0e0; border-bottom:1px solid #e0e0e0; transform:rotate(45deg);"></div>
                                        <div style="background:#fff; color:#333; padding:3px 8px; border-radius:4px; font-size:10px; border:1px solid #e0e0e0;">你好</div>
                                    </div>
                                    <div style="align-self:flex-end; position:relative; margin-right:4px;">
                                        <div style="position:absolute; right:-3px; top:4px; width:5px; height:5px; background:#fff; border-right:1px solid #e0e0e0; border-top:1px solid #e0e0e0; transform:rotate(45deg);"></div>
                                        <div style="background:#fff; color:#333; padding:3px 8px; border-radius:4px; font-size:10px; border:1px solid #e0e0e0;">嗨~</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 分割线 -->
                    <div style="height:1px; background:#e0e0e0; margin:16px 0;"></div>
                    
                    <!-- 自定义样式 -->
                    <div style="margin-bottom:16px;">
                        <div style="font-size:14px; font-weight:500; margin-bottom:8px; color:#333;">自定义样式</div>
                        <div style="font-size:12px; color:#999; margin-bottom:12px;">在预设基础上进一步自定义，或完全自定义样式</div>
                        
                        <!-- 可用类名提示 -->
                        <div style="background:#fff; border:1px solid #e0e0e0; border-radius:8px; padding:10px; margin-bottom:12px;">
                            <div style="font-size:12px; font-weight:600; margin-bottom:6px; color:#333;">📝 可用类名：</div>
                            <div style="font-size:10px; font-family:monospace; color:#666; line-height:1.6; display:flex; flex-wrap:wrap; gap:4px;">
                                <span style="padding:2px 6px; background:#f5f5f5; border-radius:3px;">.ai-bubble</span>
                                <span style="padding:2px 6px; background:#f5f5f5; border-radius:3px;">.user-bubble</span>
                                <span style="padding:2px 6px; background:#f5f5f5; border-radius:3px;">.message-content</span>
                                <span style="padding:2px 6px; background:#f5f5f5; border-radius:3px;">.message-avatar</span>
                                <span style="padding:2px 6px; background:#f5f5f5; border-radius:3px;">.message-row.self</span>
                                <span style="padding:2px 6px; background:#f5f5f5; border-radius:3px;">.message-row.other</span>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom:16px;">
                        <div style="font-size:13px; font-weight:500; margin-bottom:6px; color:#333;">气泡样式 (CSS)</div>
                        <textarea id="detail-bubble-css" placeholder="例如：&#10;background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);&#10;color: white;" style="width:100%; min-height:80px; padding:10px; border:1px solid #ddd; border-radius:8px; font-family:monospace; font-size:11px; resize:vertical; outline:none; box-sizing:border-box;" oninput="saveChatDetail()"></textarea>
                    </div>
                    
                    <div style="margin-bottom:16px;">
                        <div style="font-size:13px; font-weight:500; margin-bottom:6px; color:#333;">自定义容器 (HTML)</div>
                        <textarea id="detail-custom-html" placeholder="显示在聊天顶部的HTML" style="width:100%; min-height:60px; padding:10px; border:1px solid #ddd; border-radius:8px; font-family:monospace; font-size:11px; resize:vertical; outline:none; box-sizing:border-box;" oninput="saveChatDetail()"></textarea>
                    </div>
                    
                    <div style="margin-bottom:16px;">
                        <div style="font-size:13px; font-weight:500; margin-bottom:6px; color:#333;">容器样式 (CSS)</div>
                        <textarea id="detail-custom-css" placeholder="自定义容器的CSS样式" style="width:100%; min-height:60px; padding:10px; border:1px solid #ddd; border-radius:8px; font-family:monospace; font-size:11px; resize:vertical; outline:none; box-sizing:border-box;" oninput="saveChatDetail()"></textarea>
                    </div>
                    
                    <div style="display:flex; gap:10px;">
                        <button onclick="previewCustomStyle()" style="flex:1; padding:10px; background:var(--ins-pink); color:white; border:none; border-radius:8px; font-size:13px; cursor:pointer;">预览效果</button>
                        <button onclick="clearCustomStyle()" style="flex:1; padding:10px; background:#f0f0f0; color:#666; border:none; border-radius:8px; font-size:13px; cursor:pointer;">清除样式</button>
                    </div>
                </div>
            </div>
            
            <div style="padding:20px; text-align:center;">
                <button onclick="clearChatHistory()" style="color:#ff3b30; background:none; border:none; font-size:16px;">清空聊天记录</button>
            </div>
            
            <div style="padding:0 20px 20px; text-align:center;">
                <button onclick="deleteFriendConfirm()" style="color:#ff3b30; background:none; border:none; font-size:16px; font-weight:600;">删除好友</button>
            </div>
            
            <div style="padding:0 20px 20px; text-align:center;">
                <button onclick="blockFriendConfirm()" style="color:#ff3b30; background:none; border:none; font-size:16px; font-weight:600;">拉黑好友</button>
            </div>
        </div>
    </div>

    <!-- 群聊详情页 -->
    <div class="chat-detail-page" id="group-detail-page" style="display:none;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideGroupDetail()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">群聊详情</div>
            <div style="width:40px;"></div>
        </div>
        
        <div style="flex:1; overflow-y:auto;">
            <!-- 群头像与名称 -->
            <div class="detail-avatar-box">
                <div class="detail-avatar" id="group-detail-avatar" onclick="document.getElementById('group-avatar-input').click()" style="border-radius:8px;">
                    <div style="position:absolute; bottom:0; right:0; background:rgba(0,0,0,0.5); color:#fff; font-size:10px; padding:2px 4px; border-radius:4px;">更换</div>
                </div>
                <div style="font-size:12px; color:#999; margin-top:8px;" id="group-member-count">0人</div>
            </div>
            
            <!-- 群名称设置 -->
            <div class="detail-group">
                <div class="detail-item" style="flex-direction:column; align-items:flex-start;">
                    <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <div>群聊名称</div>
                    </div>
                    <input type="text" id="group-detail-name" placeholder="输入群聊名称" style="width:100%; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:15px; box-sizing:border-box;" onchange="saveGroupDetail()">
                </div>
            </div>
            
            <!-- 我在本群的昵称 -->
            <div class="detail-group">
                <div class="detail-item" style="flex-direction:column; align-items:flex-start;">
                    <div style="width:100%; display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <div>我在本群的昵称</div>
                    </div>
                    <input type="text" id="group-detail-nickname" placeholder="输入群昵称（可选）" style="width:100%; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:15px; box-sizing:border-box;" onchange="saveGroupDetail()">
                    <div style="font-size:12px; color:#999; margin-top:6px;">群昵称会在群聊中显示</div>
                </div>
            </div>
            
            <!-- 群成员管理入口 -->
            <div class="detail-group">
                <div class="detail-item" onclick="showGroupMemberManage()" style="cursor:pointer;">
                    <div>群成员管理</div>
                    <div style="display:flex; align-items:center; color:#999; font-size:14px;">
                        <span id="group-member-count-text">0人</span>
                        <span class="detail-arrow">›</span>
                    </div>
                </div>
            </div>
            
            <!-- 群成员预览 -->
            <div class="detail-group">
                <div class="detail-item" style="flex-direction:column; align-items:flex-start;">
                    <div id="group-member-list" style="width:100%; display:flex; flex-wrap:wrap; gap:12px;">
                        <!-- 动态生成成员列表预览 -->
                    </div>
                </div>
            </div>
            
            <!-- 自动总结设置 -->
            <div class="detail-group">
                <div class="detail-item">
                    <div style="display:flex; flex-direction:column; gap:4px;">
                        <div>自动总结</div>
                        <div style="font-size:12px; color:#999; line-height:1.4;">AI自动总结群聊内容到收藏</div>
                    </div>
                    <label class="ios-switch">
                        <input type="checkbox" id="group-detail-auto-summary-switch" onchange="saveGroupDetail()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="detail-item">
                    <div>每多少条总结</div>
                    <input type="number" id="group-detail-summary-interval" placeholder="50" style="border:none; background:transparent; width:60px; text-align:right; font-size:16px; color:#8e8e93; outline:none;" onchange="saveGroupDetail()">
                </div>
                <div class="detail-item" onclick="showChatSummaries('group')" style="cursor:pointer;">
                    <div>查看总结记录</div>
                    <div style="font-size:12px; color:#999;" id="group-detail-summary-count">0条总结</div>
                    <div class="detail-arrow">›</div>
                </div>
                <div class="detail-item" onclick="triggerManualSummary('group')" style="cursor:pointer;">
                    <div style="color:var(--ins-pink);">立即生成总结</div>
                </div>
                <div style="padding:12px 16px; font-size:12px; color:#999; line-height:1.6; background:#f8f8f8; border-radius:8px; margin:0 16px 12px 16px;">
                    <div style="font-weight:600; color:#666; margin-bottom:6px;">功能说明：</div>
                    <div>• 开启后，每达到设定条数会自动调用API生成总结</div>
                    <div>• 总结内容会保存到个人中心的"收藏"中</div>
                    <div>• 也可以点击"立即生成总结"手动触发</div>
                </div>
            </div>

            <!-- 群聊设置 -->
            <div class="detail-group">
                <div class="detail-item">
                    <div>消息免打扰</div>
                    <label class="ios-switch">
                        <input type="checkbox" id="group-detail-mute" onchange="saveGroupDetail()">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="detail-item">
                    <div>置顶聊天</div>
                    <label class="ios-switch">
                        <input type="checkbox" id="group-detail-pin" onchange="saveGroupDetail()">
                        <span class="slider"></span>
                    </label>
                </div>
            </div>
            
            <!-- 清空/退出群聊 -->
            <div class="detail-group">
                <div class="detail-item" onclick="clearGroupChatHistory()" style="cursor:pointer;">
                    <div style="color:#ff3b30;">清空聊天记录</div>
                </div>
                <div class="detail-item" onclick="exitGroup()" style="cursor:pointer;">
                    <div style="color:#ff3b30;">删除并退出</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 群成员管理页面 -->
    <div class="chat-detail-page" id="group-member-manage-page" style="display:none;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideGroupMemberManage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">群成员管理</div>
            <div style="width:40px; display:flex; justify-content:flex-end; align-items:center;">
                <span style="font-size:14px; color:var(--ins-pink); cursor:pointer;" onclick="showAddGroupMemberModal()">邀请</span>
            </div>
        </div>
        
        <div style="flex:1; overflow-y:auto; background:#f5f5f5;">
            <!-- 群主信息 -->
            <div style="background:#fff; margin-bottom:8px;">
                <div style="padding:12px 16px; font-size:13px; color:#999; border-bottom:0.5px solid #f0f0f0;">群主</div>
                <div id="group-owner-info" style="padding:12px 16px;">
                    <!-- 动态生成 -->
                </div>
            </div>
            
            <!-- 管理员列表 -->
            <div style="background:#fff; margin-bottom:8px;">
                <div style="padding:12px 16px; font-size:13px; color:#999; border-bottom:0.5px solid #f0f0f0;">管理员</div>
                <div id="group-admin-list">
                    <!-- 动态生成 -->
                </div>
                <div id="group-no-admin" style="padding:20px 16px; text-align:center; color:#999; font-size:13px; display:none;">暂无管理员</div>
            </div>
            
            <!-- 普通成员列表 -->
            <div style="background:#fff; margin-bottom:8px;">
                <div style="padding:12px 16px; font-size:13px; color:#999; border-bottom:0.5px solid #f0f0f0;">群成员</div>
                <div id="group-normal-member-list">
                    <!-- 动态生成 -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- 成员操作弹窗 -->
    <div class="modal-overlay" id="member-action-modal" style="display:none;">
        <div class="modal-box" style="max-width:320px;">
            <div style="text-align:center; padding:20px 16px;">
                <div id="member-action-avatar" style="width:60px; height:60px; border-radius:8px; background-size:cover; background-position:center; margin:0 auto 12px;"></div>
                <div id="member-action-name" style="font-size:17px; font-weight:600; color:#333; margin-bottom:4px;"></div>
                <div id="member-action-role" style="font-size:12px; color:#999;"></div>
            </div>
            
            <div style="border-top:0.5px solid #f0f0f0;">
                <div id="member-action-set-admin" class="modal-action-item" onclick="setMemberAsAdmin()" style="padding:14px 16px; text-align:center; color:var(--ins-pink); font-size:16px; cursor:pointer; border-bottom:0.5px solid #f0f0f0;">
                    设为管理员
                </div>
                <div id="member-action-remove-admin" class="modal-action-item" onclick="removeMemberAdmin()" style="padding:14px 16px; text-align:center; color:#666; font-size:16px; cursor:pointer; border-bottom:0.5px solid #f0f0f0; display:none;">
                    取消管理员
                </div>
                <div id="member-action-mute" class="modal-action-item" onclick="toggleMemberMute()" style="padding:14px 16px; text-align:center; color:#ff9500; font-size:16px; cursor:pointer; border-bottom:0.5px solid #f0f0f0;">
                    禁言
                </div>
                <div id="member-action-kick" class="modal-action-item" onclick="kickMember()" style="padding:14px 16px; text-align:center; color:#ff3b30; font-size:16px; cursor:pointer; border-bottom:0.5px solid #f0f0f0;">
                    移出群聊
                </div>
            </div>
            
            <div onclick="closeModal('member-action-modal')" style="padding:14px 16px; text-align:center; color:#999; font-size:16px; cursor:pointer; background:#f9f9f9; border-radius:0 0 12px 12px;">
                取消
            </div>
        </div>
    </div>

    <!-- 隐藏的 Input -->
    <input type="file" id="detail-avatar-input" style="display:none;" accept="image/*" onchange="setChatDetailAvatar(this)">
    <input type="file" id="group-avatar-input" style="display:none;" accept="image/*" onchange="setGroupAvatar(this)">
    <input type="file" id="detail-chat-bg-input" style="display:none;" accept="image/*" onchange="setChatBackground(this)">
    <input type="file" id="online-group-bg-input" style="display:none;" accept="image/*" onchange="setOnlineGroupBackground(this)">
    
    <!-- 挂载表情包库弹窗 -->
    <div id="mount-sticker-modal" class="sticker-modal-overlay" style="display:none;">
        <div class="sticker-modal-box" style="max-height:80vh; overflow-y:auto;">
            <h3 style="text-align:center; margin-bottom:20px; font-size:18px; font-weight:600;">挂载表情包库</h3>
            <div style="font-size:13px; color:#666; margin-bottom:16px; text-align:center;">选择要在此聊天中使用的表情包分类</div>
            <div id="mount-sticker-list" style="display:flex; flex-direction:column; gap:8px;">
                <!-- 动态生成 -->
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button onclick="hideMountStickerModal()" style="flex:1; padding:12px; background:#f2f2f7; border:none; border-radius:8px; font-size:15px; font-weight:500;">取消</button>
                <button onclick="saveMountedStickers()" style="flex:1; padding:12px; background:var(--ins-pink); color:#fff; border:none; border-radius:8px; font-size:15px; font-weight:500;">保存</button>
            </div>
        </div>
    </div>

    <!-- 角色档案页面 -->
    <div class="wechat-page" id="character-page" style="background:#fff;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideCharacterPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">角色档案</div>
            <div class="wechat-add" onclick="document.getElementById('character-import').click()" style="width:40px; text-align:right; font-size:16px; color:#666;">导入</div>
        </div>
        
        <div class="wechat-content" id="character-content" style="display:block; padding:16px; padding-bottom: 100px;"> <!-- 底部留空给 Tabbar -->
            <!-- 工具栏 -->
            <div style="display:flex; gap:10px; margin-bottom:16px;">
                <div onclick="createNewCharacter()" style="flex:1; background:#fff; padding:12px; border-radius:10px; text-align:center; color:#333; font-weight:500; border:1px solid #e0e0e0;">+ 新建角色</div>
            </div>
            
            <!-- 列表 -->
            <div id="character-list" style="display:grid; grid-template-columns: repeat(2, 1fr); gap:12px;">
                <!-- 动态生成卡片 -->
            </div>
        </div>

        <!-- 底部切换栏 -->
        <div class="dock" style="position:absolute; bottom:20px; height:60px; border-radius:16px; background:rgba(255,255,255,0.9); width: calc(100% - 32px); left: 50%; transform: translateX(-50%); box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
            <div class="dock-icon" onclick="switchCharacterTab('char')" id="tab-char" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:var(--ins-pink);">
                <span style="font-size:14px; font-weight:bold;">Char</span>
                <span style="font-size:10px;">角色</span>
            </div>
            <div class="dock-icon" onclick="switchCharacterTab('npc')" id="tab-npc" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#999;">
                <span style="font-size:14px; font-weight:bold;">NPC</span>
                <span style="font-size:10px;">路人</span>
            </div>
            <div class="dock-icon" onclick="switchCharacterTab('user')" id="tab-user" style="flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; color:#999;">
                <span style="font-size:14px; font-weight:bold;">User</span>
                <span style="font-size:10px;">玩家</span>
            </div>
        </div>
        
        <!-- 隐藏的导入 Input -->
        <input type="file" id="character-import" style="display:none;" accept=".json,.png" onchange="importCharacterFile(this)">
    </div>

    <!-- 角色编辑页 -->
    <div class="entry-editor-page" id="character-editor-page">
        <div class="wechat-header" style="background:#fff; border-bottom:1px solid #eee;">
            <div class="back-btn" onclick="hideCharacterEditor()" style="margin:0; background:none; font-size:16px; color:var(--ins-gray); width:60px; justify-content:flex-start; padding-left:0;">取消</div>
            <div class="wechat-title" id="char-editor-title">编辑角色</div>
            <div class="wechat-add" onclick="saveCharacter()" style="width:60px; text-align:right; font-size:16px; color:var(--ins-pink); font-weight:600;">保存</div>
        </div>
        
        <div class="editor-form">
            <div style="display:flex; justify-content:center; margin-bottom:20px;">
                <div id="char-avatar-preview" style="width:100px; height:100px; border-radius:50%; background:#f2f2f7; background-size:cover; background-position:center; position:relative; overflow:hidden;" onclick="document.getElementById('char-avatar-input').click()">
                    <div id="char-avatar-placeholder" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; color:#ccc;">点击上传</div>
                </div>
                <input type="file" id="char-avatar-input" style="display:none;" accept="image/*" onchange="setCharAvatar(this)">
            </div>

            <div class="editor-group">
                <label class="editor-label">真名 (Name)</label>
                <input type="text" class="editor-input" id="char-name" placeholder="角色全名">
            </div>
            
            <div class="editor-group">
                <label class="editor-label">昵称 (Nickname)</label>
                <input type="text" class="editor-input" id="char-nick" placeholder="用于显示的短名称">
            </div>

            <div class="editor-group">
                <label class="editor-label">分类</label>
                <select class="editor-input" id="char-type">
                    <option value="char">Char (主要角色)</option>
                    <option value="npc">NPC (路人/功能NPC)</option>
                    <option value="user">User (玩家分身)</option>
                </select>
            </div>
            
            <div class="editor-group">
                <label class="editor-label">人设/描述 (Description)</label>
                <textarea class="editor-textarea" id="char-desc" placeholder="输入角色设定、性格、背景等..." style="height:300px;"></textarea>
            </div>

            <!-- 虚拟身份信息区域 -->
            <div class="editor-group" style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <label class="editor-label" style="margin:0; font-weight:600; color:#333;">虚拟身份信息</label>
                    <button onclick="generateIdentity()" style="background:var(--ins-pink); color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:12px; display:flex; align-items:center; gap:4px;">
                        <span id="gen-btn-text">✨ 生成信息</span>
                        <div class="loading-spinner" id="gen-spinner" style="width:12px; height:12px; border-width:2px; border-color:#fff; border-top-color:transparent;"></div>
                    </button>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                    <div>
                        <label class="editor-label" style="font-size:12px;">虚拟账号</label>
                        <input type="text" class="editor-input" id="char-identity-account" placeholder="Account">
                    </div>
                    <div>
                        <label class="editor-label" style="font-size:12px;">登录密码 (隐藏)</label>
                        <input type="password" class="editor-input" id="char-identity-password" placeholder="Password">
                    </div>
                    <div>
                        <label class="editor-label" style="font-size:12px;">手机号 (7位)</label>
                        <input type="text" class="editor-input" id="char-identity-phone" placeholder="XXXXXXX">
                    </div>
                    <div>
                        <label class="editor-label" style="font-size:12px;">身份证号 (9位)</label>
                        <input type="text" class="editor-input" id="char-identity-id" placeholder="XXXXXXXXX">
                    </div>
                    <div>
                        <label class="editor-label" style="font-size:12px;">银行卡号 (8位)</label>
                        <input type="text" class="editor-input" id="char-identity-bank" placeholder="XXXXXXXX">
                    </div>
                    <div>
                        <label class="editor-label" style="font-size:12px;">银行卡密码 (4位)</label>
                        <input type="password" class="editor-input" id="char-identity-bank-pass" placeholder="XXXX">
                    </div>
                </div>
                <div style="margin-top:10px;">
                    <label class="editor-label" style="font-size:12px;">家庭住址</label>
                    <input type="text" class="editor-input" id="char-identity-address" placeholder="Address">
                </div>
            </div>
            
            <div class="editor-group" style="margin-top:40px;">
                <button onclick="deleteCharacter()" style="width:100%; padding:14px; background:#fff; color:#ff3b30; border:1px solid #ff3b30; border-radius:10px; font-size:16px;">删除角色</button>
            </div>

            <!-- 人际关系网区域 -->
            <div class="editor-group" style="border-top: 1px solid #eee; padding-top: 20px; margin-top: 20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <label class="editor-label" style="margin:0; font-weight:600; color:#333;">人际关系网</label>
                    <button onclick="showNpcGenModal()" style="background:var(--ins-pink); color:#fff; border:none; padding:6px 12px; border-radius:6px; font-size:12px; display:flex; align-items:center; gap:4px;">
                        <span>✨ 批量生成 NPC</span>
                    </button>
                </div>
                <div class="relation-list" id="char-relation-list">
                    <!-- 动态生成 -->
                    <div style="text-align:center; color:#ccc; font-size:12px; padding:10px;">暂无关系记录</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量生成 NPC 弹窗 -->
    <div class="modal-overlay" id="npc-gen-modal">
        <div class="modal-box">
            <div class="modal-title">✨ 批量生成 NPC</div>
            <div style="font-size:12px; color:#666; margin-bottom:10px;">基于当前角色设定和世界书，批量生成相关联的角色。</div>
            
            <div style="margin-bottom:15px;">
                <label style="font-size:14px; display:block; margin-bottom:6px;">生成数量: <span id="gen-count-val" style="color:var(--ins-pink); font-weight:bold;">3</span></label>
                <input type="range" min="1" max="5" value="3" style="width:100%;" oninput="document.getElementById('gen-count-val').innerText = this.value" id="gen-count-range">
            </div>
            
            <div style="margin-bottom:15px;">
                <label style="font-size:14px; display:block; margin-bottom:6px;">剧情要求 (可选)</label>
                <input type="text" class="modal-input" id="gen-prompt-req" placeholder="例如：生成几个反派手下 / 追求者 / 亲戚">
            </div>

            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal('npc-gen-modal')">取消</button>
                <button class="modal-btn btn-confirm" onclick="doGenerateNpcs()" id="btn-do-gen">开始生成</button>
            </div>
        </div>
    </div>

    <!-- 世界书详情页 (词条列表) -->
    <div class="wechat-page" id="lb-detail-page" style="background:#f2f2f7; z-index:155;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideLorebookDetail()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title" id="lb-detail-title">世界书详情</div>
            <div class="wechat-add" onclick="showEntryEditor(currentBookId, null)" style="width:40px; text-align:right; display:flex; align-items:center; justify-content:flex-end;">
                <svg class="svg-icon" style="width:24px; height:24px; stroke:var(--ins-pink);" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
            </div>
        </div>
        
        <div class="lb-editor-container">
            <div class="lb-entry-list" id="lb-entry-list">
                <!-- 动态生成词条 -->
            </div>
        </div>
        
        <!-- 底部操作栏 -->
        <div class="dock" style="position:absolute; bottom:20px; height:60px; border-radius:16px; background:rgba(255,255,255,0.9);">
            <div class="dock-icon" onclick="exportLorebook(currentBookId)" style="flex:1; display:flex; align-items:center; justify-content:center; color:var(--ins-pink);">
                <span style="font-size:16px;">导出 JSON</span>
            </div>
        </div>
    </div>

    <!-- 词条编辑页 -->
    <div class="entry-editor-page" id="lb-entry-page">
        <div class="wechat-header" style="background:#fff; border-bottom:1px solid #eee;">
            <div class="back-btn" onclick="hideEntryEditor()" style="margin:0; background:none; font-size:16px; color:var(--ins-gray); width:60px; justify-content:flex-start; padding-left:0;">取消</div>
            <div class="wechat-title" id="lb-entry-title">编辑词条</div>
            <div class="wechat-add" onclick="saveEntry()" style="width:60px; text-align:right; font-size:16px; color:var(--ins-pink); font-weight:600;">保存</div>
        </div>
        
        <div class="editor-form">
            <div class="editor-group">
                <label class="editor-label">关键字 (用逗号分隔)</label>
                <input type="text" class="editor-input" id="entry-keys" placeholder="例如：Alice, 少女, 金发">
            </div>
            
            <div class="editor-group">
                <label class="editor-label">内容描述</label>
                <textarea class="editor-textarea" id="entry-content" placeholder="输入世界书条目内容..."></textarea>
            </div>
            
            <div class="editor-group" style="margin-top:40px;">
                <button onclick="deleteEntry()" style="width:100%; padding:14px; background:#fff; color:#ff3b30; border:1px solid #ff3b30; border-radius:10px; font-size:16px;">删除此词条</button>
            </div>
        </div>
    </div>

    <!-- 切换账号弹窗 -->
    <div class="modal-overlay" id="switch-account-modal">
        <div class="modal-box" style="max-height:80vh; overflow:hidden; display:flex; flex-direction:column;">
            <div class="modal-title">切换账号</div>
            <div class="account-switch-list" id="account-switch-list" style="flex:1; overflow-y:auto; max-height:300px;">
                <!-- 动态生成 -->
            </div>
            
            <!-- 添加角色账号区域 -->
            <div id="add-role-account-section" style="border-top:1px solid #f0f0f0; padding-top:15px; margin-top:10px;">
                <div style="font-size:14px; color:#666; margin-bottom:10px; text-align:center;">登录角色账号查岗</div>
                <div style="display:flex; gap:8px; margin-bottom:10px;">
                    <input type="text" id="role-login-account" placeholder="角色账号" style="flex:1; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px;">
                    <input type="password" id="role-login-password" placeholder="密码" style="flex:1; padding:10px 12px; border:1px solid #e0e0e0; border-radius:8px; font-size:14px;">
                </div>
                <div id="role-login-error" style="display:none; color:#ff3b30; font-size:12px; text-align:center; margin-bottom:10px;"></div>
                <button class="modal-btn" style="background:var(--ins-pink); color:#fff; margin-bottom:10px;" onclick="loginRoleAccount()">登录并生成数据</button>
            </div>
            
            <button class="modal-btn btn-cancel" onclick="closeModal('switch-account-modal')">取消</button>
        </div>
    </div>

    <!-- 快进时间选择弹窗 -->
    <div class="modal-overlay" id="fast-forward-modal">
        <div class="modal-box" style="width: 80%; max-width: 300px;">
            <div class="modal-title">快进时间</div>
            <div style="font-size:12px; color:#666; margin-bottom:15px; text-align:center;">选择时间流逝长度，AI将根据时间跨度继续对话</div>
            
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <input type="number" id="ff-amount" class="modal-input" placeholder="数值" style="flex:1; margin-bottom:0; text-align:center;" value="1">
                <select id="ff-unit" class="modal-input" style="flex:1; margin-bottom:0;">
                    <option value="minute">分钟</option>
                    <option value="hour" selected>小时</option>
                    <option value="day">天</option>
                </select>
            </div>

            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal('fast-forward-modal')">取消</button>
                <button class="modal-btn btn-confirm" onclick="confirmFastForward()">确认快进</button>
            </div>
        </div>
    </div>

    <!-- 所有隐藏上传Input -->
    <input type="file" id="wallpaper-input" class="custom-input" accept="image/*" onchange="setWallpaper(this)">
    <input type="file" id="custom-icon-input" class="custom-input" accept="image/*" onchange="setCustomIcon(this)">
    <input type="file" id="widget-icon-input" class="custom-input" accept="image/*" onchange="setWidgetIcon(this)">
    <input type="file" id="photo-left-input" class="custom-input" accept="image/*" onchange="setPhoto('left', this)">
    <input type="file" id="photo-right-input" class="custom-input" accept="image/*" onchange="setPhoto('right', this)">

    <!-- 消息上下文菜单 -->
    <div class="context-menu" id="msg-context-menu">
        <div class="context-menu-item" onclick="handleMsgQuote()">
            <span>引用</span>
            <svg class="svg-icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><path d="M21 11.5a8.38 8.38 0 0 1-.9 3.8 8.5 8.5 0 0 1-7.6 4.7 8.38 8.38 0 0 1-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 0 1-.9-3.8 8.5 8.5 0 0 1 4.7-7.6 8.38 8.38 0 0 1 3.8-.9h.5a8.48 8.48 0 0 1 8 8v.5z"></path></svg>
        </div>
        <div class="context-menu-item" onclick="handleMsgEdit()">
            <span>编辑</span>
            <svg class="svg-icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        </div>
        <div class="context-menu-item" onclick="handleMsgRecall()">
            <span>撤回</span>
            <svg class="svg-icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>
        </div>
        <div class="context-menu-item" onclick="handleMsgDelete()">
            <span>删除</span>
            <svg class="svg-icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
        </div>
        <div class="context-menu-item" onclick="enterSelectionMode()">
            <span>多选</span>
            <svg class="svg-icon" style="width:16px; height:16px;" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
        </div>
    </div>

    <!-- 底部多选操作栏 -->
    <div class="selection-bar" id="selection-bar">
        <div class="selection-btn btn-delete-all" id="btn-batch-delete" onclick="deleteSelectedMsgs()">删除 (0)</div>
        <div class="selection-btn btn-cancel-sel" onclick="exitSelectionMode()">取消</div>
    </div>
    
    <!-- 全屏遮罩，用于点击外部关闭菜单 -->
    <div id="menu-overlay" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9998; display:none;" onclick="hideContextMenu()"></div>

    <!-- 强力保活音频元素 -->
    <audio id="keepalive-audio" loop preload="auto" style="display:none;">
        <source src="https://img.heliar.top/file/1769349484835_静音.aac" type="audio/aac">
    </audio>

    <!-- 服务页面 -->
    <div class="wechat-page service-sub-page" id="service-main-page">
        <div class="svc-nav-bar">
            <div class="back-btn" onclick="hideServicePage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text); position:static;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div style="flex:1;">服务 <span style="font-size: 14px; color: #ccc; margin-left: 4px;">Services</span></div>
            <div style="width:40px;"></div>
        </div>

        <div class="svc-container">
            <!-- 核心卡片 -->
            <div class="header-card">
                <div class="header-item">
                    <svg class="icon-lg" viewBox="0 0 24 24">
                        <rect x="4" y="4" width="16" height="16" rx="2" ry="2"></rect>
                        <path d="M12 7v10m-5-5h10"></path>
                    </svg>
                    <div class="item-title">收付款</div>
                    <!-- 移除金额显示 -->
                </div>

                <div class="divider-vertical"></div>

                <!-- 点击这里跳转到钱包页 -->
                <div class="header-item" onclick="showWalletPage()">
                    <svg class="icon-lg" viewBox="0 0 24 24">
                        <path d="M20 7h-3a2 2 0 0 1-2-2V3"></path>
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <path d="M3 9h18"></path>
                    </svg>
                    <div class="item-title">钱包</div>
                    <!-- 移除金额显示 -->
                </div>
            </div>

            <!-- 服务九宫格 -->
            <div class="section-title">金融服务 FINANCE</div>
            <div class="grid-card" style="margin-bottom: 24px;">
                <div class="grid-item">
                    <div class="icon-box"><svg class="service-icon" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg></div>
                    <div class="grid-text">信用卡</div>
                </div>
                <div class="grid-item">
                    <div class="icon-box"><svg class="service-icon" viewBox="0 0 24 24"><path d="M22 17a3 3 0 0 0-3-3h-1.66V8.2a2.8 2.8 0 0 0-2.8-2.8H9.46A2.8 2.8 0 0 0 6.66 8.2V14H5a3 3 0 0 0-3 3v3h20Z"/></svg></div>
                    <div class="grid-text">理财通</div>
                </div>
                <div class="grid-item">
                    <div class="icon-box"><svg class="service-icon" viewBox="0 0 24 24"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></div>
                    <div class="grid-text">借钱</div>
                </div>
            </div>

            <div class="section-title">生活服务 UTILITIES</div>
            <div class="grid-card">
                <div class="grid-item" onclick="showPhoneRechargePage()">
                    <div class="icon-box"><svg class="service-icon" viewBox="0 0 24 24"><path d="M5 12h14M12 5v14"/></svg></div>
                    <div class="grid-text">手机充值</div>
                </div>
                <div class="grid-item">
                    <div class="icon-box"><svg class="service-icon" viewBox="0 0 24 24"><path d="M12 2.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-1 0V3a.5.5 0 0 1 .5-.5zM12 18a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" /><path d="M12 10v4"/></svg></div>
                    <div class="grid-text">生活缴费</div>
                </div>
                <div class="grid-item">
                    <div class="icon-box"><svg class="service-icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="3"/></svg></div>
                    <div class="grid-text">公益</div>
                </div>
                <div class="grid-item">
                    <div class="icon-box"><svg class="service-icon" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/></svg></div>
                    <div class="grid-text">其他</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 手机充值页面 -->
    <div class="wechat-page service-sub-page" id="phone-recharge-page" style="display:none;">
        <div class="svc-nav-bar">
            <div class="back-btn" onclick="hidePhoneRechargePage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text); position:static;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div style="flex:1;">手机充值</div>
            <div style="width:40px;"></div>
        </div>

        <div class="svc-container" style="padding-top:20px;">
            <!-- 手机号显示 -->
            <div style="background:#fff; border-radius:12px; padding:24px; margin-bottom:16px;">
                <div style="font-size:14px; color:#999; margin-bottom:8px;">手机号码</div>
                <div id="recharge-phone-number" style="font-size:24px; font-weight:600; color:#333;">加载中...</div>
            </div>

            <!-- 余额显示 -->
            <div style="background:#fff; border-radius:12px; padding:24px; margin-bottom:16px;">
                <div style="font-size:14px; color:#999; margin-bottom:8px;">当前余额</div>
                <div style="display:flex; align-items:baseline; justify-content:space-between;">
                    <div id="recharge-balance" style="font-size:32px; font-weight:600; color:#07c160;">¥0.00</div>
                    <div style="font-size:12px; color:#999;">每条短信 ¥0.10</div>
                </div>
            </div>

            <!-- 充值金额选择 -->
            <div style="background:#fff; border-radius:12px; padding:20px; margin-bottom:16px;">
                <div style="font-size:16px; font-weight:600; color:#333; margin-bottom:16px;">选择充值金额</div>
                <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">
                    <div class="recharge-amount-btn" data-amount="10" onclick="selectRechargeAmount(10)">¥10</div>
                    <div class="recharge-amount-btn" data-amount="20" onclick="selectRechargeAmount(20)">¥20</div>
                    <div class="recharge-amount-btn" data-amount="50" onclick="selectRechargeAmount(50)">¥50</div>
                    <div class="recharge-amount-btn" data-amount="100" onclick="selectRechargeAmount(100)">¥100</div>
                    <div class="recharge-amount-btn" data-amount="200" onclick="selectRechargeAmount(200)">¥200</div>
                    <div class="recharge-amount-btn" data-amount="500" onclick="selectRechargeAmount(500)">¥500</div>
                </div>
            </div>

            <!-- 充值按钮 -->
            <button id="recharge-submit-btn" onclick="submitRecharge()" style="width:100%; padding:16px; background:#07c160; color:#fff; border:none; border-radius:12px; font-size:18px; font-weight:600; cursor:pointer; margin-bottom:16px; opacity:0.5; cursor:not-allowed;" disabled>
                请选择充值金额
            </button>

            <!-- 充值记录 -->
            <div style="background:#fff; border-radius:12px; padding:20px;">
                <div style="font-size:16px; font-weight:600; color:#333; margin-bottom:16px;">充值记录</div>
                <div id="recharge-history" style="font-size:14px; color:#999;">暂无充值记录</div>
            </div>
        </div>
    </div>

    <!-- 朋友圈页面 -->
    <div class="wechat-page" id="moments-page" style="background:#ffffff; overflow-y:auto; display:none;">
        <!-- 沉浸式导航栏 -->
        <div class="moments-nav-bar" id="moments-nav-bar">
            <div class="back-btn" onclick="hideMomentsPage()" style="background:none; color:#fff; width:32px; height:32px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:24px; height:24px; stroke-width:2.5;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="moments-nav-title" id="moments-nav-title" style="opacity:0;">朋友圈</div>
            <div class="moments-camera-btn" onclick="showMomentsPublish()">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:24px; height:24px; stroke:#fff; fill:none;"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </div>
        </div>

        <!-- 封面区域 -->
        <div class="moments-cover-area" id="moments-cover-area" onclick="changeMomentsCover()">
            <div class="moments-user-info">
                <div class="moments-user-name" id="moments-user-name">User</div>
                <div class="moments-user-avatar" id="moments-user-avatar"></div>
            </div>
        </div>

        <!-- 内容列表 -->
        <div class="moments-list" id="moments-list">
            <!-- 动态生成 -->
            <div class="wechat-empty-state" style="margin-top:60px;">
                <div style="color:#999; font-size:14px;">加载中...</div>
            </div>
        </div>
        
        <!-- 隐藏的封面上传 Input -->
        <input type="file" id="moments-cover-input" style="display:none;" accept="image/*" onchange="handleCoverChange(this)">
    </div>

    <!-- 我的朋友圈页面 -->
    <div class="wechat-page" id="my-moments-page" style="background:#ffffff; overflow-y:auto; display:none; z-index:205;">
        <!-- 导航栏 -->
        <div class="moments-nav-bar" style="position:fixed; opacity:1;">
            <div class="back-btn" onclick="hideMyMomentsPage()" style="background:none; color:#fff; width:32px; height:32px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:24px; height:24px; stroke-width:2.5;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="moments-nav-title" style="opacity:1;">我的朋友圈</div>
            <div class="moments-camera-btn" onclick="showMomentsPublish()">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:24px; height:24px; stroke:#fff; fill:none;"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path><circle cx="12" cy="13" r="4"></circle></svg>
            </div>
        </div>

        <!-- 封面区域 -->
        <div class="moments-cover-area" id="my-moments-cover" style="cursor:default;">
            <div class="moments-user-info">
                <div class="moments-user-name" id="my-moments-name">User</div>
                <div class="moments-user-avatar" id="my-moments-avatar"></div>
            </div>
        </div>

        <!-- 置顶区域 -->
        <div id="my-moments-pinned-section" class="moments-pinned-section">
            <div class="moments-pinned-label">置顶</div>
            <div class="moments-pinned-scroll">
                <div id="my-moments-pinned-list" class="moments-pinned-list">
                    <!-- 置顶的朋友圈卡片 -->
                </div>
                <div class="moments-pinned-arrow">›</div>
            </div>
        </div>

        <!-- 普通内容列表 -->
        <div class="moments-list" id="my-moments-list">
            <div class="wechat-empty-state" style="margin-top:60px;">
                <div style="color:#999; font-size:14px;">加载中...</div>
            </div>
        </div>
    </div>

    <!-- 所有置顶朋友圈页面 -->
    <div class="wechat-page" id="all-pinned-moments-page" style="display:none; z-index:205;">
        <div class="wechat-header">
            <div class="back-btn" onclick="hideAllPinnedMoments()" style="margin:0; background:none; font-size:16px; color:#333; width:60px;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:24px; height:24px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">置顶</div>
            <div style="width:60px;"></div>
        </div>
        <div class="moments-list" id="all-pinned-list" style="padding-top:60px;">
        </div>
    </div>

    <!-- 朋友圈详情页面 -->
    <div class="wechat-page" id="moment-detail-page" style="background:#f5f5f5; display:none; z-index:206;">
        <div class="wechat-header" style="background:#fff;">
            <div class="back-btn" onclick="hideMomentDetail()">
                <svg class="svg-icon" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="header-title">朋友圈详情</div>
        </div>
        
        <div style="padding:16px; display:flex; flex-direction:column; gap:12px;">
            <!-- 朋友圈内容预览 -->
            <div id="moment-detail-content" style="background:#fff; padding:16px; border-radius:8px;">
                <!-- 动态生成 -->
            </div>
            
            <!-- 操作选项 -->
            <div style="background:#fff; border-radius:8px; overflow:hidden;">
                <div class="wechat-cell" onclick="toggleMomentPin()" style="border-bottom:1px solid #f0f0f0;">
                    <div class="wechat-cell-text" id="moment-pin-text">置顶</div>
                    <div class="wechat-cell-arrow">
                        <label class="ios-switch">
                            <input type="checkbox" id="moment-pin-switch">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="wechat-cell" onclick="showMomentPrivacyOptions()">
                    <div class="wechat-cell-text">谁可以看</div>
                    <div class="wechat-cell-arrow" style="color:#999; font-size:14px; display:flex; align-items:center; gap:4px;">
                        <span id="moment-privacy-text">公开</span>
                        <svg class="svg-icon" viewBox="0 0 24 24" style="width:16px;height:16px;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                    </div>
                </div>
            </div>
            
            <!-- 删除按钮 -->
            <button onclick="deleteMomentFromDetail()" style="width:100%; padding:14px; background:#fff; color:#ff3b30; border:none; border-radius:8px; font-size:16px;">
                删除这条朋友圈
            </button>
        </div>
    </div>

    <!-- 朋友圈发布页面 -->
    <div class="wechat-page" id="moments-publish-page" style="background:#fff; z-index:210;">
        <div class="wechat-header" style="background:#fff; border-bottom:none;">
            <div class="back-btn" onclick="hideMomentsPublish()" style="margin:0; background:none; font-size:16px; color:#333; width:60px; justify-content:flex-start; padding-left:0;">取消</div>
            <div class="wechat-add" onclick="doPublishMoment()" style="width:60px; justify-content:flex-end;">
                <button style="background:var(--ins-pink); color:#fff; border:none; padding:6px 12px; border-radius:4px; font-size:14px; font-weight:600;">发表</button>
            </div>
        </div>
        
        <div style="padding:20px;">
            <textarea id="moments-pub-text" placeholder="这一刻的想法..." style="width:100%; height:120px; border:none; outline:none; font-size:16px; resize:none; line-height:1.5;"></textarea>
            
            <!-- 图片上传网格 -->
            <div class="moments-pub-grid" id="moments-pub-grid">
                <div class="moments-add-btn" onclick="document.getElementById('moments-pub-file').click()">
                    <svg class="svg-icon" style="width:24px; height:24px; stroke:#ccc;" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                </div>
            </div>
            <input type="file" id="moments-pub-file" style="display:none;" accept="image/*" multiple onchange="handlePubImages(this)">
            
            <div style="margin-top:30px; border-top:1px solid #f0f0f0; padding-top:16px;">
                <div class="wechat-cell" style="padding:12px 0; border:none;">
                    <div class="wechat-cell-icon" style="margin-right:10px;">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px;"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                    </div>
                    <div class="wechat-cell-text">所在位置</div>
                    <div class="wechat-cell-arrow">›</div>
                </div>
                <div class="wechat-cell" style="padding:12px 0; border:none;" onclick="showPrivacySelector()">
                    <div class="wechat-cell-icon" style="margin-right:10px;">
                        <svg class="svg-icon" viewBox="0 0 24 24" style="width:20px; height:20px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <div class="wechat-cell-text">谁可以看</div>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span id="privacy-selected-text" style="font-size:14px; color:#999;">公开</span>
                        <div class="wechat-cell-arrow">›</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 朋友圈权限选择页面 -->
    <div class="wechat-page" id="privacy-selector-page" style="display:none; z-index:220;">
        <div class="wechat-header">
            <div class="back-btn" onclick="hidePrivacySelector()" style="margin:0; background:none; font-size:16px; color:#333; width:60px;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:24px; height:24px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">谁可以看</div>
            <div style="width:60px;"></div>
        </div>
        <div style="padding-top:60px;">
            <div class="privacy-option" data-value="public" onclick="selectPrivacy('public', '公开')">
                <div class="privacy-option-content">
                    <div class="privacy-option-title">公开</div>
                    <div class="privacy-option-desc">所有朋友可见</div>
                </div>
                <div class="privacy-option-check" id="privacy-check-public">✓</div>
            </div>
            <div class="privacy-option" data-value="private" onclick="selectPrivacy('private', '私密')">
                <div class="privacy-option-content">
                    <div class="privacy-option-title">私密</div>
                    <div class="privacy-option-desc">仅自己可见</div>
                </div>
                <div class="privacy-option-check" id="privacy-check-private"></div>
            </div>
            <div class="privacy-option" data-value="partial" onclick="showFriendSelector('partial')">
                <div class="privacy-option-content">
                    <div class="privacy-option-title">部分可见</div>
                    <div class="privacy-option-desc" id="partial-desc">选中的朋友可见</div>
                </div>
                <div class="wechat-cell-arrow">›</div>
            </div>
            <div class="privacy-option" data-value="exclude" onclick="showFriendSelector('exclude')">
                <div class="privacy-option-content">
                    <div class="privacy-option-title">不给谁看</div>
                    <div class="privacy-option-desc" id="exclude-desc">选中的朋友不可见</div>
                </div>
                <div class="wechat-cell-arrow">›</div>
            </div>
        </div>
    </div>

    <!-- 好友选择页面 -->
    <div class="wechat-page" id="friend-selector-page" style="display:none; z-index:230;">
        <div class="wechat-header">
            <div class="back-btn" onclick="hideFriendSelector()" style="margin:0; background:none; font-size:16px; color:#333; width:60px;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:24px; height:24px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title" id="friend-selector-title">选择好友</div>
            <div class="wechat-add" onclick="confirmFriendSelection()" style="width:60px; justify-content:flex-end;">
                <span style="color:#07c160; font-size:16px; font-weight:600;">完成</span>
            </div>
        </div>
        <div style="padding:60px 0 20px;">
            <div style="padding:12px 16px; background:#f8f8f8; font-size:12px; color:#999;">选择好友</div>
            <div id="friend-selector-list" style="background:#fff;">
                <!-- 好友列表 -->
            </div>
        </div>
    </div>

    <!-- 钱包详情页 -->
    <div class="sub-page-container service-sub-page" id="wallet-page">
        <div class="wallet-nav">
            <div class="back-btn" onclick="hideWalletPage()">
                <svg width="24" height="24" fill="none" stroke="#333" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div style="font-size: 17px; font-weight: 600;">钱包</div>
            <div style="font-size: 14px; cursor: pointer;" onclick="showBillPage()">账单</div>
        </div>

        <div class="list-group">
            <div class="list-item" onclick="showBalancePage()">
                <div class="item-icon-box"><svg class="item-icon-svg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="9"/><path d="M9 8l3 4.5L15 8"/><path d="M12 12.5v7"/><path d="M9 16h6"/></svg></div>
                <span class="item-title">零钱</span>
                <div class="item-right">
                    <span style="font-weight:600; font-size:16px;">¥0.00</span>
                    <svg width="14" height="14" stroke="#ccc" stroke-width="2" fill="none" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
                </div>
            </div>

            <div class="list-item">
                <div class="item-icon-box"><svg class="item-icon-svg" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><path d="M9 22V12h6v10"/></svg></div>
                <span class="item-title">经营账户</span>
                <div class="item-right"><svg width="14" height="14" stroke="#ccc" stroke-width="2" fill="none" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></div>
            </div>

            <div class="list-item">
                <div class="item-icon-box"><svg class="item-icon-svg" viewBox="0 0 24 24"><path d="M6 3h12l4 6-10 13L2 9z"/></svg></div>
                <div style="display:flex; flex-direction:column;">
                    <span class="item-title" style="display:flex; align-items:center;">零钱通 <span class="item-tag">随时支付，并享收益</span></span>
                </div>
                <div class="item-right"><svg width="14" height="14" stroke="#ccc" stroke-width="2" fill="none" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></div>
            </div>

            <div class="list-item">
                <div class="item-icon-box"><svg class="item-icon-svg" viewBox="0 0 24 24"><rect x="2" y="5" width="20" height="14" rx="2" /><line x1="2" y1="10" x2="22" y2="10" /></svg></div>
                <span class="item-title">银行卡</span>
                <div class="item-right"><svg width="14" height="14" stroke="#ccc" stroke-width="2" fill="none" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></div>
            </div>

            <div class="list-item" onclick="showFamilyCardPage()">
                <div class="item-icon-box"><svg class="item-icon-svg" viewBox="0 0 24 24"><path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/></svg></div>
                <span class="item-title">亲属卡</span>
                <div class="item-right"><svg width="14" height="14" stroke="#ccc" stroke-width="2" fill="none" viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg></div>
            </div>
        </div>

        <div style="text-align:center; margin-top:40px; color:#7b8fa3; font-size:13px;">
            <span>身份信息</span>
            <span style="margin:0 10px; color:#ddd">|</span>
            <span>支付设置</span>
        </div>
    </div>

    <!-- 零钱页面 -->
    <div class="sub-page-container service-sub-page" id="balance-page">
        <div class="wallet-nav" style="background:rgba(255,251,252,0.95); backdrop-filter:blur(10px);">
            <div class="back-btn" onclick="hideBalancePage()">
                <svg width="24" height="24" fill="none" stroke="#333" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div style="font-size: 17px; font-weight: 600;">零钱</div>
            <div style="font-size: 14px;">零钱明细</div>
        </div>

        <div class="balance-header">
            <svg class="balance-icon-large" viewBox="0 0 24 24">
                <circle cx="12" cy="12" r="10"></circle>
                <path d="M12 8v8"></path>
                <path d="M8 12h8"></path>
            </svg>
            <div class="balance-label">我的零钱</div>
            <div class="balance-amount" id="balance-amount-display">¥0.00</div>
        </div>

        <div class="balance-action-area">
            <div class="balance-btn btn-recharge">充值</div>
            <div class="balance-btn btn-withdraw">提现</div>
            
            <button class="balance-btn btn-generate" onclick="generateUserBalance()">
                <svg class="svg-icon" style="width:20px;height:20px;" viewBox="0 0 24 24"><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path><line x1="21" y1="2" x2="12" y2="11"></line></svg>
                <span>AI生成余额</span>
            </button>
            <div style="text-align:center; font-size:12px; color:#ccc; margin-top:-8px;">基于当前User人设生成</div>
        </div>

        <div class="balance-footer-link">常见问题</div>
    </div>

    <!-- 转账输入页面 -->
    <div class="transfer-modal" id="transfer-page">
        <div class="transfer-page-header">
            <div class="back-btn" onclick="hideTransferPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="transfer-page-title">转账</div>
            <div style="width:40px;"></div>
        </div>
        
        <div class="transfer-content">
            <div class="transfer-avatar" id="t-target-avatar"></div>
            <div class="transfer-target-name" id="t-target-name">Target Name</div>
            
            <div class="transfer-input-box">
                <div class="t-input-label">转账金额</div>
                <div class="t-input-row">
                    <span class="t-currency">¥</span>
                    <input type="number" class="t-input" id="t-amount-input" placeholder="0.00" oninput="checkTransferAmount(this)">
                </div>
                <div style="height:1px; background:#f0f0f0; width:100%; margin:10px 0;"></div>
                <div class="t-input-label" style="font-size:13px; margin-bottom:4px;">添加备注</div>
                <input type="text" class="t-note-input" id="t-note-input" placeholder="最多20字">
            </div>
            
            <button class="t-btn-confirm" id="btn-do-transfer" onclick="doTransfer()" disabled>转账</button>
        </div>
    </div>

    <!-- 群聊转账类型选择弹窗 - INS风格 -->
    <div class="modal-overlay" id="group-transfer-type-modal" style="display:none;">
        <div class="modal-box" style="max-width:300px; padding:0; overflow:hidden; border-radius:16px;">
            <div style="padding:20px 16px; text-align:center; border-bottom:0.5px solid #f0f0f0;">
                <div style="font-size:17px; font-weight:600; color:#333;">选择类型</div>
            </div>
            <div style="padding:16px;">
                <div onclick="showGroupRedPacketPage()" style="display:flex; align-items:center; padding:14px 16px; background:#fafafa; border-radius:12px; margin-bottom:12px; cursor:pointer; transition:all 0.2s; border:1px solid #f0f0f0;">
                    <div style="width:44px; height:44px; border-radius:12px; background:#fff; border:1px solid #eee; display:flex; align-items:center; justify-content:center; margin-right:14px;">
                        <svg viewBox="0 0 24 24" style="width:22px; height:22px; stroke:var(--ins-pink); fill:none; stroke-width:1.5;"><rect x="3" y="4" width="18" height="16" rx="2"/><path d="M3 10h18"/><circle cx="12" cy="15" r="2"/></svg>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:15px; font-weight:500; color:#333;">群红包</div>
                        <div style="font-size:12px; color:#999; margin-top:2px;">拼手气或普通红包</div>
                    </div>
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; stroke:#ccc; fill:none;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
                <div onclick="showExclusiveTransferPage()" style="display:flex; align-items:center; padding:14px 16px; background:#fafafa; border-radius:12px; cursor:pointer; transition:all 0.2s; border:1px solid #f0f0f0;">
                    <div style="width:44px; height:44px; border-radius:12px; background:#fff; border:1px solid #eee; display:flex; align-items:center; justify-content:center; margin-right:14px;">
                        <svg viewBox="0 0 24 24" style="width:22px; height:22px; stroke:var(--ins-pink); fill:none; stroke-width:1.5;"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                    </div>
                    <div style="flex:1;">
                        <div style="font-size:15px; font-weight:500; color:#333;">专属转账</div>
                        <div style="font-size:12px; color:#999; margin-top:2px;">转给指定群成员</div>
                    </div>
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; stroke:#ccc; fill:none;"><polyline points="9 18 15 12 9 6"></polyline></svg>
                </div>
            </div>
            <div onclick="closeModal('group-transfer-type-modal')" style="padding:14px 16px; text-align:center; border-top:0.5px solid #f0f0f0; color:#999; font-size:15px; cursor:pointer;">取消</div>
        </div>
    </div>

    <!-- 群红包页面 - INS风格 -->
    <div class="transfer-modal" id="group-redpacket-page" style="display:none;">
        <div class="transfer-page-header" style="background:#fff; border-bottom:0.5px solid #f0f0f0;">
            <div class="back-btn" onclick="hideGroupRedPacketPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:#333;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="transfer-page-title" style="color:#333;">发红包</div>
            <div style="width:40px;"></div>
        </div>
        
        <div style="flex:1; background:#fff; padding:16px;">
            <!-- 红包类型选择 -->
            <div style="background:#fff; border-radius:12px; padding:16px; margin-bottom:12px; border:1px solid #eee;">
                <div style="font-size:13px; color:#999; margin-bottom:12px;">红包类型</div>
                <div style="display:flex; gap:12px;">
                    <div id="rp-type-lucky" onclick="selectRedPacketType('lucky')" style="flex:1; padding:12px; border:1.5px solid #333; border-radius:10px; text-align:center; cursor:pointer; background:#fff;">
                        <div style="font-size:14px; font-weight:500; color:#333;">拼手气红包</div>
                        <div style="font-size:11px; color:#999; margin-top:4px;">金额随机</div>
                    </div>
                    <div id="rp-type-normal" onclick="selectRedPacketType('normal')" style="flex:1; padding:12px; border:1.5px solid #e8e8e8; border-radius:10px; text-align:center; cursor:pointer; background:#fff;">
                        <div style="font-size:14px; font-weight:500; color:#666;">普通红包</div>
                        <div style="font-size:11px; color:#999; margin-top:4px;">金额相同</div>
                    </div>
                </div>
            </div>
            
            <!-- 红包金额 -->
            <div style="background:#fff; border-radius:12px; padding:16px; margin-bottom:12px; border:1px solid #eee;">
                <div style="display:flex; align-items:center; border-bottom:1px solid #f0f0f0; padding-bottom:14px; margin-bottom:14px;">
                    <div style="font-size:14px; color:#999; width:70px;">总金额</div>
                    <div style="flex:1; display:flex; align-items:center;">
                        <span style="font-size:18px; color:#333; margin-right:4px;">¥</span>
                        <input type="number" id="rp-amount-input" placeholder="0.00" style="flex:1; border:none; font-size:22px; font-weight:500; outline:none; color:#333;" oninput="checkRedPacketInput()">
                    </div>
                </div>
                <div style="display:flex; align-items:center;">
                    <div style="font-size:14px; color:#999; width:70px;">红包个数</div>
                    <div style="flex:1; display:flex; align-items:center;">
                        <input type="number" id="rp-count-input" placeholder="1" min="1" style="flex:1; border:none; font-size:16px; outline:none; color:#333;" oninput="checkRedPacketInput()">
                        <span style="font-size:13px; color:#999;">个</span>
                    </div>
                </div>
            </div>
            
            <!-- 祝福语 -->
            <div style="background:#fff; border-radius:12px; padding:14px 16px; margin-bottom:24px; border:1px solid #eee;">
                <input type="text" id="rp-wish-input" placeholder="祝福语（选填）" maxlength="20" style="width:100%; border:none; font-size:14px; outline:none; box-sizing:border-box; color:#333;">
            </div>
            
            <!-- 金额提示 -->
            <div style="text-align:center; margin-bottom:20px;">
                <span style="font-size:13px; color:#999;" id="rp-total-hint">共0.00元</span>
            </div>
            
            <!-- 发送按钮 -->
            <button id="btn-send-redpacket" onclick="sendGroupRedPacket()" disabled style="width:100%; padding:14px; background:#ccc; color:#fff; border:none; border-radius:24px; font-size:16px; font-weight:500; cursor:not-allowed; transition:all 0.2s;">
                发红包
            </button>
        </div>
    </div>

    <!-- 红包详情页面 -->
    <div class="transfer-modal" id="redpacket-detail-page" style="display:none;">
        <div class="transfer-page-header" style="background:#fff; border-bottom:0.5px solid #f0f0f0;">
            <div class="back-btn" onclick="hideRedPacketDetail()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:#333;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="transfer-page-title" style="color:#333;">红包详情</div>
            <div style="width:40px;"></div>
        </div>
        
        <div style="flex:1; background:#fff; overflow-y:auto;">
            <!-- 红包信息头部 -->
            <div style="padding:30px 20px; text-align:center; border-bottom:1px solid #f0f0f0;">
                <div id="rp-detail-avatar" style="width:60px; height:60px; border-radius:50%; background:#eee; margin:0 auto 12px; background-size:cover; background-position:center;"></div>
                <div id="rp-detail-sender" style="font-size:15px; color:#333; margin-bottom:8px;">发送者</div>
                <div id="rp-detail-wish" style="font-size:18px; font-weight:500; color:#333; margin-bottom:6px;">恭喜发财</div>
                <div id="rp-detail-type" style="font-size:13px; color:#999;">拼手气红包</div>
            </div>
            
            <!-- 领取按钮区域 -->
            <div id="rp-detail-action" style="padding:20px; border-bottom:1px solid #f0f0f0;">
                <button id="btn-claim-redpacket" onclick="claimRedPacket()" style="width:100%; padding:14px; background:#333; color:#fff; border:none; border-radius:24px; font-size:16px; font-weight:500; cursor:pointer;">
                    领取红包
                </button>
            </div>
            
            <!-- 已领取列表 -->
            <div style="padding:16px 20px;">
                <div style="font-size:13px; color:#999; margin-bottom:12px;">
                    <span id="rp-detail-claimed-count">0</span>/<span id="rp-detail-total-count">0</span> 已领取，共 <span id="rp-detail-total-amount">0.00</span> 元
                </div>
                <div id="rp-detail-claimed-list">
                    <!-- 动态生成已领取成员列表 -->
                </div>
            </div>
        </div>
    </div>

    <!-- 专属转账选人弹窗 -->
    <div class="modal-overlay" id="exclusive-transfer-modal" style="display:none;">
        <div class="modal-box" style="max-width:340px; max-height:70vh; padding:0; display:flex; flex-direction:column;">
            <div style="padding:16px; border-bottom:0.5px solid #f0f0f0; display:flex; align-items:center; justify-content:space-between;">
                <div style="font-size:17px; font-weight:600; color:#333;">选择转账对象</div>
                <div onclick="closeModal('exclusive-transfer-modal')" style="font-size:24px; color:#999; cursor:pointer; line-height:1;">×</div>
            </div>
            <div id="exclusive-member-list" style="flex:1; overflow-y:auto; padding:8px 0;">
                <!-- 动态生成群成员列表 -->
            </div>
        </div>
    </div>

    <!-- 位置输入弹窗 -->
    <div class="location-modal-overlay" id="location-modal">
        <div class="location-popup">
            <div class="location-popup-header">
                <span>发送位置</span>
                <div class="location-close-btn" onclick="hideLocationModal()">×</div>
            </div>
            <div class="location-popup-body">
                <input type="text" class="location-popup-input" id="location-name-input" placeholder="位置名称">
                <input type="text" class="location-popup-input" id="location-address-input" placeholder="详细地址（选填）">
            </div>
            <div class="location-popup-footer">
                <button class="location-popup-btn cancel" onclick="hideLocationModal()">取消</button>
                <button class="location-popup-btn confirm" onclick="sendLocationMessage()">发送</button>
            </div>
        </div>
    </div>

    <!-- 收款确认弹窗 -->
    <div class="confirm-modal-overlay" id="transfer-confirm-modal">
        <div class="confirm-box">
            <div style="font-size:18px; font-weight:600; margin-bottom:8px; color:#333;">确认收款</div>
            <div style="font-size:14px; color:#666; margin-bottom:24px;" id="t-confirm-desc">收到转账 ¥0.00</div>
            <div style="display:flex; gap:12px;">
                <button onclick="handleTransferAction('reject')" style="flex:1; padding:12px; background:#f5f5f5; color:#666; border:none; border-radius:10px; font-weight:600;">退回</button>
                <button onclick="handleTransferAction('accept')" style="flex:1; padding:12px; background:#ffc2d1; color:#fff; border:none; border-radius:10px; font-weight:600;">收款</button>
            </div>
        </div>
    </div>

    <!-- 账单页面 -->
    <div class="sub-page-container" id="bill-page" style="display:none;">
        <div class="wallet-nav" style="background:#fff;">
            <div class="back-btn" onclick="hideBillPage()">
                <svg width="24" height="24" fill="none" stroke="#333" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div style="font-size: 17px; font-weight: 600;">账单</div>
            <div style="width:24px;"></div>
        </div>
        <div style="padding:16px;">
            <!-- 账单筛选 -->
            <div style="display:flex; gap:12px; margin-bottom:20px;">
                <div class="bill-filter-btn active" data-filter="all" onclick="filterBills('all')">全部</div>
                <div class="bill-filter-btn" data-filter="income" onclick="filterBills('income')">收入</div>
                <div class="bill-filter-btn" data-filter="expense" onclick="filterBills('expense')">支出</div>
            </div>
            <!-- 账单列表 -->
            <div id="bill-list" style="display:flex; flex-direction:column; gap:12px;">
                <!-- 动态渲染 -->
            </div>
            <!-- 空状态 -->
            <div id="bill-empty" style="display:none; text-align:center; padding:60px 20px; color:#999;">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="#ddd" stroke-width="1.5" style="margin-bottom:16px;">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                    <line x1="16" y1="13" x2="8" y2="13"></line>
                    <line x1="16" y1="17" x2="8" y2="17"></line>
                </svg>
                <div>暂无账单记录</div>
            </div>
        </div>
    </div>

    <!-- 亲属卡页面 -->
    <div class="sub-page-container service-sub-page" id="family-card-page" style="display:none;">
        <div class="wallet-nav" style="background:rgba(255,251,252,0.95); backdrop-filter:blur(10px);">
            <div class="back-btn" onclick="hideFamilyCardPage()">
                <svg width="24" height="24" fill="none" stroke="#333" stroke-width="2" viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div style="font-size: 17px; font-weight: 600;">亲属卡</div>
            <div style="width:24px;"></div>
        </div>
        <div style="padding:16px;">
            <!-- 说明 -->
            <div style="background:#FFF7FA; border-radius:12px; padding:16px; margin-bottom:20px; border:1px solid #f0e8ea;">
                <div style="font-size:14px; color:#333; line-height:1.6;">
                    💝 亲属卡可以让对方使用你的零钱消费，你可以随时查看消费记录或解绑。
                </div>
            </div>
            
            <!-- 我赠送的亲属卡 -->
            <div style="margin-bottom:24px;">
                <div style="font-size:15px; font-weight:600; color:#333; margin-bottom:12px;">我赠送的</div>
                <div id="family-card-given-list">
                    <!-- 动态渲染 -->
                </div>
                <div class="family-card-add" onclick="showGiveFamilyCardModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#999" stroke-width="2">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    <span>赠送亲属卡</span>
                </div>
            </div>
            
            <!-- 我收到的亲属卡 -->
            <div>
                <div style="font-size:15px; font-weight:600; color:#333; margin-bottom:12px;">我收到的</div>
                <div id="family-card-received-list">
                    <!-- 动态渲染 -->
                </div>
                <div id="family-card-received-empty" style="text-align:center; padding:30px; color:#999; font-size:14px;">
                    暂无收到的亲属卡
                </div>
            </div>
        </div>
    </div>

    <!-- 赠送亲属卡弹窗 -->
    <div class="confirm-modal-overlay" id="give-family-card-modal">
        <div class="confirm-box" style="width:320px; text-align:left;">
            <div style="font-size:18px; font-weight:600; margin-bottom:16px; color:#333; text-align:center;">赠送亲属卡</div>
            <div style="font-size:14px; color:#666; margin-bottom:16px;">选择要赠送的好友：</div>
            <div id="family-card-friend-list" style="max-height:200px; overflow-y:auto; margin-bottom:16px;">
                <!-- 动态渲染好友列表 -->
            </div>
            <div style="font-size:14px; color:#666; margin-bottom:8px;">每月额度（元）：</div>
            <input type="number" id="family-card-limit-input" placeholder="0 表示不限额" value="0" style="width:100%; padding:12px; border:1px solid #ddd; border-radius:8px; font-size:14px; box-sizing:border-box; margin-bottom:16px;">
            <div style="display:flex; gap:12px;">
                <button onclick="hideGiveFamilyCardModal()" style="flex:1; padding:12px; background:#f5f5f5; color:#666; border:none; border-radius:10px; font-weight:600;">取消</button>
                <button onclick="confirmGiveFamilyCard()" style="flex:1; padding:12px; background:var(--ins-pink); color:#fff; border:none; border-radius:10px; font-weight:600;">赠送</button>
            </div>
        </div>
    </div>

    <!-- 亲属卡消费记录弹窗 -->
    <div class="confirm-modal-overlay" id="family-card-records-modal">
        <div class="confirm-box" style="width:340px; max-height:80vh; text-align:left;">
            <div style="font-size:18px; font-weight:600; margin-bottom:16px; color:#333; text-align:center;">
                <span id="family-card-records-title">消费记录</span>
            </div>
            <div id="family-card-records-list" style="max-height:300px; overflow-y:auto; margin-bottom:16px;">
                <!-- 动态渲染 -->
            </div>
            <button onclick="hideFamilyCardRecordsModal()" style="width:100%; padding:12px; background:#f5f5f5; color:#666; border:none; border-radius:10px; font-weight:600;">关闭</button>
        </div>
    </div>

    <!-- 信息页面 (iOS iMessage 风格) -->
    <div class="message-page" id="message-page">
        <!-- 1. 列表页 -->
        <div id="message-list-page" class="message-page-content">
            <div class="message-header">
                <div class="message-header-top">
                    <span id="message-edit-btn" onclick="toggleMessageEditMode()">编辑</span>
                    <div onclick="openComposeMessage()">
                        <svg class="message-icon" viewBox="0 0 24 24"><path d="M12 20v-16M4 12h16"></path></svg>
                    </div>
                </div>
            </div>
            <div class="message-scroll-content">
                <div class="message-page-title-area">
                    <div class="message-page-title">信息</div>
                    <div class="message-search-bar">
                        <svg class="message-icon" style="width:16px;height:16px;margin-right:6px" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                        <span style="font-size:17px">搜索</span>
                    </div>
                </div>
                <div class="message-chat-list" id="message-chat-list-container"></div>
            </div>
            <!-- 编辑模式操作按钮 -->
            <div id="message-edit-actions" style="display:none; position:fixed; bottom:0; left:0; right:0; background:#fff; border-top:1px solid #e8e8e8; padding:12px 16px; z-index:1000;">
                <div style="display:flex; gap:12px;">
                    <button onclick="showMessageSwitchAccount()" style="flex:1; padding:12px; background:#f5f5f5; color:#333; border:none; border-radius:8px; font-size:16px; font-weight:500;">切换账号</button>
                    <button id="message-delete-btn" onclick="deleteSelectedMessageChats()" style="flex:1; padding:12px; background:#ff3b30; color:#fff; border:none; border-radius:8px; font-size:16px; font-weight:500; display:none;">删除</button>
                </div>
            </div>
            <!-- 底部 Home Indicator -->
            <div class="message-home-indicator" onclick="hideMessagePage()"></div>
        </div>

        <!-- 2. 详情页 (右侧滑入) -->
        <div id="message-detail-page" class="message-page-content message-nav">
            <div class="message-header">
                <div class="message-back-btn" onclick="goBackMessageList()">
                    <svg class="message-icon" viewBox="0 0 24 24" style="width:30px;height:30px;margin-left:-8px;"><path d="M15 18l-6-6 6-6"/></svg>
                    <span class="text-[17px] -ml-1">信息</span>
                </div>
                <div class="message-chat-header-content">
                    <div class="message-header-avatar-small"><img id="message-detail-avatar" src="" style="width:100%;height:100%;object-fit:cover;"></div>
                    <div class="message-header-name" id="message-detail-name">Name</div>
                </div>
                <div class="message-header-actions">
                    <svg class="message-icon" style="width:26px" viewBox="0 0 24 24"><polygon points="23 7 16 12 23 17 23 7"></polygon><rect x="1" y="5" width="15" height="14" rx="2" ry="2"></rect></svg>
                </div>
            </div>

            <div class="message-scroll-content" id="message-area-scroll">
                <div class="message-container" id="message-container"></div>
            </div>

            <!-- 详情页输入框 -->
            <div class="message-input-area">
                <div class="message-input-plus" onclick="acceptMessageReply()">
                     <svg class="message-icon" style="color:#999; background:#E5E5EA; border-radius:50%; padding:4px; width:28px; height:28px;" viewBox="4 4 16 16"><path d="M12 5v14M5 12h14"></path></svg>
                </div>
                <div class="message-input-wrapper">
                    <input id="message-msg-input" class="message-input-field" type="text" placeholder="iMessage" autocomplete="off" oninput="handleMessageInputChange(this)" onkeypress="if(event.key==='Enter') sendMessageDetail()">
                    <div class="message-input-action-btn">
                        <div id="message-icon-mic" class="message-mic-icon"><svg class="message-icon" style="width:20px;height:20px;" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div>
                        <div id="message-btn-send" class="message-send-btn" onclick="sendMessageDetail()"><svg class="message-icon" style="width:16px;height:16px;stroke-width:3" viewBox="0 0 24 24"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. 新建信息页 (底部弹出) -->
        <div id="message-compose-page" class="message-page-content message-modal">
            <div class="message-header">
                <div class="message-center-title">新信息</div>
                <div class="message-right-action" onclick="closeComposeMessage()">取消</div>
            </div>

            <div class="message-scroll-content" id="message-compose-scroll-area">
                <!-- 收件人栏 -->
                <div class="message-recipient-bar">
                    <span class="message-label-to">收件人:</span>
                    <input type="text" class="message-input-to" id="message-input-to" autocomplete="off">
                    <div class="message-btn-add-contact">
                        <svg class="message-icon" style="width:22px;height:22px;" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    </div>
                </div>

                <div class="message-container" id="message-compose-msg-container" style="padding-top: 10px;">
                    <!-- 这里开始是空的 -->
                </div>
            </div>

            <!-- 新建页输入框 -->
            <div class="message-input-area">
                <div class="message-input-plus">
                     <svg class="message-icon" style="color:#999; background:#E5E5EA; border-radius:50%; padding:4px; width:28px; height:28px;" viewBox="4 4 16 16"><path d="M12 5v14M5 12h14"></path></svg>
                </div>
                <div class="message-input-wrapper">
                    <input id="message-compose-input" class="message-input-field" type="text" placeholder="iMessage" autocomplete="off">
                    <div class="message-input-action-btn">
                        <div id="message-compose-icon-mic" class="message-mic-icon"><svg class="message-icon" style="width:20px;height:20px;" viewBox="0 0 24 24"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"></path><path d="M19 10v2a7 7 0 0 1-14 0v-2"></path><line x1="12" y1="19" x2="12" y2="23"></line><line x1="8" y1="23" x2="16" y2="23"></line></svg></div>
                        <div id="message-compose-btn-send" class="message-send-btn" onclick="sendNewMessageDetail()"><svg class="message-icon" style="width:16px;height:16px;stroke-width:3" viewBox="0 0 24 24"><line x1="12" y1="19" x2="12" y2="5"></line><polyline points="5 12 12 5 19 12"></polyline></svg></div>
                    </div>
                </div>
            </div>
            <!-- 底部 Home Indicator -->
            <div class="message-home-indicator" onclick="hideMessagePage()"></div>
        </div>
    </div>

    <!-- 日历设置页面 (Premium Pink Pro) -->
    <div class="wechat-page" id="calendar-page" style="z-index: 220;">
        <!-- 关闭按钮 -->
        <div class="calendar-close-btn" onclick="hideCalendarPage()">
            <svg class="svg-icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </div>

        <div class="calendar-wrapper">
            
            <!-- 头部导航 -->
            <div class="cal-header">
                <button class="nav-btn" id="cal-prevBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M15 18l-6-6 6-6"/></svg>
                </button>
                
                <!-- 可点击的日期标题 -->
                <button class="current-date-btn" id="cal-headerTitleBtn">
                    <span id="cal-monthYearText">Loading...</span>
                    <svg class="caret-icon" viewBox="0 0 24 24"><path d="M6 9l6 6 6-6"/></svg>
                </button>
                
                <button class="nav-btn" id="cal-nextBtn">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 18l6-6-6-6"/></svg>
                </button>
            </div>

            <!-- 主内容区：包含两个图层 (日历层/选择器层) -->
            <div class="cal-main-content">
                
                <!-- 层 2: 年月选择器 -->
                 <div class="view-layer selector-view" id="cal-selectorLayer">
                    <div class="month-selector" id="cal-monthGrid">
                        <!-- JS 生成月份 -->
                    </div>
                    <div class="year-selector" id="cal-yearList">
                        <!-- JS 生成年份 -->
                    </div>
                </div>

                <!-- 层 1: 具体日期 (默认显示) -->
                <div class="view-layer active" id="cal-calendarLayer">
                    <div class="weekdays">
                        <span>SU</span><span>MO</span><span>TU</span><span>WE</span><span>TH</span><span>FR</span><span>SA</span>
                    </div>
                    <div class="days" id="cal-daysContainer">
                        <!-- JS 生成日期 -->
                    </div>
                </div>

            </div>

            <!-- 底部固定区域 -->
            <div class="cal-bottom-ui">
                <div class="cal-divider"></div>
                <div class="time-picker">
                    <span class="time-label">TIME</span>
                    <div class="time-inputs">
                        <input type="number" id="cal-hourInput" class="time-input" min="0" max="23" value="09">
                        <span class="time-seperator">:</span>
                        <input type="number" id="cal-minuteInput" class="time-input" min="0" max="59" value="30">
                    </div>
                </div>
                <button class="cal-confirm-btn" id="cal-confirmBtn">CONFIRM SCHEDULE</button>
            </div>
        </div>
    </div>

    <!-- 等待接听页面 -->
    <div class="wechat-page" id="video-waiting-page" style="z-index: 240; display: none; background: #FFFFFF;">
        <div style="height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; border: 1px solid #E5E5E5;">
            <!-- AI头像：纯白圆形占位 -->
            <div id="video-waiting-avatar" style="width: 160px; height: 160px; border-radius: 50%; background-color: #FFFFFF; border: 2px solid #E5E5E5; margin-bottom: 24px; background-size: cover; background-position: center;"></div>

            <!-- 等待提示文字 -->
            <div id="video-waiting-name" style="font-size: 18px; color: #333333; margin-bottom: 8px;">正在呼叫...</div>
            <div style="font-size: 14px; color: #999999; margin-bottom: 40px;">请等待对方接听...</div>

            <!-- 呼吸灯加载动画 -->
            <div style="width: 24px; height: 24px; border-radius: 50%; background-color: #E5E5E5; animation: videoPulse 1.5s infinite ease-in-out;"></div>

            <!-- 取消按钮 -->
            <button onclick="cancelVideoCall()" style="width: 60px; height: 60px; border-radius: 50%; border: 1px solid #E5E5E5; background-color: #FFFFFF; margin-top: 60px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s;">
                <svg viewBox="0 0 24 24" style="width: 24px; height: 24px; fill: #666666;">
                    <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                </svg>
            </button>
        </div>
    </div>

    <!-- 视频通话页面 -->
    <div class="wechat-page" id="video-call-page" style="z-index: 250; display: none; background: #FFFFFF;">
        <div style="height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: relative;">
            <!-- 视频容器 - 纯白背景，灰色细描边 -->
            <div style="flex: 1; position: relative; background-color: #FFFFFF; border: 1px solid #E5E5E5;">
                <!-- 自己的小窗视频 - 纯白背景，灰色描边 -->
                <div id="video-self-window" style="position: absolute; top: 20px; right: 20px; width: 120px; height: 160px; border-radius: 16px; background-color: #FFFFFF; border: 1px solid #E5E5E5; z-index: 5; transition: opacity 0.3s ease;"></div>

                <!-- 顶部信息栏 - 轻量化设计 -->
                <div style="position: absolute; top: 0; left: 0; width: 100%; padding: 30px 20px 20px; display: flex; align-items: center; gap: 12px; z-index: 10;">
                    <!-- 头像 - 纯白背景，灰色描边 -->
                    <div id="video-call-avatar" style="width: 48px; height: 48px; border-radius: 24px; background-color: #FFFFFF; border: 1px solid #E5E5E5; background-size: cover; background-position: center;"></div>
                    <div style="flex: 1;">
                        <div id="video-call-username" style="color: #333333; font-size: 17px; font-weight: 500; margin-bottom: 3px;">角色名</div>
                        <div id="video-call-status" style="color: #999999; font-size: 13px; display: flex; align-items: center; gap: 5px;">
                            <span style="width: 6px; height: 6px; border-radius: 50%; background-color: #999999; animation: blink 1.5s infinite;"></span>
                            视频通话中
                        </div>
                    </div>
                </div>

                <!-- 消息显示区域 - 上移5px + 灰色描边气泡 -->
                <div id="video-message-area" style="position: absolute; bottom: 140px; left: 0; width: 100%; padding: 0 20px; display: flex; flex-direction: column; gap: 8px; z-index: 8; max-height: 320px; overflow-y: auto;">
                    <!-- 消息会动态添加到这里 -->
                </div>

                <!-- 输入框区域 - 纯白+灰色描边 -->
                <div style="position: absolute; bottom: 20px; left: 0; width: 100%; padding: 0 15px; display: flex; align-items: center; gap: 10px; z-index: 10;">
                    <input type="text" id="video-msg-input" placeholder="输入文字消息..." style="flex: 1; height: 42px; padding: 0 16px; border-radius: 21px; border: 1px solid #E5E5E5; background-color: #FFFFFF; font-size: 14px; color: #333; outline: none; transition: border-color 0.2s ease;">
                    <button onclick="sendVideoMessage()" style="width: 42px; height: 42px; border-radius: 50%; border: 1px solid #E5E5E5; background-color: #FFFFFF; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease;">
                        <svg viewBox="0 0 24 24" style="width: 16px; height: 16px; fill: #666666;">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>

                <!-- 底部功能按钮栏 - 纯白+灰色描边 -->
                <div style="position: absolute; bottom: 80px; left: 0; width: 100%; display: flex; justify-content: center; gap: 60px; z-index: 10;">
                    <button id="video-camera-btn" onclick="toggleCamera()" style="width: 52px; height: 52px; border-radius: 26px; display: flex; align-items: center; justify-content: center; border: 1px solid #E5E5E5; background-color: #FFFFFF; cursor: pointer; transition: all 0.2s ease;">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #666666;">
                            <path d="M12 1c-5.5 0-10 4.5-10 10 0 2.3.8 4.4 2.2 6.1l-2 2c-.4.4-.4 1 0 1.4.2.2.4.3.7.3s.5-.1.7-.3l2-2c1.7 1.4 3.8 2.2 6.1 2.2 5.5 0 10-4.5 10-10S17.5 1 12 1zm0 18c-4.4 0-8-3.6-8-8s3.6-8 8-8 8 3.6 8 8-3.6 8-8 8z"/>
                            <path d="M12 8c-2.2 0-4 1.8-4 4s1.8 4 4 4 4-1.8 4-4-1.8-4-4-4zm-2 4c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2z"/>
                        </svg>
                    </button>
                    <button onclick="hangupVideoCall()" style="width: 52px; height: 52px; border-radius: 26px; display: flex; align-items: center; justify-content: center; border: 1px solid #E5E5E5; background-color: #FFFFFF; cursor: pointer; transition: all 0.2s ease;">
                        <svg viewBox="0 0 24 24" style="width: 20px; height: 20px; fill: #666666;">
                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 视频通话记录列表页面 -->
    <div class="wechat-page" id="video-records-page" style="z-index: 260; display: none; background: #FFFFFF;">
        <div class="wechat-header" style="background: #fff; border-bottom: 1px solid #f0f0f0;">
            <div class="back-btn" onclick="hideVideoRecordsPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">视频通话记录</div>
            <div style="width:40px;"></div>
        </div>
        
        <div class="wechat-content" id="video-records-content" style="display:block; padding:16px; overflow-y:auto;">
            <!-- 记录列表会动态生成 -->
        </div>
    </div>

    <!-- 视频通话详情页面 -->
    <div class="wechat-page" id="video-record-detail-page" style="z-index: 270; display: none; background: #FFFFFF;">
        <div class="wechat-header" style="background: #fff; border-bottom: 1px solid #f0f0f0;">
            <div class="back-btn" onclick="hideVideoRecordDetailPage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title" id="video-record-detail-title">通话详情</div>
            <div style="width:40px;"></div>
        </div>
        
        <div class="wechat-content" id="video-record-detail-content" style="display:flex; flex-direction:column; padding:16px; overflow-y:auto; gap:8px;">
            <!-- 通话详情会动态生成 -->
        </div>
    </div>

    <!-- 线下模式聊天页面 -->
    <div class="chat-window" id="offline-chat-window" style="display:none; z-index:280; background:#fff;">
        <div class="chat-header" style="background:#fff; border-bottom:1px solid #f0f0f0;">
            <div class="chat-back" onclick="hideOfflineMode()" style="color:#666;">
                <svg class="svg-icon" viewBox="0 0 24 24" style="stroke:#666;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="chat-title" id="offline-chat-title" style="margin-right:0; text-align:center; color:#333; font-weight:400; font-size:16px;">线下模式</div>
            <div style="width:40px;"></div>
        </div>
        
        <div class="chat-body" id="offline-chat-body" style="background:#fff;">
            <!-- 线下模式消息列表 -->
        </div>
        
        <div class="chat-footer" id="offline-chat-footer" style="background:#fff; border-top:1px solid #f0f0f0; padding:12px 16px;">
            <div style="display:flex; gap:10px; align-items:flex-end;">
                <textarea id="offline-chat-input-box" class="chat-input" placeholder="输入消息..." rows="1" onkeydown="handleOfflineChatInputKey(event)" oninput="handleOfflineChatInputChange(this)" style="flex:1; max-height:100px; padding:10px 14px; border:1px solid #e8e8e8; border-radius:20px; resize:none; outline:none; font-size:14px; color:#333; background:#fafafa; font-family:-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;" onfocus="this.style.borderColor='#ffb3d1'; this.style.background='#fff'" onblur="this.style.borderColor='#e8e8e8'; this.style.background='#fafafa'"></textarea>
                <button onclick="rerollOfflineMessage()" style="width:40px; height:40px; border-radius:50%; border:1px solid #e8e8e8; background:#fff; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; transition:all 0.2s;" title="重新生成" onmouseover="this.style.background='#fafafa'; this.style.borderColor='#ffb3d1'" onmouseout="this.style.background='#fff'; this.style.borderColor='#e8e8e8'">
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; stroke:#ffb3d1; fill:none; stroke-width:2;">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                </button>
                <button id="offline-btn-send" onclick="sendOfflineMessage()" style="width:40px; height:40px; border-radius:50%; background:#ffb3d1; border:none; display:flex; align-items:center; justify-content:center; cursor:pointer; flex-shrink:0; opacity:0.4; transition:all 0.2s;" onmouseover="this.style.opacity='1'; this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                    <svg viewBox="0 0 24 24" style="width:18px; height:18px; stroke:#fff; fill:none; stroke-width:2;">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2" style="fill:#fff; stroke:none;"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- 衣柜页面 -->
    <div class="wechat-page" id="wardrobe-page" style="z-index: 230; background: #fdfdfd;">
        <div class="wechat-header" style="background: #fff; border-bottom: 1px solid #f0f0f0;">
            <div class="back-btn" onclick="hideWardrobePage()" style="margin:0; background:none; width:40px; justify-content:flex-start; padding-left:0; color:var(--ins-text);">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="wechat-title">衣柜</div>
            <div class="wechat-add" onclick="openWardrobeGenerateModal()" style="width:auto; text-align:right; font-size:13px; color:#6a4c77; padding:6px 16px; background:#f8f0fb; border-radius:20px; font-weight:500;">生成图片</div>
        </div>
        <div class="wechat-content" style="padding:0; height:calc(100% - 88px); background:#fefefe; position:relative;">
            <!-- 中间人物展示区 -->
            <div class="wardrobe-character-area" style="position:absolute; top:60px; left:0; right:0; bottom:200px; display:flex; justify-content:center; align-items:center; background:#fefefe; z-index:10;">
                <div class="wardrobe-character" style="width:320px; height:100%; display:flex; justify-content:center; align-items:center; position:relative;">
                    <img src="images/character.png" alt="人物形象" id="wardrobe-char-base" style="max-width:95%; max-height:90%; object-fit:contain;">
                </div>
            </div>

            <!-- 底部服装衣柜栏 -->
            <div class="wardrobe-area" style="position:fixed; bottom:0; left:0; right:0; height:200px; background:#fff; border-top:1px solid #eee; z-index:100; display:flex; flex-direction:column; box-shadow:0 -4px 20px rgba(0,0,0,0.03);">
                <!-- 分类切换Tab -->
                <div class="wardrobe-tabs" style="height:45px; display:flex; align-items:center; padding:0 10px; border-bottom:1px solid #f9f9f9;">
                    <div class="wardrobe-tab-item active" onclick="switchWardrobeTab('top', this)" style="flex:1; text-align:center; font-size:14px; color:#333; height:100%; line-height:45px; cursor:pointer; position:relative; font-weight:bold;">
                        上衣
                        <span style="position:absolute; bottom:0; left:50%; transform:translateX(-50%); width:20px; height:3px; background:#d4a5ff; border-radius:3px;"></span>
                    </div>
                    <div class="wardrobe-tab-item" onclick="switchWardrobeTab('bottom', this)" style="flex:1; text-align:center; font-size:14px; color:#999; height:100%; line-height:45px; cursor:pointer; position:relative; transition:color 0.3s;">下衣</div>
                    <div class="wardrobe-tab-item" onclick="switchWardrobeTab('shoes', this)" style="flex:1; text-align:center; font-size:14px; color:#999; height:100%; line-height:45px; cursor:pointer; position:relative; transition:color 0.3s;">鞋子</div>
                    <div class="wardrobe-tab-item" onclick="switchWardrobeTab('access', this)" style="flex:1; text-align:center; font-size:14px; color:#999; height:100%; line-height:45px; cursor:pointer; position:relative; transition:color 0.3s;">配饰</div>
                </div>

                <!-- 内容容器 -->
                <div class="wardrobe-content-container" style="flex:1; overflow-y:hidden; position:relative; padding:10px 0;">
                    <!-- 上衣列表 -->
                    <div class="wardrobe-list active" id="wardrobe-list-top" style="display:flex; height:100%; overflow-x:auto; white-space:nowrap; padding:0 15px; align-items:center; -webkit-overflow-scrolling:touch;">
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/clothes1.png" alt="T恤" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">白色T恤</div>
                        </div>
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/clothes2.png" alt="毛衣" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">粉色毛衣</div>
                        </div>
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/clothes3.png" alt="连衣裙" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">碎花裙</div>
                        </div>
                    </div>

                    <!-- 下衣列表 -->
                    <div class="wardrobe-list" id="wardrobe-list-bottom" style="display:none; height:100%; overflow-x:auto; white-space:nowrap; padding:0 15px; align-items:center; -webkit-overflow-scrolling:touch;">
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/bottom1.png" alt="短裙" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">百褶裙</div>
                        </div>
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/bottom2.png" alt="牛仔裤" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">牛仔裤</div>
                        </div>
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/bottom3.png" alt="短裤" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">休闲短裤</div>
                        </div>
                    </div>

                    <!-- 鞋子列表 -->
                    <div class="wardrobe-list" id="wardrobe-list-shoes" style="display:none; height:100%; overflow-x:auto; white-space:nowrap; padding:0 15px; align-items:center; -webkit-overflow-scrolling:touch;">
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/shoes1.png" alt="运动鞋" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">小白鞋</div>
                        </div>
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/shoes2.png" alt="靴子" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">马丁靴</div>
                        </div>
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/shoes3.png" alt="高跟鞋" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">玛丽珍鞋</div>
                        </div>
                    </div>

                    <!-- 配饰列表 -->
                    <div class="wardrobe-list" id="wardrobe-list-access" style="display:none; height:100%; overflow-x:auto; white-space:nowrap; padding:0 15px; align-items:center; -webkit-overflow-scrolling:touch;">
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/acc1.png" alt="发卡" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">星星发卡</div>
                        </div>
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/acc2.png" alt="包包" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">斜挎包</div>
                        </div>
                        <div class="wardrobe-clothes-item" style="display:inline-block; flex-shrink:0; width:90px; height:110px; border:1px solid #f0f0f0; border-radius:12px; margin-right:12px; background:#fff; cursor:pointer; text-align:center; padding:6px; transition:all 0.2s;">
                            <img src="images/acc3.png" alt="项链" style="width:100%; height:75px; object-fit:contain; margin-bottom:5px;">
                            <div class="wardrobe-clothes-name" style="font-size:11px; color:#888; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">珍珠项链</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 衣柜生成图片模态框 -->
    <div class="modal-overlay" id="wardrobe-generate-modal" style="display:none;">
        <div class="modal-box" style="max-width: 380px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3 style="font-size: 18px; font-weight: 600; color: #333;">生成图片</h3>
                <div onclick="closeWardrobeGenerateModal()" style="font-size: 24px; color: #999; cursor: pointer; line-height: 1;">×</div>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="generate-type-btn active" id="wardrobe-btn-character" onclick="selectWardrobeGenerateType('character', this)" style="flex: 1; padding: 12px; border: 2px solid var(--ins-pink); border-radius: 8px; background: #fff0f5; cursor: pointer; font-size: 14px; color: var(--ins-pink);">人物形象</button>
                <button class="generate-type-btn" id="wardrobe-btn-clothes" onclick="selectWardrobeGenerateType('clothes', this)" style="flex: 1; padding: 12px; border: 2px solid #eee; border-radius: 8px; background: #fff; cursor: pointer; font-size: 14px; color: #666;">衣服</button>
            </div>
            <!-- 性别选择（仅人物形象显示） -->
            <div id="wardrobe-gender-select" style="margin-bottom: 15px;">
                <label style="font-size: 13px; color: #666; display: block; margin-bottom: 8px;">性别</label>
                <div style="display: flex; gap: 10px;">
                    <button class="wardrobe-gender-btn active" id="wardrobe-gender-female" onclick="selectWardrobeGender('female', this)" style="flex: 1; padding: 10px; border: 2px solid #ff69b4; border-radius: 8px; background: #fff0f5; cursor: pointer; font-size: 13px; color: #ff69b4; font-weight: 500;">女生</button>
                    <button class="wardrobe-gender-btn" id="wardrobe-gender-male" onclick="selectWardrobeGender('male', this)" style="flex: 1; padding: 10px; border: 2px solid #eee; border-radius: 8px; background: #fff; cursor: pointer; font-size: 13px; color: #666; font-weight: 500;">男生</button>
                </div>
            </div>
            <div style="margin-bottom: 15px;">
                <label style="font-size: 13px; color: #666; display: block; margin-bottom: 8px;">输入生成要求</label>
                <textarea id="wardrobe-generate-prompt" placeholder="例如：短发，穿着白色连衣裙，微笑..." style="width: 100%; padding: 12px; border: 1px solid #eee; background: #fafafa; border-radius: 8px; font-size: 14px; outline: none; resize: vertical; min-height: 80px; font-family: inherit; box-sizing: border-box;"></textarea>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 25px;">
                <button onclick="closeWardrobeGenerateModal()" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: #f5f5f5; color: #666; font-size: 14px; font-weight: 500; cursor: pointer;">取消</button>
                <button class="generate-confirm-btn" onclick="generateWardrobeImage()" style="flex: 1; padding: 12px; border: none; border-radius: 8px; background: #333; color: #fff; font-size: 14px; font-weight: 500; cursor: pointer;">生成</button>
            </div>
            <div id="wardrobe-generate-loading" style="display: none; text-align: center; padding: 20px; color: #666; font-size: 14px;">
                正在生成图片，请稍候...
            </div>
        </div>
    </div>
            </div>
        </div>
    </div>

    <!-- 电话页面 (iPhone 风格) -->
    <div class="phone-page" id="phone-page" style="display:none;">
        <!-- 顶部导航栏 -->
        <div class="phone-header">
            <div class="phone-back-btn" onclick="hidePhonePage()">
                <svg class="svg-icon" viewBox="0 0 24 24" style="width:28px; height:28px;"><polyline points="15 18 9 12 15 6"></polyline></svg>
            </div>
            <div class="phone-title">电话</div>
            <div style="width:40px;"></div>
        </div>

        <!-- 内容区域 -->
        <div class="phone-content" id="phone-content">
            <!-- 标签栏 -->
            <div class="phone-tab-bar">
                <div class="phone-tab-item active" onclick="switchPhoneTab('recents')" data-tab="recents">
                    <svg class="phone-tab-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    <span>最近通话</span>
                </div>
                <div class="phone-tab-item" onclick="switchPhoneTab('contacts')" data-tab="contacts">
                    <svg class="phone-tab-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                    <span>联系人</span>
                </div>
                <div class="phone-tab-item" onclick="switchPhoneTab('keypad')" data-tab="keypad">
                    <svg class="phone-tab-icon" viewBox="0 0 24 24"><rect x="2" y="2" width="20" height="20" rx="2" ry="2"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="7" x2="22" y2="7"></line><line x1="2" y1="17" x2="22" y2="17"></line></svg>
                    <span>拨号键盘</span>
                </div>
                <div class="phone-tab-item" onclick="switchPhoneTab('voicemail')" data-tab="voicemail">
                    <svg class="phone-tab-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    <span>语音信箱</span>
                </div>
            </div>

            <!-- 最近通话标签页 -->
            <div class="phone-tab-content active" id="phone-tab-recents">
                <div class="phone-list" id="phone-recents-list">
                    <div class="phone-empty-state">
                        <svg class="phone-empty-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                        <div>无最近通话</div>
                    </div>
                </div>
            </div>

            <!-- 联系人标签页 -->
            <div class="phone-tab-content" id="phone-tab-contacts">
                <div class="phone-list" id="phone-contacts-list">
                    <div class="phone-empty-state">
                        <svg class="phone-empty-icon" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                        <div>无联系人</div>
                    </div>
                </div>
            </div>

            <!-- 拨号键盘标签页 -->
            <div class="phone-tab-content" id="phone-tab-keypad">
                <div class="phone-keypad-container">
                    <!-- 显示号码区域 -->
                    <div class="phone-number-display" id="phone-number-display">输入号码</div>
                    
                    <!-- 拨号键盘 -->
                    <div class="phone-keypad">
                        <div class="phone-keypad-row">
                            <div class="phone-key" onclick="phoneKeypadInput('1')">
                                <div class="phone-key-number">1</div>
                            </div>
                            <div class="phone-key" onclick="phoneKeypadInput('2')">
                                <div class="phone-key-number">2</div>
                                <div class="phone-key-letters">ABC</div>
                            </div>
                            <div class="phone-key" onclick="phoneKeypadInput('3')">
                                <div class="phone-key-number">3</div>
                                <div class="phone-key-letters">DEF</div>
                            </div>
                        </div>
                        <div class="phone-keypad-row">
                            <div class="phone-key" onclick="phoneKeypadInput('4')">
                                <div class="phone-key-number">4</div>
                                <div class="phone-key-letters">GHI</div>
                            </div>
                            <div class="phone-key" onclick="phoneKeypadInput('5')">
                                <div class="phone-key-number">5</div>
                                <div class="phone-key-letters">JKL</div>
                            </div>
                            <div class="phone-key" onclick="phoneKeypadInput('6')">
                                <div class="phone-key-number">6</div>
                                <div class="phone-key-letters">MNO</div>
                            </div>
                        </div>
                        <div class="phone-keypad-row">
                            <div class="phone-key" onclick="phoneKeypadInput('7')">
                                <div class="phone-key-number">7</div>
                                <div class="phone-key-letters">PQRS</div>
                            </div>
                            <div class="phone-key" onclick="phoneKeypadInput('8')">
                                <div class="phone-key-number">8</div>
                                <div class="phone-key-letters">TUV</div>
                            </div>
                            <div class="phone-key" onclick="phoneKeypadInput('9')">
                                <div class="phone-key-number">9</div>
                                <div class="phone-key-letters">WXYZ</div>
                            </div>
                        </div>
                        <div class="phone-keypad-row">
                            <div class="phone-key" onclick="phoneKeypadInput('*')">
                                <div class="phone-key-number">*</div>
                            </div>
                            <div class="phone-key" onclick="phoneKeypadInput('0')">
                                <div class="phone-key-number">0</div>
                                <div class="phone-key-letters">+</div>
                            </div>
                            <div class="phone-key" onclick="phoneKeypadInput('#')">
                                <div class="phone-key-number">#</div>
                            </div>
                        </div>
                    </div>

                    <!-- 底部操作按钮 -->
                    <div class="phone-keypad-actions">
                        <div class="phone-call-btn" id="phone-call-btn" onclick="phoneMakeCall()">
                            <svg class="phone-call-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                        </div>
                        <div class="phone-delete-btn" id="phone-delete-btn" onclick="phoneKeypadDelete()" style="display:none;">
                            <svg class="phone-delete-icon" viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 语音信箱标签页 -->
            <div class="phone-tab-content" id="phone-tab-voicemail">
                <div class="phone-empty-state">
                    <svg class="phone-empty-icon" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
                    <div>无语音留言</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 网易云音乐页面 -->
    <div class="music-app-page" id="musicAppPage">
        <div class="wyy-app-wrapper">
            <!-- 主页面 -->
            <div class="wyy-page wyy-main-page active" id="wyyMainPage">
                <!-- 顶部返回按钮 -->
                <button class="wyy-main-back-btn" onclick="closeMusicApp()" style="position: fixed; top: 20px; left: 20px; z-index: 200; font-size: 18px; background: rgba(0,0,0,0.1); border: none; width: 40px; height: 40px; border-radius: 50%; color: #333; cursor: pointer; display: flex; align-items: center; justify-content: center;">
                    <i class="fa fa-chevron-left"></i>
                </button>
                <!-- 顶部个人信息 -->
                <div class="wyy-user-header">
                    <div class="wyy-avatar-wrapper">
                        <div class="wyy-avatar" id="wyyAvatarDisplay"></div>
                    </div>
                    <div class="wyy-nickname">他的命就这样落到了我的怀里 <span class="wyy-vip-tag">VIP叁</span></div>
                    <div class="wyy-user-stats">
                        <div class="wyy-stat-item" data-type="follow">
                            <div class="wyy-stat-value">29</div>
                            <div class="wyy-stat-label">关注</div>
                        </div>
                        <div class="wyy-stat-item" data-type="fans">
                            <div class="wyy-stat-value">9</div>
                            <div class="wyy-stat-label">粉丝</div>
                        </div>
                        <div class="wyy-stat-item" data-type="level">
                            <div class="wyy-stat-value">Lv.7</div>
                            <div class="wyy-stat-label">等级</div>
                        </div>
                        <div class="wyy-stat-item" data-type="time">
                            <div class="wyy-stat-value">904h</div>
                            <div class="wyy-stat-label">时长</div>
                        </div>
                    </div>
                    <div class="wyy-func-tab">
                        <div class="wyy-func-item">最近</div>
                        <div class="wyy-func-item">本地</div>
                        <div class="wyy-func-item">网盘</div>
                        <div class="wyy-func-item active" id="wyyDressUpBtn">装扮</div>
                    </div>
                    <div class="wyy-playlist-placeholder">
                        <div class="wyy-placeholder-card" id="wyyCard1"></div>
                        <div class="wyy-placeholder-card" id="wyyCard2"></div>
                        <div class="wyy-placeholder-card" id="wyyCard3"></div>
                        <div class="wyy-placeholder-card" id="wyyCard4"></div>
                    </div>
                </div>

                <!-- 音乐板块 -->
                <div class="wyy-music-section">
                    <div class="wyy-section-header">
                        <div class="wyy-section-title">音乐</div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <button class="wyy-control-btn" id="wyyManagePlaylistsBtn" title="歌单管理" style="font-size: 14px; padding: 4px 8px;">
                                <i class="fa fa-cog"></i>
                            </button>
                            <div class="wyy-music-tab-group">
                                <div class="wyy-music-tab">近期</div>
                                <div class="wyy-music-tab active">创建</div>
                                <div class="wyy-music-tab">收藏</div>
                            </div>
                        </div>
                    </div>
                    <div class="wyy-playlist-card wyy-new-playlist-card" id="wyyNewPlaylistBtn" style="cursor: pointer; border: 2px dashed #ddd; background: #fafafa;">
                        <div class="wyy-playlist-cover" style="background: #f0f0f0; display: flex; align-items: center; justify-content: center; font-size: 24px; color: #999;">+</div>
                        <div class="wyy-playlist-info">
                            <div class="wyy-playlist-name">新建歌单</div>
                            <div class="wyy-playlist-desc">创建你的专属歌单</div>
                        </div>
                    </div>
                    <div id="wyyPlaylistsList">
                        <!-- 歌单列表将在这里动态生成 -->
                    </div>
                </div>

                <!-- 底部播放栏 -->
                <div class="wyy-play-bar" id="wyyPlayBar">
                    <div class="wyy-record-container" id="wyyCurrentRecordContainer">
                        <div class="wyy-record-cover" id="wyyRecordCover"></div>
                    </div>
                    <div class="wyy-play-info">
                        <div class="wyy-song-name" id="wyyCurrentSongName">怎么唱情歌</div>
                        <div class="wyy-singer-name" id="wyyCurrentSingerName">刘惜君</div>
                    </div>
                    <div class="wyy-play-controls">
                        <button class="wyy-control-btn wyy-play-btn" id="wyyPlayBtn"><i class="fa fa-play"></i></button>
                        <button class="wyy-control-btn" id="wyyPlaylistBtn"><i class="fa fa-bars"></i></button>
                    </div>
                </div>
            </div>

            <!-- 播放详情页面 -->
            <div class="wyy-page wyy-player-page" id="wyyPlayerPage">
                <div class="wyy-player-header">
                    <button class="wyy-back-btn" id="wyyBackBtn"><i class="fa fa-chevron-down"></i></button>
                    <button class="wyy-together-listen-btn" id="wyyTogetherListenBtn" title="一起听">
                        <i class="fa fa-users"></i>
                    </button>
                    <div class="wyy-song-info-large">
                        <div class="wyy-song-name-large" id="wyyPlayerSongName">怎么唱情歌</div>
                        <div class="wyy-singer-name-large" id="wyyPlayerSingerName">刘惜君</div>
                    </div>
                    <div class="wyy-album-art-container" id="wyyAlbumArtContainer">
                        <div class="wyy-album-art-large" id="wyyAlbumArtLarge"></div>
                        <div class="wyy-lyrics-container" id="wyyLyricsContainer">
                            <div id="wyyLyricsContent">暂无歌词</div>
                        </div>
                    </div>
                    <div class="wyy-progress-container">
                        <div class="wyy-progress-bar" id="wyyProgressBar">
                            <div class="wyy-progress" id="wyyProgress"></div>
                        </div>
                        <div class="wyy-time-info">
                            <span id="wyyCurrentTime">00:00</span>
                            <span class="wyy-quality-tag">极高音质</span>
                            <span id="wyyTotalTime">04:59</span>
                        </div>
                    </div>
                    <div class="wyy-player-controls">
                        <button class="wyy-control-btn-large" id="wyyLoopModeBtn" title="循环模式">
                            <i class="fa fa-list" id="wyyLoopIcon"></i>
                        </button>
                        <button class="wyy-control-btn-large" id="wyyPrevBtn"><i class="fa fa-backward"></i></button>
                        <button class="wyy-control-btn-large wyy-play-btn-large" id="wyyPlayerPlayBtn"><i class="fa fa-play"></i></button>
                        <button class="wyy-control-btn-large" id="wyyNextBtn"><i class="fa fa-forward"></i></button>
                        <button class="wyy-control-btn-large" id="wyyPlayerPlaylistBtn" title="播放列表">
                            <i class="fa fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- 装扮模态框 -->
            <div class="wyy-modal-overlay" id="wyyDressUpModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">装扮设置</div>
                    
                    <div class="wyy-avatar-upload-section">
                        <div class="wyy-avatar-preview" id="wyyModalAvatarPreview"></div>
                        <button class="wyy-upload-btn" id="wyyUploadAvatarBtn">上传头像</button>
                        <input type="file" id="wyyAvatarFileInput" class="wyy-file-input" accept="image/*">
                    </div>
                    
                    <div class="wyy-info-edit-section">
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">关注数量</label>
                            <input type="text" class="wyy-edit-input" id="wyyFollowInput" placeholder="输入关注数量" value="29">
                        </div>
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">粉丝数量</label>
                            <input type="text" class="wyy-edit-input" id="wyyFansInput" placeholder="输入粉丝数量" value="9">
                        </div>
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">等级</label>
                            <input type="text" class="wyy-edit-input" id="wyyLevelInput" placeholder="输入等级" value="Lv.7">
                        </div>
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">时长</label>
                            <input type="text" class="wyy-edit-input" id="wyyTimeInput" placeholder="输入时长" value="904h">
                        </div>
                    </div>
                    
                    <div class="wyy-cards-edit-section">
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌单卡片图片</label>
                            <div class="wyy-cards-preview-container">
                                <div class="wyy-card-preview-item">
                                    <div class="wyy-card-preview" id="wyyModalCardPreview1"></div>
                                    <button class="wyy-upload-btn wyy-card-upload-btn" data-card="1">卡片1</button>
                                    <input type="file" class="wyy-file-input wyy-card-file-input" data-card="1" accept="image/*">
                                </div>
                                <div class="wyy-card-preview-item">
                                    <div class="wyy-card-preview" id="wyyModalCardPreview2"></div>
                                    <button class="wyy-upload-btn wyy-card-upload-btn" data-card="2">卡片2</button>
                                    <input type="file" class="wyy-file-input wyy-card-file-input" data-card="2" accept="image/*">
                                </div>
                                <div class="wyy-card-preview-item">
                                    <div class="wyy-card-preview" id="wyyModalCardPreview3"></div>
                                    <button class="wyy-upload-btn wyy-card-upload-btn" data-card="3">卡片3</button>
                                    <input type="file" class="wyy-file-input wyy-card-file-input" data-card="3" accept="image/*">
                                </div>
                                <div class="wyy-card-preview-item">
                                    <div class="wyy-card-preview" id="wyyModalCardPreview4"></div>
                                    <button class="wyy-upload-btn wyy-card-upload-btn" data-card="4">卡片4</button>
                                    <input type="file" class="wyy-file-input wyy-card-file-input" data-card="4" accept="image/*">
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyCancelBtn">取消</button>
                        <button class="wyy-save-btn" id="wyySaveBtn">保存</button>
                    </div>
                </div>
            </div>

            <!-- 歌曲列表模态框 -->
            <div class="wyy-modal-overlay" id="wyyPlaylistModal">
                <div class="wyy-playlist-modal-content">
                    <div class="wyy-modal-title">播放列表</div>
                    
                    <div class="wyy-songs-list" id="wyySongsList">
                        <div class="wyy-empty-playlist" id="wyyEmptyPlaylist">暂无歌曲，请添加歌曲</div>
                        <!-- 歌曲列表会动态添加到这里 -->
                    </div>
                    
                    <div class="wyy-add-song-form">
                        <!-- 歌曲封面上传 -->
                        <div class="wyy-cover-upload-section">
                            <div class="wyy-cover-preview" id="wyySongCoverPreview"></div>
                            <button class="wyy-upload-btn" id="wyyUploadCoverBtn">上传歌曲封面</button>
                            <input type="file" id="wyyCoverFileInput" class="wyy-file-input" accept="image/*">
                        </div>
                        
                        <!-- 歌曲名称和歌手 -->
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌曲名称</label>
                            <input type="text" class="wyy-edit-input" id="wyySongNameInput" placeholder="输入歌曲名称">
                        </div>
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌手名称</label>
                            <input type="text" class="wyy-edit-input" id="wyySingerNameInput" placeholder="输入歌手名称">
                        </div>
                        
                        <!-- 歌曲上传选项 -->
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌曲文件</label>
                            <div class="wyy-upload-options">
                                <button class="wyy-upload-option-btn" id="wyyUrlOptionBtn" data-type="url">URL链接</button>
                                <button class="wyy-upload-option-btn active" id="wyyFileOptionBtn" data-type="file">本地文件</button>
                            </div>
                            <div class="wyy-upload-section active" id="wyyFileUploadSection">
                                <input type="file" id="wyySongFileInput" class="wyy-file-input" accept=".mp3,.wav,.ogg,.m4a,.flac,.aac,audio/*">
                                <button class="wyy-upload-btn" style="width: 100%; margin-top: 5px;" id="wyyUploadSongFileBtn">选择歌曲文件</button>
                                <div class="wyy-edit-label" style="margin-top: 5px; color: #999; font-size: 10px;">支持MP3、WAV、OGG、M4A、FLAC、AAC等格式</div>
                            </div>
                            <div class="wyy-upload-section" id="wyyUrlUploadSection">
                                <input type="text" class="wyy-edit-input" id="wyySongUrlInput" placeholder="输入歌曲音频URL">
                            </div>
                        </div>
                        
                        <!-- 歌词上传选项 -->
                        <div class="wyy-edit-group">
                            <label class="wyy-edit-label">歌词文件 (可选)</label>
                            <div class="wyy-upload-options">
                                <button class="wyy-upload-option-btn" id="wyyLyricUrlOptionBtn" data-type="url">URL链接</button>
                                <button class="wyy-upload-option-btn active" id="wyyLyricFileOptionBtn" data-type="file">本地文件</button>
                            </div>
                            <div class="wyy-upload-section active" id="wyyLyricFileUploadSection">
                                <input type="file" id="wyyLyricFileInput" class="wyy-file-input" accept=".lrc,.txt">
                                <button class="wyy-upload-btn" style="width: 100%; margin-top: 5px;" id="wyyUploadLyricFileBtn">选择歌词文件</button>
                                <div class="wyy-edit-label" style="margin-top: 5px; color: #999; font-size: 10px;">支持LRC、TXT格式</div>
                            </div>
                            <div class="wyy-upload-section" id="wyyLyricUrlUploadSection">
                                <input type="text" class="wyy-edit-input" id="wyyLyricUrlInput" placeholder="输入歌词文件URL">
                            </div>
                        </div>
                        
                        <div class="wyy-form-buttons">
                            <button class="wyy-clear-all-btn" id="wyyClearAllBtn">清空列表</button>
                            <button class="wyy-add-song-btn" id="wyyAddSongBtn">添加歌曲</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 创建歌单模态框 -->
            <div class="wyy-modal-overlay" id="wyyCreatePlaylistModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">创建歌单</div>
                    
                    <div class="wyy-edit-group">
                        <label class="wyy-edit-label">歌单名称</label>
                        <input type="text" class="wyy-edit-input" id="wyyNewPlaylistName" placeholder="输入歌单名称">
                    </div>
                    
                    <div class="wyy-edit-group">
                        <label class="wyy-edit-label">歌单描述（可选）</label>
                        <textarea class="wyy-edit-input" id="wyyNewPlaylistDesc" placeholder="输入歌单描述" style="height: 80px; resize: vertical;"></textarea>
                    </div>
                    
                    <div class="wyy-avatar-upload-section">
                        <div class="wyy-avatar-preview" id="wyyNewPlaylistCoverPreview" style="width: 100px; height: 100px; border-radius: 8px;"></div>
                        <button class="wyy-upload-btn" id="wyyUploadPlaylistCoverBtn">上传封面</button>
                        <input type="file" id="wyyPlaylistCoverFileInput" class="wyy-file-input" accept="image/*">
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyCancelCreatePlaylistBtn">取消</button>
                        <button class="wyy-save-btn" id="wyySaveCreatePlaylistBtn">创建</button>
                    </div>
                </div>
            </div>

            <!-- 添加到歌单模态框 -->
            <div class="wyy-modal-overlay" id="wyyAddToPlaylistModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">添加到歌单</div>
                    
                    <div id="wyyPlaylistSelectorList" style="max-height: 300px; overflow-y: auto; margin-bottom: 20px;">
                        <!-- 歌单列表将在这里动态生成 -->
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyCancelAddToPlaylistBtn">取消</button>
                    </div>
                </div>
            </div>

            <!-- 歌单详情模态框 -->
            <div class="wyy-modal-overlay" id="wyyPlaylistDetailModal">
                <div class="wyy-playlist-modal-content">
                    <div class="wyy-modal-title" id="wyyPlaylistDetailTitle">歌单详情</div>
                    
                    <div class="wyy-songs-list" id="wyyPlaylistDetailSongsList" style="max-height: 400px; overflow-y: auto;">
                        <!-- 歌曲列表将在这里动态生成 -->
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyClosePlaylistDetailBtn">关闭</button>
                        <button class="wyy-save-btn" id="wyySwitchToPlaylistBtn">切换到该歌单</button>
                    </div>
                </div>
            </div>

            <!-- 一起听 - 选择角色模态框 -->
            <div class="wyy-modal-overlay" id="wyyTogetherListenModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">选择一起听的角色</div>
                    
                    <div id="wyyTogetherListenRoleList" style="max-height: 400px; overflow-y: auto; margin-bottom: 20px;">
                        <!-- 角色列表将在这里动态生成 -->
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyCancelTogetherListenBtn">取消</button>
                        <button class="wyy-save-btn" id="wyyStopTogetherListenBtn" style="display: none;">结束一起听</button>
                    </div>
                </div>
            </div>

            <!-- 歌单管理模态框 -->
            <div class="wyy-modal-overlay" id="wyyPlaylistManageModal">
                <div class="wyy-modal-content">
                    <div class="wyy-modal-title">歌单管理</div>
                    
                    <div class="wyy-modal-buttons" style="flex-direction: column; gap: 10px;">
                        <button class="wyy-upload-btn" id="wyyExportPlaylistBtn" style="width: 100%;">导出当前歌单</button>
                        <button class="wyy-upload-btn" id="wyyImportPlaylistBtn" style="width: 100%;">导入歌单</button>
                        <input type="file" id="wyyImportPlaylistFileInput" class="wyy-file-input" accept=".json" style="display: none;">
                    </div>
                    
                    <div class="wyy-modal-buttons">
                        <button class="wyy-cancel-btn" id="wyyClosePlaylistManageBtn">关闭</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 情侣空间页面 -->
    <div class="phone" id="couple-space-page" style="display:none;">
        <!-- 返回按钮 -->
        <div style="position: absolute; top: 20px; left: 20px; z-index: 100;">
            <button onclick="hideCoupleSpacePage()" style="background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">←</button>
        </div>
        
        <!-- 选择账号界面 -->
        <div id="couple-select-account" style="width: 100%; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #ffe4f2 0%, #fff0f5 100%);">
            <div style="font-size: 20px; color: #e06c9f; font-weight: bold; margin-bottom: 30px;">选择你的微信账号</div>
            <div id="couple-account-list" style="width: 80%; max-width: 400px; max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
                <!-- 账号列表动态生成 -->
            </div>
        </div>
        
        <!-- 选择好友界面 -->
        <div id="couple-select-friend" style="width: 100%; height: 100%; display: none; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #ffe4f2 0%, #fff0f5 100%);">
            <div style="position: absolute; top: 20px; left: 20px;">
                <button onclick="backToCoupleAccountSelect()" style="background: rgba(255, 255, 255, 0.9); border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 20px; cursor: pointer;">←</button>
            </div>
            <div style="font-size: 20px; color: #e06c9f; font-weight: bold; margin-bottom: 30px;">选择好友开启情侣空间</div>
            <div id="couple-friend-list" style="width: 80%; max-width: 400px; max-height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px;">
                <!-- 好友列表动态生成 -->
            </div>
        </div>
        
        <!-- 房间区域 - 占满整个页面 -->
        <div id="couple-room-area" style="width: 100%; height: 100%; position: relative; overflow: hidden; display: none; touch-action: none;">
            <!-- 墙面区域 -->
            <div id="couple-wall-area" style="position: absolute; top: 0; left: 0; width: 100%; height: 60%; background: #ffe4f2;"></div>
            
            <!-- 地板区域 -->
            <div id="couple-floor-area" style="position: absolute; bottom: 0; left: 0; width: 100%; height: 40%; background: repeating-linear-gradient(90deg, #d4b5a7 0px, #d4b5a7 30px, #c9a394 30px, #c9a394 60px);"></div>
            
            <!-- 宠物容器 -->
            <div id="pet-stage" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10;">
                <div id="pet-hint" style="text-align: center; color: #666; font-size: 14px; margin-bottom: 10px;">点击领养宠物</div>
                <div id="pet-container"></div>
            </div>
            
            <!-- 领养宠物按钮（初始显示） -->
            <div id="adopt-pet-btn" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 20;">
                <button onclick="showAdoptPetModal()" style="background: #ff9ed2; color: white; border: none; border-radius: 12px; padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 12px rgba(224, 108, 159, 0.4);">
                    领养宠物
                </button>
            </div>
        </div>
        
        <!-- 领养宠物选择模态框 -->
        <div id="adopt-pet-modal" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; justify-content: center; align-items: center;">
            <div style="background: white; border-radius: 20px; padding: 30px; width: 80%; max-width: 350px;">
                <div style="font-size: 20px; color: #e06c9f; font-weight: bold; text-align: center; margin-bottom: 20px;">选择你的宠物</div>
                <div style="display: flex; flex-direction: column; gap: 15px;">
                    <button onclick="adoptPet('cat')" style="background: #fff0f5; border: 2px solid #ff9ed2; border-radius: 12px; padding: 15px; font-size: 16px; cursor: pointer;">猫咪</button>
                    <button onclick="adoptPet('dog')" style="background: #fff0f5; border: 2px solid #ff9ed2; border-radius: 12px; padding: 15px; font-size: 16px; cursor: pointer;">狗狗</button>
                    <button onclick="adoptPet('seal')" style="background: #fff0f5; border: 2px solid #ff9ed2; border-radius: 12px; padding: 15px; font-size: 16px; cursor: pointer;">海豹</button>
                </div>
                <button onclick="closeAdoptPetModal()" style="background: #ccc; border: none; border-radius: 12px; padding: 10px; width: 100%; margin-top: 15px; cursor: pointer;">取消</button>
            </div>
        </div>
    </div>

    <!-- 小屋页面 -->
    <div class="custom-page" id="cabin-page" style="display:none;">
        <div class="custom-page-header">
            <div class="back-btn" onclick="hideCabinPage()">←</div>
            <div class="custom-page-title">小屋</div>
            <div class="coin-display-cabin">
                <svg class="cabin-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <text x="12" y="16" text-anchor="middle" font-size="10" fill="currentColor">¥</text>
                </svg>
                <span id="cabin-coin-count">200</span>
            </div>
        </div>

        <!-- 主容器 -->
        <div class="cabin-main-container">
            <!-- 扭蛋屏幕 -->
            <div id="cabin-gacha-screen" class="cabin-screen active">
                <!-- 机器标题 -->
                <div class="cabin-machine-title-bar">
                    <div class="cabin-machine-title" id="cabin-machine-title">家具扭蛋机</div>
                    <button class="cabin-switch-btn" onclick="switchCabinMachine()">切换</button>
                </div>

                <!-- 家具扭蛋机 -->
                <div id="cabin-furniture-gacha" class="cabin-gacha-machine">
                    <div class="cabin-machine-window">
                        <div class="cabin-loading-text" id="cabin-furniture-loading">
                            正在生成...<br>请稍候...
                        </div>
                        <div id="cabin-furniture-display">
                            <svg class="cabin-display-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="5" y="7" width="14" height="10" rx="2"/>
                                <path d="M12 7V4M8 4h8M12 17v3"/>
                            </svg>
                        </div>
                    </div>
                    <div class="cabin-knob-area">
                        <div class="cabin-info-text">
                            抽一次 
                            <svg class="cabin-icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <text x="12" y="16" text-anchor="middle" font-size="10" fill="currentColor">¥</text>
                            </svg>
                            10
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="cabin-gacha-knob" onclick="cabinDrawOnce()">抽</button>
                            <button class="cabin-gacha-knob cabin-ten-draw" onclick="cabinDrawTen()">十连抽</button>
                        </div>
                    </div>
                </div>

                <!-- 服装扭蛋机(默认隐藏) -->
                <div id="cabin-clothes-gacha" class="cabin-gacha-machine" style="display: none;">
                    <div class="cabin-machine-window">
                        <div class="cabin-loading-text" id="cabin-clothes-loading">
                            正在生成...<br>请稍候...
                        </div>
                        <div id="cabin-clothes-display">
                            <svg class="cabin-display-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/>
                                <path d="M8.5 3h7l2 4-2 2h-7L6.5 7l2-4z"/>
                            </svg>
                        </div>
                    </div>
                    <div class="cabin-knob-area">
                        <div class="cabin-info-text">
                            抽一次 
                            <svg class="cabin-icon-small" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <text x="12" y="16" text-anchor="middle" font-size="10" fill="currentColor">¥</text>
                            </svg>
                            10
                        </div>
                        <div style="display: flex; gap: 8px;">
                            <button class="cabin-gacha-knob" onclick="cabinDrawOnce()">抽</button>
                            <button class="cabin-gacha-knob cabin-ten-draw" onclick="cabinDrawTen()">十连抽</button>
                        </div>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="cabin-stats-box">
                    <div>收集进度: <span class="cabin-stats-highlight" id="cabin-collection-count">0/0</span></div>
                    <div style="margin-top: 5px;">最新获得: <span class="cabin-stats-highlight" id="cabin-last-item">暂无</span></div>
                </div>

                <!-- AI生成按钮 -->
                <button class="cabin-pixel-btn cabin-ai-btn" style="width: 90%; margin-top: 15px;" onclick="openCabinAIModal()">
                    <svg class="cabin-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                        <path d="M2 17l10 5 10-5"/>
                        <path d="M2 12l10 5 10-5"/>
                    </svg>
                    AI魔法工坊<br>
                    <span style="font-size: 7px;">消耗 10金币 生成10个独家家具</span>
                </button>

                <!-- 像素小人生成按钮 -->
                <button class="cabin-pixel-btn cabin-ai-btn" style="width: 90%; margin-top: 10px;" onclick="openCabinCharacterModal()">
                    <svg class="cabin-btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>
                    像素小人生成器<br>
                    <span style="font-size: 7px;">消耗 10金币 生成1个128x128像素小人</span>
                </button>
            </div>


            <!-- 房屋屏幕 -->
            <div id="cabin-house-screen" class="cabin-screen">
                <!-- 操作按钮 -->
                <div style="width: 100%; display: flex; justify-content: space-between; margin-bottom: 10px; flex-wrap: wrap; gap: 5px;">
                    <button class="cabin-pixel-btn" style="margin:0; padding: 8px; flex: 1;" onclick="switchCabinScreen('gacha')">
                        <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                        返回
                    </button>
                    <button class="cabin-pixel-btn" style="margin:0; padding: 8px; flex: 1;" onclick="takeCabinScreenshot()">
                        <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                            <circle cx="8.5" cy="8.5" r="1.5"/>
                            <path d="M21 15l-5-5L5 21"/>
                        </svg>
                        拍照
                    </button>
                    <button class="cabin-pixel-btn" style="margin:0; padding: 8px; flex: 1;" onclick="openCabinColorPicker('wall')" id="cabin-wall-color-btn">
                        <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2v20M2 12h20"/>
                        </svg>
                        墙面
                    </button>
                    <button class="cabin-pixel-btn" style="margin:0; padding: 8px; flex: 1;" onclick="openCabinColorPicker('floor')" id="cabin-floor-color-btn">
                        <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7"/>
                            <rect x="14" y="3" width="7" height="7"/>
                            <rect x="14" y="14" width="7" height="7"/>
                            <rect x="3" y="14" width="7" height="7"/>
                        </svg>
                        地板
                    </button>
                </div>

                <!-- 房间区域 -->
                <div class="cabin-room-container" id="cabin-room-area">
                    <div class="cabin-room-wall" id="cabin-wall-area"></div>
                    <div class="cabin-room-floor" id="cabin-floor-area"></div>
                    <div class="cabin-room-grid"></div>
                </div>

                <!-- 拖拽指示器 -->
                <div id="cabin-drag-indicator" style="position: fixed; width: 64px; height: 64px; border: 3px solid #ffb3c1; border-radius: 8px; background: rgba(255, 255, 255, 0.9); box-shadow: 0 4px 12px rgba(255, 179, 193, 0.3); z-index: 10000; display: none; pointer-events: none; transform: translate(-50%, -50%);"></div>

                <!-- 像素小人移动控制按钮 -->
                <div style="width: 100%; margin: 15px 0; display: flex; flex-direction: column; align-items: center; gap: 8px;">
                    <div style="font-size: 9px; color: #999999; font-weight: bold;">我的小人移动</div>
                    <div style="display: flex; gap: 5px;">
                        <button class="cabin-pixel-btn" style="padding: 5px 10px; font-size: 12px;" onclick="moveCabinUserCharacter('left')">
                            <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="15 18 9 12 15 6"/>
                            </svg>
                        </button>
                        <button class="cabin-pixel-btn" style="padding: 5px 10px; font-size: 12px;" onclick="moveCabinUserCharacter('up')">
                            <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="18 15 12 9 6 15"/>
                            </svg>
                        </button>
                        <button class="cabin-pixel-btn" style="padding: 5px 10px; font-size: 12px;" onclick="moveCabinUserCharacter('down')">
                            <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="6 9 12 15 18 9"/>
                            </svg>
                        </button>
                        <button class="cabin-pixel-btn" style="padding: 5px 10px; font-size: 12px;" onclick="moveCabinUserCharacter('right')">
                            <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 18 15 12 9 6"/>
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- 分类过滤器 -->
                <div class="cabin-type-filter" style="display: flex; gap: 5px; margin: 10px 0; justify-content: center; flex-wrap: wrap;">
                    <button class="cabin-filter-btn active" onclick="filterCabinInventory('all')">全部</button>
                    <button class="cabin-filter-btn" onclick="filterCabinInventory('furniture')">家具</button>
                    <button class="cabin-filter-btn" onclick="filterCabinInventory('decor')">摆件</button>
                    <button class="cabin-filter-btn" onclick="filterCabinInventory('wall')">墙饰</button>
                    <button class="cabin-filter-btn" onclick="filterCabinInventory('floor')">地饰</button>
                </div>

                <div style="width:100%; text-align:left; font-size: 9px; margin: 10px 0 5px 0; color: #999999;">
                    <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                        <path d="M16 11l5 5-5 5"/>
                    </svg>
                    背包 (点击选中，拖动放置):
                </div>

                <!-- 背包 -->
                <div id="cabin-inventory-container" class="cabin-inventory-bar" style="width: 100%; max-width: 100%; background: #ffffff; border: 3px solid #ffe4e9; padding: 8px; display: flex; gap: 8px; overflow-x: auto; overflow-y: hidden; min-height: 72px; max-height: 72px; flex-wrap: nowrap; align-items: center; border-radius: 6px;">
                    <!-- 背包内容将通过JS动态生成 -->
                </div>
            </div>

            <!-- 人物屏幕 -->
            <div id="cabin-character-screen" class="cabin-screen">
                <div class="cabin-page-title">人物管理</div>
                <div class="cabin-placeholder-content">
                    人物管理功能<br>敬请期待
                </div>
            </div>
        </div>

        <!-- 底部导航栏 -->
        <div class="cabin-bottom-nav">
            <div class="cabin-nav-item active" onclick="switchCabinScreen('gacha')">
                <svg class="cabin-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"/>
                    <circle cx="12" cy="12" r="3"/>
                </svg>
                <div class="cabin-nav-item-text">扭蛋</div>
            </div>
            <div class="cabin-nav-item" onclick="openCatalogModal()">
                <svg class="cabin-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                <div class="cabin-nav-item-text">图鉴</div>
            </div>
            <div class="cabin-nav-item" onclick="switchCabinScreen('house')">
                <svg class="cabin-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
                    <polyline points="9 22 9 12 15 12 15 22"/>
                </svg>
                <div class="cabin-nav-item-text">房屋</div>
            </div>
            <div class="cabin-nav-item" onclick="switchCabinScreen('character')">
                <svg class="cabin-nav-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/>
                    <circle cx="12" cy="7" r="4"/>
                </svg>
                <div class="cabin-nav-item-text">人物</div>
            </div>
        </div>
    </div>

    <!-- 图鉴弹窗 -->
    <div id="catalog-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: #fff; width: 85%; max-width: 350px; padding: 20px; border: 4px solid #ffe4e9; border-radius: 10px; text-align: center; max-height: 80vh; overflow-y: auto;">
            <div class="modal-title" style="font-size: 14px; color: #999999; margin-bottom: 15px; font-family: 'Press Start 2P', cursive;">
                <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"/>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"/>
                </svg>
                物品图鉴
            </div>
            
            <!-- 图鉴标签页 -->
            <div class="catalog-tabs" style="display: flex; gap: 5px; margin-bottom: 10px; justify-content: center;">
                <button class="catalog-tab active" onclick="switchCatalogTab('all')" style="padding: 5px 10px; font-size: 8px; border: 2px solid #ffe4e9; border-radius: 4px; background: #fff5f7; color: #999999; cursor: pointer; font-family: 'Press Start 2P', cursive;">全部</button>
                <button class="catalog-tab" onclick="switchCatalogTab('owned')" style="padding: 5px 10px; font-size: 8px; border: 2px solid #ffe4e9; border-radius: 4px; background: #ffffff; color: #999999; cursor: pointer; font-family: 'Press Start 2P', cursive;">已拥有</button>
                <button class="catalog-tab" onclick="switchCatalogTab('missing')" style="padding: 5px 10px; font-size: 8px; border: 2px solid #ffe4e9; border-radius: 4px; background: #ffffff; color: #999999; cursor: pointer; font-family: 'Press Start 2P', cursive;">未拥有</button>
            </div>
            
            <!-- 稀有度过滤器 -->
            <div class="rarity-filter" style="display: flex; gap: 5px; margin: 10px 0; justify-content: center; flex-wrap: wrap;">
                <button class="rarity-filter-btn all active" onclick="filterCatalogItems('all')" style="padding: 3px 6px; font-size: 7px; border: 2px solid #cccccc; border-radius: 4px; cursor: pointer; background: #f5f5f5; color: #999999; font-family: 'Press Start 2P', cursive;">全部</button>
                <button class="rarity-filter-btn r" onclick="filterCatalogItems('r')" style="padding: 3px 6px; font-size: 7px; border: 2px solid #b0b0b0; border-radius: 4px; cursor: pointer; background: #e0e0e0; color: #999999; font-family: 'Press Start 2P', cursive;">R</button>
                <button class="rarity-filter-btn sr" onclick="filterCatalogItems('sr')" style="padding: 3px 6px; font-size: 7px; border: 2px solid #ffb3c1; border-radius: 4px; cursor: pointer; background: #fff5f7; color: #999999; font-family: 'Press Start 2P', cursive;">SR</button>
                <button class="rarity-filter-btn ssr" onclick="filterCatalogItems('ssr')" style="padding: 3px 6px; font-size: 7px; border: 2px solid #ffd966; border-radius: 4px; cursor: pointer; background: #fff9e6; color: #999999; font-family: 'Press Start 2P', cursive;">SSR</button>
            </div>
            
            <div class="modal-info" id="catalog-info" style="font-size: 9px; color: #999999; margin: 8px 0;">
                总计: <span id="catalog-total">0</span> | 
                已收集: <span id="catalog-owned">0</span> | 
                收集率: <span id="catalog-rate">0%</span>
            </div>
            
            <div id="catalog-items" class="catalog-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 10px 0; max-height: 350px; overflow-y: auto; padding: 5px;">
                <!-- 图鉴内容动态生成 -->
            </div>
            
            <button class="cabin-pixel-btn" onclick="closeCatalogModal()" style="width: 100%; margin-top: 10px; background:#ffffff; border-color: #cccccc; color: #999999;">关闭</button>
        </div>
    </div>

    <!-- 颜色选择器弹窗 -->
    <div id="cabin-color-picker-modal" class="modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: #fff; width: 85%; max-width: 350px; padding: 20px; border: 4px solid #ffe4e9; border-radius: 10px; text-align: center; max-height: 80vh; overflow-y: auto;">
            <div class="modal-title" id="cabin-color-modal-title" style="font-size: 14px; color: #999999; margin-bottom: 15px; font-family: 'Press Start 2P', cursive;">
                <svg class="cabin-icon-inline" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"/>
                </svg>
                修改颜色
            </div>
            <div class="modal-info" style="font-size: 9px; color: #999999; margin: 8px 0;">选择你喜欢的颜色和样式</div>
            
            <!-- 样式选择 -->
            <div style="margin: 15px 0;">
                <div style="font-size: 10px; color: #999999; margin-bottom: 5px; text-align: left; font-weight: bold;">样式选择:</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 10px;">
                    <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <div style="width: 50px; height: 30px; border: 2px solid #ffe4e9; background-color: #fff5f7; margin-bottom: 5px; border-radius: 4px;"></div>
                        <input type="radio" name="cabin-style-option" value="solid" checked style="margin: 0;">
                        <span style="font-size: 8px; color: #999999;">纯色</span>
                    </label>
                    <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <div style="width: 50px; height: 30px; border: 2px solid #ffe4e9; background-color: #fff5f7; background-image: linear-gradient(90deg, rgba(255, 179, 193, 0.3) 1px, transparent 1px), linear-gradient(rgba(255, 179, 193, 0.3) 1px, transparent 1px); background-size: 16px 16px; margin-bottom: 5px; border-radius: 4px;"></div>
                        <input type="radio" name="cabin-style-option" value="pattern1" style="margin: 0;">
                        <span style="font-size: 8px; color: #999999;">方格线</span>
                    </label>
                    <label style="display: flex; flex-direction: column; align-items: center; cursor: pointer;">
                        <div style="width: 50px; height: 30px; border: 2px solid #ffe4e9; background-color: #fff5f7; background-image: linear-gradient(90deg, transparent 33%, rgba(255, 179, 193, 0.5) 33%, rgba(255, 179, 193, 0.5) 66%, transparent 66%), linear-gradient(transparent 33%, rgba(255, 179, 193, 0.5) 33%, rgba(255, 179, 193, 0.5) 66%, transparent 66%); background-size: 12px 12px; margin-bottom: 5px; border-radius: 4px;"></div>
                        <input type="radio" name="cabin-style-option" value="pattern2" style="margin: 0;">
                        <span style="font-size: 8px; color: #999999;">花纹2</span>
                    </label>
                </div>
            </div>
            
            <!-- 主体颜色 -->
            <div style="margin: 15px 0;">
                <div style="font-size: 10px; color: #999999; margin-bottom: 5px; text-align: left; font-weight: bold;">主体颜色:</div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="cabin-color-input" placeholder="#ffffff" style="flex: 1; padding: 10px; border: 2px solid #ffe4e9; font-family: inherit; font-size: 10px; border-radius: 4px;" />
                    <input type="color" id="cabin-color-picker" style="width: 50px; height: 40px; border: 2px solid #ffe4e9; border-radius: 4px; cursor: pointer;" />
                </div>
            </div>
            
            <!-- 花纹颜色 -->
            <div id="cabin-pattern-color-section" style="margin: 15px 0; display: none;">
                <div style="font-size: 10px; color: #999999; margin-bottom: 5px; text-align: left; font-weight: bold;">花纹颜色:</div>
                <div style="display: flex; gap: 5px;">
                    <input type="text" id="cabin-pattern-color-input" placeholder="#ffffff" style="flex: 1; padding: 10px; border: 2px solid #ffe4e9; font-family: inherit; font-size: 10px; border-radius: 4px;" />
                    <input type="color" id="cabin-pattern-color-picker" style="width: 50px; height: 40px; border: 2px solid #ffe4e9; border-radius: 4px; cursor: pointer;" />
                </div>
            </div>
            
            <div class="modal-buttons" style="display: flex; gap: 10px; justify-content: center; margin-top: 15px;">
                <button class="cabin-pixel-btn" onclick="resetCabinColor()" style="background:#ffffff; border-color: #cccccc; color: #999999;">重置颜色</button>
                <button class="cabin-pixel-btn" onclick="applyCabinColor()" style="background:#fff5f7; border-color: #ffb3c1; color: #999999;">应用颜色</button>
                <button class="cabin-pixel-btn" onclick="closeCabinColorPicker()" style="background:#ffffff; border-color: #cccccc; color: #999999;">关闭</button>
            </div>
        </div>
    </div>

    <!-- 引入外部 JavaScript 文件（放在 body 底部，确保 DOM 已加载） -->
    <script src="script.JS"></script>
    

</body>
</html>
