# 📦 数据导出/导入功能更新说明

## 🎉 更新内容

### 1. ✅ 修复数据漏导出问题

**之前漏掉的数据（已修复）：**
- ❌ 群聊数据（group_chats）
- ❌ 电话记录（phone_recents）
- ❌ 短信记录（sms_messages）
- ❌ 聊天总结（chat_summaries）
- ❌ 联机账号信息（online_server_url, online_token, online_user_data）

**现在全部导出！✅**

---

### 2. 🎯 新增导出选项

**点击"导出数据"时会弹出选择框：**

```
┌─────────────────────────────────┐
│    导出数据选项                  │
├─────────────────────────────────┤
│ ☑ 本地数据                      │
│   包括：角色、聊天记录、世界书、│
│   表情包、朋友圈、群聊、         │
│   电话/短信记录等               │
│                                 │
│ ☑ 联机账号数据                  │
│   包括：联机服务器地址、         │
│   登录Token、用户信息           │
│                                 │
│            [取消] [确定导出]     │
└─────────────────────────────────┘
```

**你可以选择：**
- ✅ **全部导出**（本地 + 联机）- 默认推荐
- ✅ **只导出本地数据**（不含联机账号）
- ✅ **只导出联机账号**（用于迁移账号）

---

### 3. 📊 导出文件命名

文件名会自动标识导出类型：

| 导出类型 | 文件名示例 |
|---------|-----------|
| 全部数据 | `wechat_backup_full_1707000000000.json` |
| 仅本地数据 | `wechat_backup_local_1707000000000.json` |
| 仅联机数据 | `wechat_backup_online_1707000000000.json` |

---

### 4. 📥 导入功能增强

**导入时会显示预览：**

```
即将导入以下数据：

📱 本地数据：
  - 角色: 5个
  - 群聊: 3个
  - 朋友圈: 20条
  - 以及世界书、表情包、电话/短信记录等

🌐 联机账号：username123

⚠️ 导入将覆盖现有数据！
建议先导出当前数据作为备份。

是否继续？
```

**智能识别数据类型：**
- ✅ 自动检测导出文件包含的数据类型
- ✅ 仅导入文件中包含的数据
- ✅ 兼容旧版本导出的文件

---

### 5. 🗑️ 清空数据功能更新

**现在清空所有数据时，也会清空：**
- ✅ 群聊数据
- ✅ 电话记录
- ✅ 短信记录
- ✅ 聊天总结
- ✅ 联机账号信息

---

## 🔍 新增导出的数据明细

### 📱 本地数据

| 数据类型 | 说明 | 表名 |
|---------|------|------|
| 基础数据 | API配置、设置等 | dexiData |
| 世界书 | 所有世界书条目 | lorebooks |
| 角色 | 所有角色（Char/NPC/User） | characters |
| 表情包 | 表情包分类和贴纸 | sticker_categories |
| 朋友圈 | 朋友圈动态 | moments |
| 好友申请 | 好友申请记录 | friend_requests |
| **群聊** | **群聊信息和消息记录** | **group_chats** ✨ |
| **电话记录** | **通话记录** | **phone_recents** ✨ |
| **短信记录** | **短信消息** | **sms_messages** ✨ |
| **聊天总结** | **AI总结的聊天摘要** | **chat_summaries** ✨ |

### 🌐 联机账号数据

| 数据类型 | localStorage Key | 说明 |
|---------|-----------------|------|
| 服务器地址 | online_server_url | WebSocket服务器地址 |
| 登录Token | online_token | JWT认证令牌（30天有效） |
| 用户信息 | online_user_data | 用户名、ID等 |

---

## 📖 使用场景

### 场景1：完整备份（推荐）

**适用于：**
- 定期备份
- 换设备前备份
- 重装系统前备份

**操作：**
1. 点击"导出数据"
2. 勾选"本地数据" + "联机账号数据"
3. 点击"确定导出"
4. 保存文件到安全位置

**恢复：**
1. 点击"导入数据"
2. 选择备份文件
3. 确认导入

**结果：** ✅ 所有数据、聊天记录、联机账号全部恢复

---

### 场景2：仅备份本地数据

**适用于：**
- 只想备份聊天记录和角色
- 不想导出联机账号（安全考虑）
- 分享角色和设定给朋友

**操作：**
1. 点击"导出数据"
2. 只勾选"本地数据"
3. 点击"确定导出"

**结果：** ✅ 导出所有本地数据，不包含联机账号信息

---

### 场景3：迁移联机账号

**适用于：**
- 在多个设备使用同一个联机账号
- 更换浏览器

**操作：**
1. 在旧设备/浏览器：
   - 导出数据，只勾选"联机账号数据"
2. 在新设备/浏览器：
   - 导入该文件

**结果：** ✅ 联机账号登录状态迁移成功

---

## 🆚 版本对比

### 旧版本（v1.0）

```json
{
  "version": "1.0",
  "exportTime": "...",
  "data": {
    "dexiData": [...],
    "lorebooks": [...],
    "characters": [...],
    "sticker_categories": [...],
    "moments": [...],
    "friend_requests": [...]
    // ❌ 缺少：群聊、电话、短信、聊天总结
  },
  "localStorage": {
    "user_id": "...",
    "current_my_char_id": "..."
    // ❌ 缺少：联机账号信息
  }
}
```

### 新版本（v2.0）

```json
{
  "version": "2.0",
  "exportTime": "...",
  "dataTypes": {
    "local": true,
    "online": true
  },
  "data": {
    "dexiData": [...],
    "lorebooks": [...],
    "characters": [...],
    "sticker_categories": [...],
    "moments": [...],
    "friend_requests": [...],
    "group_chats": [...],        // ✅ 新增
    "phone_recents": [...],      // ✅ 新增
    "sms_messages": [...],       // ✅ 新增
    "chat_summaries": [...]      // ✅ 新增
  },
  "localStorage": {
    "user_id": "...",
    "current_my_char_id": "...",
    "notification_enabled": "...",
    "debug_mode": "...",
    "keepalive_enabled": "..."
  },
  "onlineData": {                // ✅ 新增
    "server_url": "...",
    "token": "...",
    "user_data": "..."
  }
}
```

---

## ⚠️ 重要提示

### 1. 联机账号数据的安全性

**联机账号数据包含：**
- 🔐 JWT Token（相当于登录凭证）
- 📍 服务器地址

**建议：**
- ✅ 如果是个人备份：导出时包含联机数据
- ⚠️ 如果要分享给他人：不要勾选联机数据
- 🔒 备份文件要妥善保管，不要上传到公开位置

### 2. Token 有效期

- JWT Token 有效期为 **30天**
- 超过30天后需要重新登录
- 导入旧备份时，如果Token过期，需要重新登录联机账号

### 3. 兼容性

- ✅ 新版本可以导入旧版本（v1.0）的备份文件
- ✅ 缺少的数据字段会被自动跳过
- ✅ 向下兼容

---

## 🎯 快速上手

### 完整备份三步走

```bash
1️⃣ 设置 → 导出数据
2️⃣ 勾选"本地数据" + "联机账号数据"
3️⃣ 点击"确定导出"
```

### 恢复数据三步走

```bash
1️⃣ 设置 → 导入数据
2️⃣ 选择备份文件
3️⃣ 确认导入 → 等待页面刷新
```

---

## 📞 问题排查

### Q: 导入后群聊消息没有了？

**A:** 检查备份文件版本：
- 旧版本（v1.0）不包含群聊数据
- 需要使用新版本重新导出

### Q: 导入后联机账号还要重新登录？

**A:** 可能的原因：
1. 导出时没有勾选"联机账号数据"
2. Token已过期（超过30天）
3. 服务器地址变更

**解决方法：** 重新登录联机账号

### Q: 导出文件太大？

**A:** 正常现象，文件大小取决于：
- 角色数量
- 聊天记录条数
- 朋友圈数量
- 群聊消息数量

**优化方法：**
- 可以只导出"联机账号数据"（文件很小）
- 定期清理不需要的聊天记录

---

## ✅ 总结

**现在的导出/导入功能：**

✅ **数据完整性** - 不会漏掉任何数据
✅ **灵活性** - 可以选择导出的内容
✅ **安全性** - 可以选择不导出敏感信息
✅ **易用性** - 一键导出/导入
✅ **兼容性** - 兼容旧版本备份

**你再也不用担心数据丢失了！** 🎉

